
% Default to the notebook output style

    


% Inherit from the specified cell style.




    
\documentclass[11pt]{article}

    
    
    \usepackage[T1]{fontenc}
    % Nicer default font (+ math font) than Computer Modern for most use cases
    \usepackage{mathpazo}

    % Basic figure setup, for now with no caption control since it's done
    % automatically by Pandoc (which extracts ![](path) syntax from Markdown).
    \usepackage{graphicx}
    % We will generate all images so they have a width \maxwidth. This means
    % that they will get their normal width if they fit onto the page, but
    % are scaled down if they would overflow the margins.
    \makeatletter
    \def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth
    \else\Gin@nat@width\fi}
    \makeatother
    \let\Oldincludegraphics\includegraphics
    % Set max figure width to be 80% of text width, for now hardcoded.
    \renewcommand{\includegraphics}[1]{\Oldincludegraphics[width=.8\maxwidth]{#1}}
    % Ensure that by default, figures have no caption (until we provide a
    % proper Figure object with a Caption API and a way to capture that
    % in the conversion process - todo).
    \usepackage{caption}
    \DeclareCaptionLabelFormat{nolabel}{}
    \captionsetup{labelformat=nolabel}

    \usepackage{adjustbox} % Used to constrain images to a maximum size 
    \usepackage{xcolor} % Allow colors to be defined
    \usepackage{enumerate} % Needed for markdown enumerations to work
    \usepackage{geometry} % Used to adjust the document margins
    \usepackage{amsmath} % Equations
    \usepackage{amssymb} % Equations
    \usepackage{textcomp} % defines textquotesingle
    % Hack from http://tex.stackexchange.com/a/47451/13684:
    \AtBeginDocument{%
        \def\PYZsq{\textquotesingle}% Upright quotes in Pygmentized code
    }
    \usepackage{upquote} % Upright quotes for verbatim code
    \usepackage{eurosym} % defines \euro
    \usepackage[mathletters]{ucs} % Extended unicode (utf-8) support
    \usepackage[utf8x]{inputenc} % Allow utf-8 characters in the tex document
    \usepackage{fancyvrb} % verbatim replacement that allows latex
    \usepackage{grffile} % extends the file name processing of package graphics 
                         % to support a larger range 
    % The hyperref package gives us a pdf with properly built
    % internal navigation ('pdf bookmarks' for the table of contents,
    % internal cross-reference links, web links for URLs, etc.)
    \usepackage{hyperref}
    \usepackage{longtable} % longtable support required by pandoc >1.10
    \usepackage{booktabs}  % table support for pandoc > 1.12.2
    \usepackage[inline]{enumitem} % IRkernel/repr support (it uses the enumerate* environment)
    \usepackage[normalem]{ulem} % ulem is needed to support strikethroughs (\sout)
                                % normalem makes italics be italics, not underlines
    

    
    
    % Colors for the hyperref package
    \definecolor{urlcolor}{rgb}{0,.145,.698}
    \definecolor{linkcolor}{rgb}{.71,0.21,0.01}
    \definecolor{citecolor}{rgb}{.12,.54,.11}

    % ANSI colors
    \definecolor{ansi-black}{HTML}{3E424D}
    \definecolor{ansi-black-intense}{HTML}{282C36}
    \definecolor{ansi-red}{HTML}{E75C58}
    \definecolor{ansi-red-intense}{HTML}{B22B31}
    \definecolor{ansi-green}{HTML}{00A250}
    \definecolor{ansi-green-intense}{HTML}{007427}
    \definecolor{ansi-yellow}{HTML}{DDB62B}
    \definecolor{ansi-yellow-intense}{HTML}{B27D12}
    \definecolor{ansi-blue}{HTML}{208FFB}
    \definecolor{ansi-blue-intense}{HTML}{0065CA}
    \definecolor{ansi-magenta}{HTML}{D160C4}
    \definecolor{ansi-magenta-intense}{HTML}{A03196}
    \definecolor{ansi-cyan}{HTML}{60C6C8}
    \definecolor{ansi-cyan-intense}{HTML}{258F8F}
    \definecolor{ansi-white}{HTML}{C5C1B4}
    \definecolor{ansi-white-intense}{HTML}{A1A6B2}

    % commands and environments needed by pandoc snippets
    % extracted from the output of `pandoc -s`
    \providecommand{\tightlist}{%
      \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
    \DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
    % Add ',fontsize=\small' for more characters per line
    \newenvironment{Shaded}{}{}
    \newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{\textbf{{#1}}}}
    \newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.56,0.13,0.00}{{#1}}}
    \newcommand{\DecValTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
    \newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
    \newcommand{\FloatTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
    \newcommand{\CharTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\StringTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\CommentTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textit{{#1}}}}
    \newcommand{\OtherTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{{#1}}}
    \newcommand{\AlertTok}[1]{\textcolor[rgb]{1.00,0.00,0.00}{\textbf{{#1}}}}
    \newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.02,0.16,0.49}{{#1}}}
    \newcommand{\RegionMarkerTok}[1]{{#1}}
    \newcommand{\ErrorTok}[1]{\textcolor[rgb]{1.00,0.00,0.00}{\textbf{{#1}}}}
    \newcommand{\NormalTok}[1]{{#1}}
    
    % Additional commands for more recent versions of Pandoc
    \newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.53,0.00,0.00}{{#1}}}
    \newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.73,0.40,0.53}{{#1}}}
    \newcommand{\ImportTok}[1]{{#1}}
    \newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.73,0.13,0.13}{\textit{{#1}}}}
    \newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    \newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    \newcommand{\VariableTok}[1]{\textcolor[rgb]{0.10,0.09,0.49}{{#1}}}
    \newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{\textbf{{#1}}}}
    \newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.40,0.40,0.40}{{#1}}}
    \newcommand{\BuiltInTok}[1]{{#1}}
    \newcommand{\ExtensionTok}[1]{{#1}}
    \newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.74,0.48,0.00}{{#1}}}
    \newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.49,0.56,0.16}{{#1}}}
    \newcommand{\InformationTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    \newcommand{\WarningTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    
    
    % Define a nice break command that doesn't care if a line doesn't already
    % exist.
    \def\br{\hspace*{\fill} \\* }
    % Math Jax compatability definitions
    \def\gt{>}
    \def\lt{<}
    % Document parameters
    \title{CV\_project}
    
    
    

    % Pygments definitions
    
\makeatletter
\def\PY@reset{\let\PY@it=\relax \let\PY@bf=\relax%
    \let\PY@ul=\relax \let\PY@tc=\relax%
    \let\PY@bc=\relax \let\PY@ff=\relax}
\def\PY@tok#1{\csname PY@tok@#1\endcsname}
\def\PY@toks#1+{\ifx\relax#1\empty\else%
    \PY@tok{#1}\expandafter\PY@toks\fi}
\def\PY@do#1{\PY@bc{\PY@tc{\PY@ul{%
    \PY@it{\PY@bf{\PY@ff{#1}}}}}}}
\def\PY#1#2{\PY@reset\PY@toks#1+\relax+\PY@do{#2}}

\expandafter\def\csname PY@tok@gd\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.63,0.00,0.00}{##1}}}
\expandafter\def\csname PY@tok@gu\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.50,0.00,0.50}{##1}}}
\expandafter\def\csname PY@tok@gt\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.27,0.87}{##1}}}
\expandafter\def\csname PY@tok@gs\endcsname{\let\PY@bf=\textbf}
\expandafter\def\csname PY@tok@gr\endcsname{\def\PY@tc##1{\textcolor[rgb]{1.00,0.00,0.00}{##1}}}
\expandafter\def\csname PY@tok@cm\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@vg\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@vi\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@vm\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@mh\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@cs\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@ge\endcsname{\let\PY@it=\textit}
\expandafter\def\csname PY@tok@vc\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@il\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@go\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.53,0.53,0.53}{##1}}}
\expandafter\def\csname PY@tok@cp\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.74,0.48,0.00}{##1}}}
\expandafter\def\csname PY@tok@gi\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.63,0.00}{##1}}}
\expandafter\def\csname PY@tok@gh\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,0.50}{##1}}}
\expandafter\def\csname PY@tok@ni\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.60,0.60,0.60}{##1}}}
\expandafter\def\csname PY@tok@nl\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.63,0.63,0.00}{##1}}}
\expandafter\def\csname PY@tok@nn\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@no\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.53,0.00,0.00}{##1}}}
\expandafter\def\csname PY@tok@na\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.49,0.56,0.16}{##1}}}
\expandafter\def\csname PY@tok@nb\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@nc\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@nd\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.67,0.13,1.00}{##1}}}
\expandafter\def\csname PY@tok@ne\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.82,0.25,0.23}{##1}}}
\expandafter\def\csname PY@tok@nf\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@si\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.73,0.40,0.53}{##1}}}
\expandafter\def\csname PY@tok@s2\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@nt\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@nv\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@s1\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@dl\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@ch\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@m\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@gp\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,0.50}{##1}}}
\expandafter\def\csname PY@tok@sh\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@ow\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.67,0.13,1.00}{##1}}}
\expandafter\def\csname PY@tok@sx\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@bp\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@c1\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@fm\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@o\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@kc\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@c\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@mf\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@err\endcsname{\def\PY@bc##1{\setlength{\fboxsep}{0pt}\fcolorbox[rgb]{1.00,0.00,0.00}{1,1,1}{\strut ##1}}}
\expandafter\def\csname PY@tok@mb\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@ss\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@sr\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.40,0.53}{##1}}}
\expandafter\def\csname PY@tok@mo\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@kd\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@mi\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@kn\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@cpf\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@kr\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@s\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@kp\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@w\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.73,0.73}{##1}}}
\expandafter\def\csname PY@tok@kt\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.69,0.00,0.25}{##1}}}
\expandafter\def\csname PY@tok@sc\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sb\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sa\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@k\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@se\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.73,0.40,0.13}{##1}}}
\expandafter\def\csname PY@tok@sd\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}

\def\PYZbs{\char`\\}
\def\PYZus{\char`\_}
\def\PYZob{\char`\{}
\def\PYZcb{\char`\}}
\def\PYZca{\char`\^}
\def\PYZam{\char`\&}
\def\PYZlt{\char`\<}
\def\PYZgt{\char`\>}
\def\PYZsh{\char`\#}
\def\PYZpc{\char`\%}
\def\PYZdl{\char`\$}
\def\PYZhy{\char`\-}
\def\PYZsq{\char`\'}
\def\PYZdq{\char`\"}
\def\PYZti{\char`\~}
% for compatibility with earlier versions
\def\PYZat{@}
\def\PYZlb{[}
\def\PYZrb{]}
\makeatother


    % Exact colors from NB
    \definecolor{incolor}{rgb}{0.0, 0.0, 0.5}
    \definecolor{outcolor}{rgb}{0.545, 0.0, 0.0}



    
    % Prevent overflowing lines due to hard-to-break entities
    \sloppy 
    % Setup hyperref package
    \hypersetup{
      breaklinks=true,  % so long urls are correctly broken across lines
      colorlinks=true,
      urlcolor=urlcolor,
      linkcolor=linkcolor,
      citecolor=citecolor,
      }
    % Slightly bigger margins than the latex defaults
    
    \geometry{verbose,tmargin=1in,bmargin=1in,lmargin=1in,rmargin=1in}
    
    

    \begin{document}
    
    
    \maketitle
    
    

    
    \section{Artificial Intelligence}\label{artificial-intelligence}

\subsection{Computer Vision}\label{computer-vision}

\subsection{Project: Facial Keypoint
Detection}\label{project-facial-keypoint-detection}

\begin{center}\rule{0.5\linewidth}{\linethickness}\end{center}

In this project, combined knowledge of computer vision techniques and
deep learning to build and end-to-end facial keypoint recognition
system! Facial keypoints include points around the eyes, nose, and mouth
on any face and are used in many applications, from facial tracking to
emotion recognition.

There are three main parts to this project:

\textbf{Part 1} : Investigating OpenCV, pre-processing, and face
detection

\textbf{Part 2} : Training a Convolutional Neural Network (CNN) to
detect facial keypoints

\textbf{Part 3} : Putting parts 1 and 2 together to identify facial
keypoints on any image!

    \subsubsection{Steps to Complete the
Project}\label{steps-to-complete-the-project}

In this project, explore a few of the many computer vision algorithms
built into the OpenCV library. This expansive computer vision library is
now \href{https://en.wikipedia.org/wiki/OpenCV\#History}{almost 20 years
old} and still growing!

The project itself is broken down into three large parts, then even
further into separate steps.

\textbf{Part 1} : Investigating OpenCV, pre-processing, and face
detection

\begin{itemize}
\tightlist
\item
  Section \ref{step0}: Detect Faces Using a Haar Cascade Classifier
\item
  Section \ref{step1}: Add Eye Detection
\item
  Section \ref{step2}: De-noise an Image for Better Face Detection
\item
  Section \ref{step3}: Blur an Image and Perform Edge Detection
\item
  Section \ref{step4}: Automatically Hide the Identity of an Individual
\end{itemize}

\textbf{Part 2} : Training a Convolutional Neural Network (CNN) to
detect facial keypoints

\begin{itemize}
\tightlist
\item
  Section \ref{step5}: Create a CNN to Recognize Facial Keypoints
\item
  Section \ref{step6}: Compile and Train the Model
\item
  Section \ref{step7}: Visualize the Loss and Answer Questions
\end{itemize}

\textbf{Part 3} : Putting parts 1 and 2 together to identify facial
keypoints on any image!

\begin{itemize}
\tightlist
\item
  Section \ref{step7}: Build a Robust Facial Keypoints Detector
  (Complete the CV Pipeline)
\end{itemize}

    \begin{center}\rule{0.5\linewidth}{\linethickness}\end{center}

 \#\# Step 0: Detect Faces Using a Haar Cascade Classifier

Have you ever wondered how Facebook automatically tags images with your
friends' faces?\\
Or How high-end cameras automatically find and focus on a certain
person's face?

Applications like these depend heavily on the machine learning task
known as \emph{face detection} - which is the task of automatically
finding faces in images containing people.

At its root face detection is a classification problem - that is a
problem of distinguishing between distinct classes of things. With face
detection these distinct classes are 1) images of human faces 2)
everything else.

We use OpenCV's implementation of
\href{http://docs.opencv.org/trunk/d7/d8b/tutorial_py_face_detection.html}{Haar
feature-based cascade classifiers} to detect human faces in images.

OpenCV provides many pre-trained face detectors, stored as XML files on
\href{https://github.com/opencv/opencv/tree/master/data/haarcascades}{github}.

We have downloaded one of these detectors and stored it in the
\texttt{detector\_architectures} directory.

    \subsubsection{Import Resources}\label{import-resources}

In the next python cell, we load in the required libraries for this
section of the project.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}2}]:} \PY{c+c1}{\PYZsh{} Import required libraries for this section}
        
        \PY{o}{\PYZpc{}}\PY{k}{matplotlib} inline
        
        \PY{k+kn}{import} \PY{n+nn}{numpy} \PY{k}{as} \PY{n+nn}{np}
        \PY{k+kn}{import} \PY{n+nn}{matplotlib}\PY{n+nn}{.}\PY{n+nn}{pyplot} \PY{k}{as} \PY{n+nn}{plt}
        \PY{k+kn}{import} \PY{n+nn}{math}
        \PY{k+kn}{import} \PY{n+nn}{cv2}                     \PY{c+c1}{\PYZsh{} OpenCV library for computer vision}
        \PY{k+kn}{from} \PY{n+nn}{PIL} \PY{k}{import} \PY{n}{Image}
        \PY{k+kn}{import} \PY{n+nn}{time} 
\end{Verbatim}


    Next, we load in and display a test image for performing face detection.

\emph{Note}: by default OpenCV assumes the ordering of our image's color
channels are Blue, then Green, then Red.

This is slightly out of order with most image types we'll use in these
experiments, whose color channels are ordered Red, then Green, then
Blue.

In order to switch the Blue and Red channels of our test image around we
will use OpenCV's \texttt{cvtColor} function, which you can read more
about by
\href{http://docs.opencv.org/3.2.0/df/d9d/tutorial_py_colorspaces.html}{checking
out some of its documentation located here}.

This is a general utility function that can do other transformations too
like converting a color image to grayscale, and transforming a standard
color image to HSV color space.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}2}]:} \PY{c+c1}{\PYZsh{} Load in color image for face detection}
        \PY{n}{image} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{imread}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{images/test\PYZus{}image\PYZus{}1.jpg}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        
        \PY{c+c1}{\PYZsh{} Convert the image to RGB colorspace}
        \PY{n}{image} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{cvtColor}\PY{p}{(}\PY{n}{image}\PY{p}{,} \PY{n}{cv2}\PY{o}{.}\PY{n}{COLOR\PYZus{}BGR2RGB}\PY{p}{)}
        
        \PY{c+c1}{\PYZsh{} Plot our image using subplots to specify a size and title}
        \PY{n}{fig} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{figsize} \PY{o}{=} \PY{p}{(}\PY{l+m+mi}{8}\PY{p}{,}\PY{l+m+mi}{8}\PY{p}{)}\PY{p}{)}
        \PY{n}{ax1} \PY{o}{=} \PY{n}{fig}\PY{o}{.}\PY{n}{add\PYZus{}subplot}\PY{p}{(}\PY{l+m+mi}{111}\PY{p}{)}
        \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}xticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{)}
        \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}yticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{)}
        
        \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Original Image}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        \PY{n}{ax1}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{image}\PY{p}{)}
\end{Verbatim}


\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}2}]:} <matplotlib.image.AxesImage at 0x1703dbd3080>
\end{Verbatim}
            
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_6_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    There are a lot of people - and faces - in this picture. 13 faces to be
exact! In the next code cell, we demonstrate how to use a Haar Cascade
classifier to detect all the faces in this test image.

This face detector uses information about patterns of intensity in an
image to reliably detect faces under varying light conditions. So, to
use this face detector, we'll first convert the image from color to
grayscale.

Then, we load in the fully trained architecture of the face detector
-\/- found in the file \emph{haarcascade\_frontalface\_default.xml} -
and use it on our image to find faces!

To learn more about the parameters of the detector see
\href{https://stackoverflow.com/questions/20801015/recommended-values-for-opencv-detectmultiscale-parameters}{this
post}.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}3}]:} \PY{c+c1}{\PYZsh{} Convert the RGB  image to grayscale}
        \PY{n}{gray} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{cvtColor}\PY{p}{(}\PY{n}{image}\PY{p}{,} \PY{n}{cv2}\PY{o}{.}\PY{n}{COLOR\PYZus{}RGB2GRAY}\PY{p}{)}
        
        \PY{c+c1}{\PYZsh{} Extract the pre\PYZhy{}trained face detector from an xml file}
        \PY{n}{face\PYZus{}cascade} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{CascadeClassifier}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{detector\PYZus{}architectures/haarcascade\PYZus{}frontalface\PYZus{}default.xml}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        
        \PY{c+c1}{\PYZsh{} Detect the faces in image}
        \PY{n}{faces} \PY{o}{=} \PY{n}{face\PYZus{}cascade}\PY{o}{.}\PY{n}{detectMultiScale}\PY{p}{(}\PY{n}{gray}\PY{p}{,} \PY{l+m+mi}{4}\PY{p}{,} \PY{l+m+mi}{6}\PY{p}{)}
        
        \PY{c+c1}{\PYZsh{} Print the number of faces detected in the image}
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Number of faces detected:}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{faces}\PY{p}{)}\PY{p}{)}
        
        \PY{c+c1}{\PYZsh{} Make a copy of the orginal image to draw face detections on}
        \PY{n}{image\PYZus{}with\PYZus{}detections} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{copy}\PY{p}{(}\PY{n}{image}\PY{p}{)}
        
        \PY{c+c1}{\PYZsh{} Get the bounding box for each detected face}
        \PY{k}{for} \PY{p}{(}\PY{n}{x}\PY{p}{,}\PY{n}{y}\PY{p}{,}\PY{n}{w}\PY{p}{,}\PY{n}{h}\PY{p}{)} \PY{o+ow}{in} \PY{n}{faces}\PY{p}{:}
            \PY{c+c1}{\PYZsh{} Add a red bounding box to the detections image}
            \PY{n}{cv2}\PY{o}{.}\PY{n}{rectangle}\PY{p}{(}\PY{n}{image\PYZus{}with\PYZus{}detections}\PY{p}{,} \PY{p}{(}\PY{n}{x}\PY{p}{,}\PY{n}{y}\PY{p}{)}\PY{p}{,} \PY{p}{(}\PY{n}{x}\PY{o}{+}\PY{n}{w}\PY{p}{,}\PY{n}{y}\PY{o}{+}\PY{n}{h}\PY{p}{)}\PY{p}{,} \PY{p}{(}\PY{l+m+mi}{255}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{)}\PY{p}{,} \PY{l+m+mi}{3}\PY{p}{)}
            
        
        \PY{c+c1}{\PYZsh{} Display the image with the detections}
        \PY{n}{fig} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{figsize} \PY{o}{=} \PY{p}{(}\PY{l+m+mi}{8}\PY{p}{,}\PY{l+m+mi}{8}\PY{p}{)}\PY{p}{)}
        \PY{n}{ax1} \PY{o}{=} \PY{n}{fig}\PY{o}{.}\PY{n}{add\PYZus{}subplot}\PY{p}{(}\PY{l+m+mi}{111}\PY{p}{)}
        \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}xticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{)}
        \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}yticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{)}
        
        \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Image with Face Detections}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        \PY{n}{ax1}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{image\PYZus{}with\PYZus{}detections}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
Number of faces detected: 13

    \end{Verbatim}

\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}3}]:} <matplotlib.image.AxesImage at 0x1703dc29d30>
\end{Verbatim}
            
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_8_2.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    In the above code, \texttt{faces} is a numpy array of detected faces,
where each row corresponds to a detected face.

Each detected face is a 1D array with four entries that specifies the
bounding box of the detected face.

The first two entries in the array (extracted in the above code as
\texttt{x} and \texttt{y}) specify the horizontal and vertical positions
of the top left corner of the bounding box.

The last two entries in the array (extracted here as \texttt{w} and
\texttt{h}) specify the width and height of the box.

    \begin{center}\rule{0.5\linewidth}{\linethickness}\end{center}

\subsection{Step 1: Add Eye Detections}\label{step-1-add-eye-detections}

There are other pre-trained detectors available that use a Haar Cascade
Classifier - including full human body detectors, license plate
detectors, and more.

\href{https://github.com/opencv/opencv/tree/master/data/haarcascades}{A
full list of the pre-trained architectures can be found here}.

    To test your eye detector, we'll first read in a new test image with
just a single face.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}4}]:} \PY{c+c1}{\PYZsh{} Load in color image for face detection}
        \PY{n}{image} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{imread}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{images/james.jpg}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        
        \PY{c+c1}{\PYZsh{} Convert the image to RGB colorspace}
        \PY{n}{image} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{cvtColor}\PY{p}{(}\PY{n}{image}\PY{p}{,} \PY{n}{cv2}\PY{o}{.}\PY{n}{COLOR\PYZus{}BGR2RGB}\PY{p}{)}
        
        \PY{c+c1}{\PYZsh{} Plot the RGB image}
        \PY{n}{fig} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{figsize} \PY{o}{=} \PY{p}{(}\PY{l+m+mi}{6}\PY{p}{,}\PY{l+m+mi}{6}\PY{p}{)}\PY{p}{)}
        \PY{n}{ax1} \PY{o}{=} \PY{n}{fig}\PY{o}{.}\PY{n}{add\PYZus{}subplot}\PY{p}{(}\PY{l+m+mi}{111}\PY{p}{)}
        \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}xticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{)}
        \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}yticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{)}
        
        \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Original Image}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        \PY{n}{ax1}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{image}\PY{p}{)}
\end{Verbatim}


\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}4}]:} <matplotlib.image.AxesImage at 0x1703dc8d320>
\end{Verbatim}
            
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_12_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    Notice that even though the image is a black and white image, we have
read it in as a color image and so it will still need to be converted to
grayscale in order to perform the most accurate face detection.

So, the next steps will be to convert this image to grayscale, then load
OpenCV's face detector and run it with parameters that detect this face
accurately.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}5}]:} \PY{c+c1}{\PYZsh{} Convert the RGB  image to grayscale}
        \PY{n}{gray} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{cvtColor}\PY{p}{(}\PY{n}{image}\PY{p}{,} \PY{n}{cv2}\PY{o}{.}\PY{n}{COLOR\PYZus{}RGB2GRAY}\PY{p}{)}
        
        \PY{c+c1}{\PYZsh{} Extract the pre\PYZhy{}trained face detector from an xml file}
        \PY{n}{face\PYZus{}cascade} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{CascadeClassifier}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{detector\PYZus{}architectures/haarcascade\PYZus{}frontalface\PYZus{}default.xml}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        
        \PY{c+c1}{\PYZsh{} Detect the faces in image}
        \PY{n}{faces} \PY{o}{=} \PY{n}{face\PYZus{}cascade}\PY{o}{.}\PY{n}{detectMultiScale}\PY{p}{(}\PY{n}{gray}\PY{p}{,} \PY{l+m+mf}{1.25}\PY{p}{,} \PY{l+m+mi}{6}\PY{p}{)}
        
        \PY{c+c1}{\PYZsh{} Print the number of faces detected in the image}
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Number of faces detected:}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{faces}\PY{p}{)}\PY{p}{)}
        
        \PY{c+c1}{\PYZsh{} Make a copy of the orginal image to draw face detections on}
        \PY{n}{image\PYZus{}with\PYZus{}detections} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{copy}\PY{p}{(}\PY{n}{image}\PY{p}{)}
        
        \PY{c+c1}{\PYZsh{} Get the bounding box for each detected face}
        \PY{k}{for} \PY{p}{(}\PY{n}{x}\PY{p}{,}\PY{n}{y}\PY{p}{,}\PY{n}{w}\PY{p}{,}\PY{n}{h}\PY{p}{)} \PY{o+ow}{in} \PY{n}{faces}\PY{p}{:}
            \PY{c+c1}{\PYZsh{} Add a red bounding box to the detections image}
            \PY{n}{cv2}\PY{o}{.}\PY{n}{rectangle}\PY{p}{(}\PY{n}{image\PYZus{}with\PYZus{}detections}\PY{p}{,} \PY{p}{(}\PY{n}{x}\PY{p}{,}\PY{n}{y}\PY{p}{)}\PY{p}{,} \PY{p}{(}\PY{n}{x}\PY{o}{+}\PY{n}{w}\PY{p}{,}\PY{n}{y}\PY{o}{+}\PY{n}{h}\PY{p}{)}\PY{p}{,} \PY{p}{(}\PY{l+m+mi}{255}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{)}\PY{p}{,} \PY{l+m+mi}{3}\PY{p}{)}
            
        
        \PY{c+c1}{\PYZsh{} Display the image with the detections}
        \PY{n}{fig} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{figsize} \PY{o}{=} \PY{p}{(}\PY{l+m+mi}{6}\PY{p}{,}\PY{l+m+mi}{6}\PY{p}{)}\PY{p}{)}
        \PY{n}{ax1} \PY{o}{=} \PY{n}{fig}\PY{o}{.}\PY{n}{add\PYZus{}subplot}\PY{p}{(}\PY{l+m+mi}{111}\PY{p}{)}
        \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}xticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{)}
        \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}yticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{)}
        
        \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Image with Face Detection}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        \PY{n}{ax1}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{image\PYZus{}with\PYZus{}detections}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
Number of faces detected: 1

    \end{Verbatim}

\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}5}]:} <matplotlib.image.AxesImage at 0x1703dce66a0>
\end{Verbatim}
            
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_14_2.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \subsubsection{(IMPLEMENTATION) Add an eye detector to the current face
detection
setup.}\label{implementation-add-an-eye-detector-to-the-current-face-detection-setup.}

A Haar-cascade eye detector can be included in the same way that the
face detector was and, in this first task, it will be your job to do
just this.

    To set up an eye detector, use the stored parameters of the eye cascade
detector, called \texttt{haarcascade\_eye.xml}, located in the
\texttt{detector\_architectures} subdirectory. In the next code cell,
create your eye detector and store its detections.

\textbf{A few notes before you get started}:

First, make sure to give your loaded eye detector the variable name

\texttt{eye\_cascade}

and give the list of eye regions you detect the variable name

\texttt{eyes}

Second, since we've already run the face detector over this image, you
should only search for eyes \emph{within the rectangular face regions
detected in \texttt{faces}}. This will minimize false detections.

Lastly, once you've run your eye detector over the facial detection
region, you should display the RGB image with both the face detection
boxes (in red) and your eye detections (in green) to verify that
everything works as expected.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}29}]:} \PY{c+c1}{\PYZsh{} Make a copy of the original image to plot rectangle detections}
         \PY{n}{image\PYZus{}with\PYZus{}detections} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{copy}\PY{p}{(}\PY{n}{image}\PY{p}{)}   
         
         \PY{c+c1}{\PYZsh{} Loop over the detections and draw their corresponding face detection boxes}
         \PY{k}{for} \PY{p}{(}\PY{n}{x}\PY{p}{,}\PY{n}{y}\PY{p}{,}\PY{n}{w}\PY{p}{,}\PY{n}{h}\PY{p}{)} \PY{o+ow}{in} \PY{n}{faces}\PY{p}{:}
             \PY{n}{cv2}\PY{o}{.}\PY{n}{rectangle}\PY{p}{(}\PY{n}{image\PYZus{}with\PYZus{}detections}\PY{p}{,} \PY{p}{(}\PY{n}{x}\PY{p}{,}\PY{n}{y}\PY{p}{)}\PY{p}{,} \PY{p}{(}\PY{n}{x}\PY{o}{+}\PY{n}{w}\PY{p}{,}\PY{n}{y}\PY{o}{+}\PY{n}{h}\PY{p}{)}\PY{p}{,}\PY{p}{(}\PY{l+m+mi}{255}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{)}\PY{p}{,} \PY{l+m+mi}{3}\PY{p}{)}  
             
         \PY{c+c1}{\PYZsh{} Do not change the code above this comment!}
         
             
         \PY{c+c1}{\PYZsh{}\PYZsh{} TODO: Add eye detection, using haarcascade\PYZus{}eye.xml, to the current face detector algorithm}
         \PY{c+c1}{\PYZsh{}\PYZsh{} TODO: Loop over the eye detections and draw their corresponding boxes in green on image\PYZus{}with\PYZus{}detections}
         
         \PY{c+c1}{\PYZsh{} Extract the pre\PYZhy{}trained face detector from an xml file}
         \PY{n}{eye\PYZus{}cascade} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{CascadeClassifier}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{detector\PYZus{}architectures/haarcascade\PYZus{}eye.xml}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{face\PYZus{}img} \PY{o}{=} \PY{k+kc}{None}
         \PY{c+c1}{\PYZsh{}search for eyes within the rectangular face regions detected}
         \PY{k}{for} \PY{p}{(}\PY{n}{x}\PY{p}{,}\PY{n}{y}\PY{p}{,}\PY{n}{w}\PY{p}{,}\PY{n}{h}\PY{p}{)} \PY{o+ow}{in} \PY{n}{faces}\PY{p}{:}
             \PY{n}{face\PYZus{}img} \PY{o}{=} \PY{n}{gray}\PY{p}{[}\PY{n}{y}\PY{p}{:}\PY{n}{y}\PY{o}{+}\PY{n}{h}\PY{p}{,} \PY{n}{x}\PY{p}{:}\PY{n}{x}\PY{o}{+}\PY{n}{w}\PY{p}{]}
             \PY{c+c1}{\PYZsh{} Detect the eyes in face image}
             \PY{n}{eyes} \PY{o}{=} \PY{n}{eye\PYZus{}cascade}\PY{o}{.}\PY{n}{detectMultiScale}\PY{p}{(}\PY{n}{face\PYZus{}img}\PY{p}{,} \PY{l+m+mf}{1.16}\PY{p}{,} \PY{l+m+mi}{6}\PY{p}{)}
             \PY{k}{for} \PY{p}{(}\PY{n}{x\PYZus{}e}\PY{p}{,}\PY{n}{y\PYZus{}e}\PY{p}{,}\PY{n}{w\PYZus{}e}\PY{p}{,}\PY{n}{h\PYZus{}e}\PY{p}{)} \PY{o+ow}{in} \PY{n}{eyes}\PY{p}{:}
                 \PY{n}{cv2}\PY{o}{.}\PY{n}{rectangle}\PY{p}{(}\PY{n}{image\PYZus{}with\PYZus{}detections}\PY{p}{,} \PY{p}{(}\PY{n}{x} \PY{o}{+} \PY{n}{x\PYZus{}e}\PY{p}{,}\PY{n}{y} \PY{o}{+}\PY{n}{y\PYZus{}e}\PY{p}{)}\PY{p}{,} \PY{p}{(}\PY{n}{x}\PY{o}{+}\PY{n}{x\PYZus{}e}\PY{o}{+}\PY{n}{w\PYZus{}e}\PY{p}{,}\PY{n}{y} \PY{o}{+} \PY{n}{y\PYZus{}e} \PY{o}{+} \PY{n}{h\PYZus{}e}\PY{p}{)}\PY{p}{,}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{255}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{)}\PY{p}{,} \PY{l+m+mi}{3}\PY{p}{)} 
         
         \PY{c+c1}{\PYZsh{} Plot the image with both faces and eyes detected}
         \PY{n}{fig} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{figsize} \PY{o}{=} \PY{p}{(}\PY{l+m+mi}{6}\PY{p}{,}\PY{l+m+mi}{6}\PY{p}{)}\PY{p}{)}
         \PY{n}{ax1} \PY{o}{=} \PY{n}{fig}\PY{o}{.}\PY{n}{add\PYZus{}subplot}\PY{p}{(}\PY{l+m+mi}{111}\PY{p}{)}
         \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}xticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{)}
         \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}yticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{)}
         
         
         \PY{c+c1}{\PYZsh{}ax1.imshow(face\PYZus{}img)}
         
         \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Image with Face and Eye Detection}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{ax1}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{image\PYZus{}with\PYZus{}detections}\PY{p}{)}
\end{Verbatim}


\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}29}]:} <matplotlib.image.AxesImage at 0x1704163e4a8>
\end{Verbatim}
            
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_17_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \subsection{(Optional) Add face and eye detection to your laptop
camera}\label{optional-add-face-and-eye-detection-to-your-laptop-camera}

It's time to kick it up a notch, and add face and eye detection to your
laptop's camera!

Afterwards, you'll be able to show off your creation like in the gif
shown below - made with a completed version of the code!

Notice that not all of the detections here are perfect - and your result
need not be perfect either.

Spent a small amount of time tuning the parameters of your detectors to
get reasonable results, but don't hold out for perfection. If we wanted
perfection we'd need to spend a ton of time tuning the parameters of
each detector, cleaning up the input image frames, etc. You can think of
this as more of a rapid prototype.

The next cell contains code for a wrapper function called
\texttt{laptop\_camera\_face\_eye\_detector} that, when called, will
activate your laptop's camera. Placed the relevant face and eye
detection code in this wrapper function to implement face/eye detection
and mark those detections on each image frame that your camera captures.

Before adding anything to the function, you can run it to get an idea of
how it works - a small window should pop up showing you the live feed
from your camera; you can press any key to close this window.

\textbf{Note:} Mac users may find that activating this function kills
the kernel of their notebook every once in a while. If this happens to
you, just restart your notebook's kernel, activate cell(s) containing
any crucial import statements, and you'll be good to go!

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}166}]:} \PY{c+c1}{\PYZsh{}\PYZsh{}\PYZsh{} Add face and eye detection to this laptop camera function }
          \PY{c+c1}{\PYZsh{} Make sure to draw out all faces/eyes found in each frame on the shown video feed}
          
          \PY{k+kn}{import} \PY{n+nn}{cv2}
          \PY{k+kn}{import} \PY{n+nn}{time} 
          
          \PY{c+c1}{\PYZsh{} wrapper function for face/eye detection with your laptop camera}
          \PY{k}{def} \PY{n+nf}{laptop\PYZus{}camera\PYZus{}go}\PY{p}{(}\PY{p}{)}\PY{p}{:}
              \PY{c+c1}{\PYZsh{} Create instance of video capturer}
              \PY{n}{cv2}\PY{o}{.}\PY{n}{namedWindow}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{face detection activated}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
              \PY{n}{vc} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{VideoCapture}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{)} \PY{c+c1}{\PYZsh{}I have 2 cameras}
          
              \PY{c+c1}{\PYZsh{} Try to get the first frame}
              \PY{k}{if} \PY{n}{vc}\PY{o}{.}\PY{n}{isOpened}\PY{p}{(}\PY{p}{)}\PY{p}{:} 
                  \PY{n}{rval}\PY{p}{,} \PY{n}{frame} \PY{o}{=} \PY{n}{vc}\PY{o}{.}\PY{n}{read}\PY{p}{(}\PY{p}{)}
              \PY{k}{else}\PY{p}{:}
                  \PY{n}{rval} \PY{o}{=} \PY{k+kc}{False}
              
              \PY{n}{face\PYZus{}cascade} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{CascadeClassifier}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{detector\PYZus{}architectures/haarcascade\PYZus{}frontalface\PYZus{}default.xml}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
              \PY{n}{eyes\PYZus{}cascade} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{CascadeClassifier}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{detector\PYZus{}architectures/haarcascade\PYZus{}eye.xml}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
              
              \PY{c+c1}{\PYZsh{} Keep the video stream open}
              \PY{k}{while} \PY{n}{rval}\PY{p}{:}
                  \PY{n}{gray} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{cvtColor}\PY{p}{(}\PY{n}{frame}\PY{p}{,} \PY{n}{cv2}\PY{o}{.}\PY{n}{COLOR\PYZus{}RGB2GRAY}\PY{p}{)}
                  \PY{n}{faces} \PY{o}{=} \PY{n}{face\PYZus{}cascade}\PY{o}{.}\PY{n}{detectMultiScale}\PY{p}{(}\PY{n}{gray}\PY{p}{,} \PY{l+m+mf}{1.20}\PY{p}{,} \PY{l+m+mi}{6}\PY{p}{)}
                  \PY{k}{for} \PY{p}{(}\PY{n}{x}\PY{p}{,}\PY{n}{y}\PY{p}{,}\PY{n}{w}\PY{p}{,}\PY{n}{h}\PY{p}{)} \PY{o+ow}{in} \PY{n}{faces}\PY{p}{:}
                      \PY{n}{cv2}\PY{o}{.}\PY{n}{rectangle}\PY{p}{(}\PY{n}{frame}\PY{p}{,} \PY{p}{(}\PY{n}{x}\PY{p}{,}\PY{n}{y}\PY{p}{)}\PY{p}{,} \PY{p}{(}\PY{n}{x}\PY{o}{+}\PY{n}{w}\PY{p}{,}\PY{n}{y}\PY{o}{+}\PY{n}{h}\PY{p}{)}\PY{p}{,}\PY{p}{(}\PY{l+m+mi}{255}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{)}\PY{p}{,} \PY{l+m+mi}{3}\PY{p}{)}  
              
                  \PY{n}{face\PYZus{}img} \PY{o}{=} \PY{k+kc}{None}
                  \PY{c+c1}{\PYZsh{}search for eyes within the rectangular face regions detected}
                  \PY{k}{for} \PY{p}{(}\PY{n}{x}\PY{p}{,}\PY{n}{y}\PY{p}{,}\PY{n}{w}\PY{p}{,}\PY{n}{h}\PY{p}{)} \PY{o+ow}{in} \PY{n}{faces}\PY{p}{:}
                      \PY{n}{face\PYZus{}img} \PY{o}{=} \PY{n}{gray}\PY{p}{[}\PY{n}{y}\PY{p}{:}\PY{n}{y}\PY{o}{+}\PY{n}{h}\PY{p}{,} \PY{n}{x}\PY{p}{:}\PY{n}{x}\PY{o}{+}\PY{n}{w}\PY{p}{]}
                      \PY{c+c1}{\PYZsh{} Detect the eyes in face image}
                      \PY{n}{eyes} \PY{o}{=} \PY{n}{eye\PYZus{}cascade}\PY{o}{.}\PY{n}{detectMultiScale}\PY{p}{(}\PY{n}{face\PYZus{}img}\PY{p}{,} \PY{l+m+mf}{1.2}\PY{p}{,} \PY{l+m+mi}{8}\PY{p}{)}
                      \PY{k}{for} \PY{p}{(}\PY{n}{x\PYZus{}e}\PY{p}{,}\PY{n}{y\PYZus{}e}\PY{p}{,}\PY{n}{w\PYZus{}e}\PY{p}{,}\PY{n}{h\PYZus{}e}\PY{p}{)} \PY{o+ow}{in} \PY{n}{eyes}\PY{p}{:}
                          \PY{n}{cv2}\PY{o}{.}\PY{n}{rectangle}\PY{p}{(}\PY{n}{frame}\PY{p}{,} \PY{p}{(}\PY{n}{x} \PY{o}{+} \PY{n}{x\PYZus{}e}\PY{p}{,}\PY{n}{y} \PY{o}{+}\PY{n}{y\PYZus{}e}\PY{p}{)}\PY{p}{,} \PY{p}{(}\PY{n}{x}\PY{o}{+}\PY{n}{x\PYZus{}e}\PY{o}{+}\PY{n}{w\PYZus{}e}\PY{p}{,}\PY{n}{y} \PY{o}{+} \PY{n}{y\PYZus{}e} \PY{o}{+} \PY{n}{h\PYZus{}e}\PY{p}{)}\PY{p}{,}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{255}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{)}\PY{p}{,} \PY{l+m+mi}{3}\PY{p}{)} 
          
                  
                  \PY{c+c1}{\PYZsh{} Plot the image from camera with all the face and eye detections marked}
                  \PY{n}{cv2}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{face detection activated}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{n}{frame}\PY{p}{)}
                  
                  \PY{c+c1}{\PYZsh{} Exit functionality \PYZhy{} press any key to exit laptop video}
                  \PY{n}{key} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{waitKey}\PY{p}{(}\PY{l+m+mi}{20}\PY{p}{)}
                  \PY{k}{if} \PY{n}{key} \PY{o}{\PYZgt{}} \PY{l+m+mi}{0}\PY{p}{:} \PY{c+c1}{\PYZsh{} Exit by pressing any key}
                      \PY{c+c1}{\PYZsh{} Destroy windows }
                      \PY{n}{cv2}\PY{o}{.}\PY{n}{destroyAllWindows}\PY{p}{(}\PY{p}{)}
                      
                      \PY{c+c1}{\PYZsh{} Make sure window closes on OSx}
                      \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range} \PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,}\PY{l+m+mi}{5}\PY{p}{)}\PY{p}{:}
                          \PY{n}{cv2}\PY{o}{.}\PY{n}{waitKey}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{)}
                      \PY{k}{return}
                  
                  \PY{c+c1}{\PYZsh{} Read next frame}
                  \PY{n}{time}\PY{o}{.}\PY{n}{sleep}\PY{p}{(}\PY{l+m+mf}{0.05}\PY{p}{)}             \PY{c+c1}{\PYZsh{} control framerate for computation \PYZhy{} default 20 frames per sec}
                  \PY{n}{rval}\PY{p}{,} \PY{n}{frame} \PY{o}{=} \PY{n}{vc}\PY{o}{.}\PY{n}{read}\PY{p}{(}\PY{p}{)}    
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}167}]:} \PY{c+c1}{\PYZsh{} Call the laptop camera face/eye detector function above}
          \PY{n}{laptop\PYZus{}camera\PYZus{}go}\PY{p}{(}\PY{p}{)}
\end{Verbatim}


    \begin{center}\rule{0.5\linewidth}{\linethickness}\end{center}

\subsection{Step 2: De-noise an Image for Better Face
Detection}\label{step-2-de-noise-an-image-for-better-face-detection}

    Image quality is an important aspect of any computer vision task.

Typically, when creating a set of images to train a deep learning
network, significant care is taken to ensure that training images are
free of visual noise or artifacts that hinder object detection.

While computer vision algorithms - like a face detector - are typically
trained on 'nice' data such as this, new test data doesn't always look
so nice!

When applying a trained computer vision algorithm to a new piece of test
data one often cleans it up first before feeding it in.

This sort of cleaning - referred to as \emph{pre-processing} - can
include a number of cleaning phases like blurring, de-noising, color
transformations, etc., and many of these tasks can be accomplished using
OpenCV.

In this short subsection we explore OpenCV's noise-removal functionality
to see how we can clean up a noisy image, which we then feed into our
trained face detector.

    \subsubsection{Create a noisy image to work
with}\label{create-a-noisy-image-to-work-with}

In the next cell, we create an artificial noisy version of the previous
multi-face image.

This is a little exaggerated - we don't typically get images that are
this noisy - but
\href{https://digital-photography-school.com/how-to-avoid-and-reduce-noise-in-your-images/}{image
noise}, or 'grainy-ness' in a digitial image - is a fairly common
phenomenon.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}69}]:} \PY{c+c1}{\PYZsh{} Load in the multi\PYZhy{}face test image again}
         \PY{n}{image} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{imread}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{images/test\PYZus{}image\PYZus{}1.jpg}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} Convert the image copy to RGB colorspace}
         \PY{n}{image} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{cvtColor}\PY{p}{(}\PY{n}{image}\PY{p}{,} \PY{n}{cv2}\PY{o}{.}\PY{n}{COLOR\PYZus{}BGR2RGB}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} Make an array copy of this image}
         \PY{n}{image\PYZus{}with\PYZus{}noise} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{asarray}\PY{p}{(}\PY{n}{image}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} Create noise \PYZhy{} here we add noise sampled randomly from a Gaussian distribution: a common model for noise}
         \PY{n}{noise\PYZus{}level} \PY{o}{=} \PY{l+m+mi}{40}
         \PY{n}{noise} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{random}\PY{o}{.}\PY{n}{randn}\PY{p}{(}\PY{n}{image}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,}\PY{n}{image}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,}\PY{n}{image}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{]}\PY{p}{)}\PY{o}{*}\PY{n}{noise\PYZus{}level}
         
         \PY{c+c1}{\PYZsh{} Add this noise to the array image copy}
         \PY{n}{image\PYZus{}with\PYZus{}noise} \PY{o}{=} \PY{n}{image\PYZus{}with\PYZus{}noise} \PY{o}{+} \PY{n}{noise}
         
         \PY{c+c1}{\PYZsh{} Convert back to uint8 format}
         \PY{n}{image\PYZus{}with\PYZus{}noise} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{asarray}\PY{p}{(}\PY{p}{[}\PY{n}{np}\PY{o}{.}\PY{n}{uint8}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{clip}\PY{p}{(}\PY{n}{i}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{255}\PY{p}{)}\PY{p}{)} \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n}{image\PYZus{}with\PYZus{}noise}\PY{p}{]}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} Plot our noisy image!}
         \PY{n}{fig} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{figsize} \PY{o}{=} \PY{p}{(}\PY{l+m+mi}{8}\PY{p}{,}\PY{l+m+mi}{8}\PY{p}{)}\PY{p}{)}
         \PY{n}{ax1} \PY{o}{=} \PY{n}{fig}\PY{o}{.}\PY{n}{add\PYZus{}subplot}\PY{p}{(}\PY{l+m+mi}{111}\PY{p}{)}
         \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}xticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{)}
         \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}yticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{)}
         
         \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Noisy Image}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{ax1}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{image\PYZus{}with\PYZus{}noise}\PY{p}{)}
\end{Verbatim}


\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}69}]:} <matplotlib.image.AxesImage at 0x1704196ec18>
\end{Verbatim}
            
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_24_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    In the context of face detection, the problem with an image like this is
that - due to noise - we may miss some faces or get false detections.

In the next cell we apply the same trained OpenCV detector with the same
settings as before, to see what sort of detections we get.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}70}]:} \PY{c+c1}{\PYZsh{} Convert the RGB  image to grayscale}
         \PY{n}{gray\PYZus{}noise} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{cvtColor}\PY{p}{(}\PY{n}{image\PYZus{}with\PYZus{}noise}\PY{p}{,} \PY{n}{cv2}\PY{o}{.}\PY{n}{COLOR\PYZus{}RGB2GRAY}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} Extract the pre\PYZhy{}trained face detector from an xml file}
         \PY{n}{face\PYZus{}cascade} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{CascadeClassifier}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{detector\PYZus{}architectures/haarcascade\PYZus{}frontalface\PYZus{}default.xml}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} Detect the faces in image}
         \PY{n}{faces} \PY{o}{=} \PY{n}{face\PYZus{}cascade}\PY{o}{.}\PY{n}{detectMultiScale}\PY{p}{(}\PY{n}{gray\PYZus{}noise}\PY{p}{,} \PY{l+m+mi}{4}\PY{p}{,} \PY{l+m+mi}{6}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} Print the number of faces detected in the image}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Number of faces detected:}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{faces}\PY{p}{)}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} Make a copy of the orginal image to draw face detections on}
         \PY{n}{image\PYZus{}with\PYZus{}detections} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{copy}\PY{p}{(}\PY{n}{image\PYZus{}with\PYZus{}noise}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} Get the bounding box for each detected face}
         \PY{k}{for} \PY{p}{(}\PY{n}{x}\PY{p}{,}\PY{n}{y}\PY{p}{,}\PY{n}{w}\PY{p}{,}\PY{n}{h}\PY{p}{)} \PY{o+ow}{in} \PY{n}{faces}\PY{p}{:}
             \PY{c+c1}{\PYZsh{} Add a red bounding box to the detections image}
             \PY{n}{cv2}\PY{o}{.}\PY{n}{rectangle}\PY{p}{(}\PY{n}{image\PYZus{}with\PYZus{}detections}\PY{p}{,} \PY{p}{(}\PY{n}{x}\PY{p}{,}\PY{n}{y}\PY{p}{)}\PY{p}{,} \PY{p}{(}\PY{n}{x}\PY{o}{+}\PY{n}{w}\PY{p}{,}\PY{n}{y}\PY{o}{+}\PY{n}{h}\PY{p}{)}\PY{p}{,} \PY{p}{(}\PY{l+m+mi}{255}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{)}\PY{p}{,} \PY{l+m+mi}{3}\PY{p}{)}
             
         
         \PY{c+c1}{\PYZsh{} Display the image with the detections}
         \PY{n}{fig} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{figsize} \PY{o}{=} \PY{p}{(}\PY{l+m+mi}{8}\PY{p}{,}\PY{l+m+mi}{8}\PY{p}{)}\PY{p}{)}
         \PY{n}{ax1} \PY{o}{=} \PY{n}{fig}\PY{o}{.}\PY{n}{add\PYZus{}subplot}\PY{p}{(}\PY{l+m+mi}{111}\PY{p}{)}
         \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}xticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{)}
         \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}yticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{)}
         
         \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Noisy Image with Face Detections}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{ax1}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{image\PYZus{}with\PYZus{}detections}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
Number of faces detected: 12

    \end{Verbatim}

\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}70}]:} <matplotlib.image.AxesImage at 0x1703ea0ba90>
\end{Verbatim}
            
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_26_2.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    With this added noise we now miss one of the faces!

    \subsubsection{(IMPLEMENTATION) De-noise this image for better face
detection}\label{implementation-de-noise-this-image-for-better-face-detection}

Time to get your hands dirty: using OpenCV's built in color image
de-noising functionality called \texttt{fastNlMeansDenoisingColored} -
de-noise this image enough so that all the faces in the image are
properly detected.

Once you have cleaned the image in the next cell, use the cell that
follows to run our trained face detector over the cleaned image to check
out its detections.

You can find its {[}official documentation
here{]}(\href{http://docs.opencv.org/trunk/d1/d79/group__photo__denoise.html\#ga21abc1c8b0e15f78cd3eff672cb6c476}{documentation
for denoising} and
\href{http://opencv-python-tutroals.readthedocs.io/en/latest/py_tutorials/py_photo/py_non_local_means/py_non_local_means.html}{a
useful example here}.

\textbf{Note:} you can keep all parameters \emph{except}
\texttt{photo\_render} fixed as shown in the second link above. Play
around with the value of this parameter - see how it affects the
resulting cleaned image.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}76}]:} \PY{c+c1}{\PYZsh{}\PYZsh{} TODO: Use OpenCV\PYZsq{}s built in color image de\PYZhy{}noising function to clean up our noisy image!}
         
         \PY{n}{denoised\PYZus{}image} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{fastNlMeansDenoisingColored}\PY{p}{(}\PY{n}{image\PYZus{}with\PYZus{}noise}\PY{p}{,}\PY{k+kc}{None}\PY{p}{,}\PY{l+m+mi}{16}\PY{p}{,}\PY{l+m+mi}{16}\PY{p}{,}\PY{l+m+mi}{7}\PY{p}{,}\PY{l+m+mi}{21}\PY{p}{)}\PY{c+c1}{\PYZsh{} your final de\PYZhy{}noised image (should be RGB)}
         
         \PY{n}{fig} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{figsize} \PY{o}{=} \PY{p}{(}\PY{l+m+mi}{8}\PY{p}{,}\PY{l+m+mi}{8}\PY{p}{)}\PY{p}{)}
         \PY{n}{ax1} \PY{o}{=} \PY{n}{fig}\PY{o}{.}\PY{n}{add\PYZus{}subplot}\PY{p}{(}\PY{l+m+mi}{111}\PY{p}{)}
         \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}xticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{)}
         \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}yticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{)}
         
         \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Denoised image}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{ax1}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{denoised\PYZus{}image}\PY{p}{)}
\end{Verbatim}


\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}76}]:} <matplotlib.image.AxesImage at 0x170450d0160>
\end{Verbatim}
            
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_29_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}79}]:} \PY{c+c1}{\PYZsh{}\PYZsh{} TODO: Run the face detector on the de\PYZhy{}noised image to improve your detections and display the result}
         
         \PY{c+c1}{\PYZsh{} Convert the RGB  image to grayscale}
         \PY{n}{gray\PYZus{}denoise} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{cvtColor}\PY{p}{(}\PY{n}{denoised\PYZus{}image}\PY{p}{,} \PY{n}{cv2}\PY{o}{.}\PY{n}{COLOR\PYZus{}RGB2GRAY}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} Detect the faces in image}
         \PY{n}{faces} \PY{o}{=} \PY{n}{face\PYZus{}cascade}\PY{o}{.}\PY{n}{detectMultiScale}\PY{p}{(}\PY{n}{gray\PYZus{}denoise}\PY{p}{,} \PY{l+m+mi}{4}\PY{p}{,} \PY{l+m+mi}{6}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} Print the number of faces detected in the image}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Number of faces detected:}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{faces}\PY{p}{)}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} Make a copy of the orginal image to draw face detections on}
         \PY{n}{image\PYZus{}with\PYZus{}detections} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{copy}\PY{p}{(}\PY{n}{denoised\PYZus{}image}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} Get the bounding box for each detected face}
         \PY{k}{for} \PY{p}{(}\PY{n}{x}\PY{p}{,}\PY{n}{y}\PY{p}{,}\PY{n}{w}\PY{p}{,}\PY{n}{h}\PY{p}{)} \PY{o+ow}{in} \PY{n}{faces}\PY{p}{:}
             \PY{c+c1}{\PYZsh{} Add a red bounding box to the detections image}
             \PY{n}{cv2}\PY{o}{.}\PY{n}{rectangle}\PY{p}{(}\PY{n}{image\PYZus{}with\PYZus{}detections}\PY{p}{,} \PY{p}{(}\PY{n}{x}\PY{p}{,}\PY{n}{y}\PY{p}{)}\PY{p}{,} \PY{p}{(}\PY{n}{x}\PY{o}{+}\PY{n}{w}\PY{p}{,}\PY{n}{y}\PY{o}{+}\PY{n}{h}\PY{p}{)}\PY{p}{,} \PY{p}{(}\PY{l+m+mi}{255}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{)}\PY{p}{,} \PY{l+m+mi}{3}\PY{p}{)}
             
         
         \PY{c+c1}{\PYZsh{} Display the image with the detections}
         \PY{n}{fig} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{figsize} \PY{o}{=} \PY{p}{(}\PY{l+m+mi}{8}\PY{p}{,}\PY{l+m+mi}{8}\PY{p}{)}\PY{p}{)}
         \PY{n}{ax1} \PY{o}{=} \PY{n}{fig}\PY{o}{.}\PY{n}{add\PYZus{}subplot}\PY{p}{(}\PY{l+m+mi}{111}\PY{p}{)}
         \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}xticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{)}
         \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}yticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{)}
         
         \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Denoised Image with Face Detections}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{ax1}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{image\PYZus{}with\PYZus{}detections}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
Number of faces detected: 13

    \end{Verbatim}

\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}79}]:} <matplotlib.image.AxesImage at 0x170451dd470>
\end{Verbatim}
            
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_30_2.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{center}\rule{0.5\linewidth}{\linethickness}\end{center}

\subsection{Step 3: Blur an Image and Perform Edge
Detection}\label{step-3-blur-an-image-and-perform-edge-detection}

    Now that we have developed a simple pipeline for detecting faces using
OpenCV - let's start playing around with a few fun things we can do with
all those detected faces!

    \subsubsection{Importance of Blur in Edge
Detection}\label{importance-of-blur-in-edge-detection}

Edge detection is a concept that pops up almost everywhere in computer
vision applications, as edge-based features (as well as features built
on top of edges) are often some of the best features for e.g., object
detection and recognition problems.

Edge detection is a dimension reduction technique - by keeping only the
edges of an image we get to throw away a lot of non-discriminating
information.

Typically the most useful kind of edge-detection is one that preserves
only the important, global structures (ignoring local structures that
aren't very discriminative).

So removing local structures / retaining global structures is a crucial
pre-processing step to performing edge detection in an image, and
blurring can do just that.

Below is an animated gif showing the result of an edge-detected cat
\href{https://en.wikipedia.org/wiki/Gaussian_blur\#Common_uses}{taken
from Wikipedia}, where the image is gradually blurred more and more
prior to edge detection.

When the animation begins you can't quite make out what it's a picture
of, but as the animation evolves and local structures are removed via
blurring the cat becomes visible in the edge-detected image.

Edge detection is a \textbf{convolution} performed on the image itself,
and you can read about Canny edge detection on
\href{http://docs.opencv.org/2.4/doc/tutorials/imgproc/imgtrans/canny_detector/canny_detector.html}{this
OpenCV documentation page}.

    \subsubsection{Canny edge detection}\label{canny-edge-detection}

In the cell below we load in a test image, then apply \emph{Canny edge
detection} on it.

The original image is shown on the left panel of the figure, while the
edge-detected version of the image is shown on the right.

Notice how the result looks very busy - there are too many little
details preserved in the image before it is sent to the edge detector.

When applied in computer vision applications, edge detection should
preserve \emph{global} structure; doing away with local structures that
don't help describe what objects are in the image.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}80}]:} \PY{c+c1}{\PYZsh{} Load in the image}
         \PY{n}{image} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{imread}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{images/fawzia.jpg}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} Convert to RGB colorspace}
         \PY{n}{image} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{cvtColor}\PY{p}{(}\PY{n}{image}\PY{p}{,} \PY{n}{cv2}\PY{o}{.}\PY{n}{COLOR\PYZus{}BGR2RGB}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} Convert to grayscale}
         \PY{n}{gray} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{cvtColor}\PY{p}{(}\PY{n}{image}\PY{p}{,} \PY{n}{cv2}\PY{o}{.}\PY{n}{COLOR\PYZus{}RGB2GRAY}\PY{p}{)}  
         
         \PY{c+c1}{\PYZsh{} Perform Canny edge detection}
         \PY{n}{edges} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{Canny}\PY{p}{(}\PY{n}{gray}\PY{p}{,}\PY{l+m+mi}{100}\PY{p}{,}\PY{l+m+mi}{200}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} Dilate the image to amplify edges}
         \PY{n}{edges} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{dilate}\PY{p}{(}\PY{n}{edges}\PY{p}{,} \PY{k+kc}{None}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} Plot the RGB and edge\PYZhy{}detected image}
         \PY{n}{fig} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{figsize} \PY{o}{=} \PY{p}{(}\PY{l+m+mi}{15}\PY{p}{,}\PY{l+m+mi}{15}\PY{p}{)}\PY{p}{)}
         \PY{n}{ax1} \PY{o}{=} \PY{n}{fig}\PY{o}{.}\PY{n}{add\PYZus{}subplot}\PY{p}{(}\PY{l+m+mi}{121}\PY{p}{)}
         \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}xticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{)}
         \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}yticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{)}
         
         \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Original Image}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{ax1}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{image}\PY{p}{)}
         
         \PY{n}{ax2} \PY{o}{=} \PY{n}{fig}\PY{o}{.}\PY{n}{add\PYZus{}subplot}\PY{p}{(}\PY{l+m+mi}{122}\PY{p}{)}
         \PY{n}{ax2}\PY{o}{.}\PY{n}{set\PYZus{}xticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{)}
         \PY{n}{ax2}\PY{o}{.}\PY{n}{set\PYZus{}yticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{)}
         
         \PY{n}{ax2}\PY{o}{.}\PY{n}{set\PYZus{}title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Canny Edges}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{ax2}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{edges}\PY{p}{,} \PY{n}{cmap}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{gray}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
\end{Verbatim}


\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}80}]:} <matplotlib.image.AxesImage at 0x1704524f6d8>
\end{Verbatim}
            
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_35_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    Without first blurring the image, and removing small, local structures,
a lot of irrelevant edge content gets picked up and amplified by the
detector (as shown in the right panel above).

    \subsubsection{\texorpdfstring{(IMPLEMENTATION) Blur the image
\emph{then} perform edge
detection}{(IMPLEMENTATION) Blur the image then perform edge detection}}\label{implementation-blur-the-image-then-perform-edge-detection}

In the next cell, you will repeat this experiment - blurring the image
first to remove these local structures, so that only the important
boudnary details remain in the edge-detected image.

Blur the image by using OpenCV's \texttt{filter2d} functionality - which
is discussed in
\href{http://docs.opencv.org/3.1.0/d4/d13/tutorial_py_filtering.html}{this
documentation page} - and use an \emph{averaging kernel} of width equal
to 4.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}87}]:} \PY{c+c1}{\PYZsh{}\PYZsh{}\PYZsh{} TODO: Blur the test imageusing OpenCV\PYZsq{}s filter2d functionality, }
         \PY{c+c1}{\PYZsh{} Use an averaging kernel, and a kernel width equal to 4}
         \PY{c+c1}{\PYZsh{} Load in the image}
         \PY{n}{image} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{imread}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{images/fawzia.jpg}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} Convert to RGB colorspace}
         \PY{n}{image} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{cvtColor}\PY{p}{(}\PY{n}{image}\PY{p}{,} \PY{n}{cv2}\PY{o}{.}\PY{n}{COLOR\PYZus{}BGR2RGB}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} Convert to grayscale}
         \PY{n}{gray} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{cvtColor}\PY{p}{(}\PY{n}{image}\PY{p}{,} \PY{n}{cv2}\PY{o}{.}\PY{n}{COLOR\PYZus{}RGB2GRAY}\PY{p}{)}  
         
         \PY{n}{kernel} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{ones}\PY{p}{(}\PY{p}{(}\PY{l+m+mi}{4}\PY{p}{,}\PY{l+m+mi}{4}\PY{p}{)}\PY{p}{,}\PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{)}\PY{o}{/}\PY{l+m+mi}{16}
         \PY{n}{dst} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{filter2D}\PY{p}{(}\PY{n}{gray}\PY{p}{,}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,}\PY{n}{kernel}\PY{p}{)}
             
         \PY{c+c1}{\PYZsh{}\PYZsh{} TODO: Then perform Canny edge detection and display the output}
         
         \PY{c+c1}{\PYZsh{} Perform Canny edge detection}
         \PY{n}{edges} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{Canny}\PY{p}{(}\PY{n}{dst}\PY{p}{,}\PY{l+m+mi}{100}\PY{p}{,}\PY{l+m+mi}{200}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} Dilate the image to amplify edges}
         \PY{n}{edges} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{dilate}\PY{p}{(}\PY{n}{edges}\PY{p}{,} \PY{k+kc}{None}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} Plot the RGB and edge\PYZhy{}detected image}
         \PY{n}{fig} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{figsize} \PY{o}{=} \PY{p}{(}\PY{l+m+mi}{15}\PY{p}{,}\PY{l+m+mi}{15}\PY{p}{)}\PY{p}{)}
         \PY{n}{ax1} \PY{o}{=} \PY{n}{fig}\PY{o}{.}\PY{n}{add\PYZus{}subplot}\PY{p}{(}\PY{l+m+mi}{121}\PY{p}{)}
         \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}xticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{)}
         \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}yticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{)}
         
         \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Original Image}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{ax1}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{image}\PY{p}{)}
         
         \PY{n}{ax2} \PY{o}{=} \PY{n}{fig}\PY{o}{.}\PY{n}{add\PYZus{}subplot}\PY{p}{(}\PY{l+m+mi}{122}\PY{p}{)}
         \PY{n}{ax2}\PY{o}{.}\PY{n}{set\PYZus{}xticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{)}
         \PY{n}{ax2}\PY{o}{.}\PY{n}{set\PYZus{}yticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{)}
         
         \PY{n}{ax2}\PY{o}{.}\PY{n}{set\PYZus{}title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Canny Edges}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{ax2}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{edges}\PY{p}{,} \PY{n}{cmap}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{gray}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
\end{Verbatim}


\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}87}]:} <matplotlib.image.AxesImage at 0x1704de9eb00>
\end{Verbatim}
            
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_38_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{center}\rule{0.5\linewidth}{\linethickness}\end{center}

\subsection{Step 4: Automatically Hide the Identity of an
Individual}\label{step-4-automatically-hide-the-identity-of-an-individual}

If you film something like a documentary or reality TV, you must get
permission from every individual shown on film before you can show their
face, otherwise you need to blur it out - by blurring the face a lot (so
much so that even the global structures are obscured)!

This is also true for projects like
\href{https://www.google.com/streetview/}{Google's StreetView maps} - an
enormous collection of mapping images taken from a fleet of Google
vehicles.

Because it would be impossible for Google to get the permission of every
single person accidentally captured in one of these images they blur out
everyone's faces, the detected images must automatically blur the
identity of detected people.

Here's a few examples of folks caught in the camera of a Google street
view vehicle.

 

    \subsubsection{Read in an image to perform identity
detection}\label{read-in-an-image-to-perform-identity-detection}

Let's try this out for ourselves. Use the face detection pipeline built
above and what you know about using the \texttt{filter2D} to blur and
image, and use these in tandem to hide the identity of the person in the
following image - loaded in and printed in the next cell.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}131}]:} \PY{c+c1}{\PYZsh{} Load in the image}
          \PY{n}{image} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{imread}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{images/gus.jpg}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
          
          \PY{c+c1}{\PYZsh{} Convert the image to RGB colorspace}
          \PY{n}{image} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{cvtColor}\PY{p}{(}\PY{n}{image}\PY{p}{,} \PY{n}{cv2}\PY{o}{.}\PY{n}{COLOR\PYZus{}BGR2RGB}\PY{p}{)}
          
          \PY{c+c1}{\PYZsh{} Display the image}
          \PY{n}{fig} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{figsize} \PY{o}{=} \PY{p}{(}\PY{l+m+mi}{6}\PY{p}{,}\PY{l+m+mi}{6}\PY{p}{)}\PY{p}{)}
          \PY{n}{ax1} \PY{o}{=} \PY{n}{fig}\PY{o}{.}\PY{n}{add\PYZus{}subplot}\PY{p}{(}\PY{l+m+mi}{111}\PY{p}{)}
          \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}xticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{)}
          \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}yticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{)}
          \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Original Image}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
          \PY{n}{ax1}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{image}\PY{p}{)}
\end{Verbatim}


\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}131}]:} <matplotlib.image.AxesImage at 0x1700401b0b8>
\end{Verbatim}
            
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_41_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \subsubsection{(IMPLEMENTATION) Use blurring to hide the identity of an
individual in an
image}\label{implementation-use-blurring-to-hide-the-identity-of-an-individual-in-an-image}

The idea here is to 1) automatically detect the face in this image, and
then 2) blur it out! Make sure to adjust the parameters of the
\emph{averaging} blur filter to completely obscure this person's
identity.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}144}]:} \PY{c+c1}{\PYZsh{}\PYZsh{} TODO: Implement face detection}
          \PY{n}{image\PYZus{}with\PYZus{}blur\PYZus{}face} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{copy}\PY{p}{(}\PY{n}{image}\PY{p}{)}\PY{c+c1}{\PYZsh{}saved to used later after we detect the faces}
          
          \PY{c+c1}{\PYZsh{}image = cv2.cvtColor(image, cv2.COLOR\PYZus{}RGB2BGR)}
          \PY{n}{gray} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{cvtColor}\PY{p}{(}\PY{n}{image}\PY{p}{,} \PY{n}{cv2}\PY{o}{.}\PY{n}{COLOR\PYZus{}RGB2GRAY}\PY{p}{)}
          \PY{n}{face\PYZus{}cascade} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{CascadeClassifier}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{detector\PYZus{}architectures/haarcascade\PYZus{}frontalface\PYZus{}default.xml}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
          
          \PY{c+c1}{\PYZsh{} Detect the faces in image}
          \PY{n}{faces} \PY{o}{=} \PY{n}{face\PYZus{}cascade}\PY{o}{.}\PY{n}{detectMultiScale}\PY{p}{(}\PY{n}{gray}\PY{p}{,} \PY{l+m+mf}{1.13}\PY{p}{,} \PY{l+m+mi}{6}\PY{p}{)}
          
          \PY{c+c1}{\PYZsh{} Using averaging blur filter}
          \PY{n}{kernel} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{ones}\PY{p}{(}\PY{p}{(}\PY{l+m+mi}{80}\PY{p}{,} \PY{l+m+mi}{80}\PY{p}{)}\PY{p}{,}\PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{)} \PY{o}{/} \PY{l+m+mi}{6400}
              
          \PY{c+c1}{\PYZsh{}\PYZsh{} TODO: Blur the bounding box around each detected face using an averaging filter and display the result}
          \PY{k}{for} \PY{p}{(}\PY{n}{x}\PY{p}{,}\PY{n}{y}\PY{p}{,}\PY{n}{w}\PY{p}{,}\PY{n}{h}\PY{p}{)} \PY{o+ow}{in} \PY{n}{faces}\PY{p}{:}
              \PY{k}{if}\PY{p}{(}\PY{n}{w} \PY{o}{\PYZlt{}} \PY{l+m+mi}{100}\PY{p}{)} \PY{o}{|} \PY{p}{(}\PY{n}{h} \PY{o}{\PYZlt{}} \PY{l+m+mi}{100}\PY{p}{)}\PY{p}{:}\PY{c+c1}{\PYZsh{} Too small \PYZhy{} filtering mistakes}
                  \PY{k}{continue}  
              \PY{c+c1}{\PYZsh{} Blur bounding box to the detections image}
              \PY{n}{image\PYZus{}with\PYZus{}blur\PYZus{}face}\PY{p}{[}\PY{n}{y}\PY{p}{:}\PY{n}{y}\PY{o}{+}\PY{n}{h}\PY{p}{,} \PY{n}{x}\PY{p}{:}\PY{n}{x}\PY{o}{+}\PY{n}{w}\PY{p}{]} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{filter2D}\PY{p}{(}\PY{n}{image\PYZus{}with\PYZus{}blur\PYZus{}face}\PY{p}{[}\PY{n}{y}\PY{p}{:}\PY{n}{y}\PY{o}{+}\PY{n}{h}\PY{p}{,} \PY{n}{x}\PY{p}{:}\PY{n}{x}\PY{o}{+}\PY{n}{w}\PY{p}{]}\PY{p}{,} \PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{kernel}\PY{p}{)}
            
          \PY{c+c1}{\PYZsh{} Display the image}
          \PY{n}{fig} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{figsize} \PY{o}{=} \PY{p}{(}\PY{l+m+mi}{6}\PY{p}{,}\PY{l+m+mi}{6}\PY{p}{)}\PY{p}{)}
          \PY{n}{ax1} \PY{o}{=} \PY{n}{fig}\PY{o}{.}\PY{n}{add\PYZus{}subplot}\PY{p}{(}\PY{l+m+mi}{111}\PY{p}{)}
          \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}xticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{)}
          \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}yticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{)}
          \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Image with blur face}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
          \PY{n}{ax1}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{image\PYZus{}with\PYZus{}blur\PYZus{}face}\PY{p}{)}
\end{Verbatim}


\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}144}]:} <matplotlib.image.AxesImage at 0x17000da0dd8>
\end{Verbatim}
            
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_43_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \subsubsection{(Optional) Build identity protection into your laptop
camera}\label{optional-build-identity-protection-into-your-laptop-camera}

In this optional task you can add identity protection to your laptop
camera, using the previously completed code where you added face
detection to your laptop camera - and the task above. You should be able
to get reasonable results with little parameter tuning - like the one
shown in the gif below.

As with the previous video task, to make this perfect would require
significant effort - so don't strive for perfection here, strive for
reasonable quality.

The next cell contains code a wrapper function called
\texttt{laptop\_camera\_identity\_hider} that - when called - will
activate your laptop's camera. You need to place the relevant face
detection and blurring code developed above in this function in order to
blur faces entering your laptop camera's field of view.

Before adding anything to the function you can call it to get a hang of
how it works - a small window will pop up showing you the live feed from
your camera, you can press any key to close this window.

\textbf{Note:} Mac users may find that activating this function kills
the kernel of their notebook every once in a while. If this happens to
you, just restart your notebook's kernel, activate cell(s) containing
any crucial import statements, and you'll be good to go!

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}3}]:} \PY{c+c1}{\PYZsh{}\PYZsh{}\PYZsh{} Insert face detection and blurring code into the wrapper below to create an identity protector on your laptop!}
        \PY{k+kn}{import} \PY{n+nn}{cv2}
        \PY{k+kn}{import} \PY{n+nn}{time} 
        
        \PY{k}{def} \PY{n+nf}{laptop\PYZus{}camera\PYZus{}go}\PY{p}{(}\PY{p}{)}\PY{p}{:}
            \PY{c+c1}{\PYZsh{} Create instance of video capturer}
            \PY{n}{cv2}\PY{o}{.}\PY{n}{namedWindow}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{face detection activated}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
            \PY{n}{vc} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{VideoCapture}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{)}  \PY{c+c1}{\PYZsh{}I have 2 cameras}
        
            \PY{c+c1}{\PYZsh{} Try to get the first frame}
            \PY{k}{if} \PY{n}{vc}\PY{o}{.}\PY{n}{isOpened}\PY{p}{(}\PY{p}{)}\PY{p}{:} 
                \PY{n}{rval}\PY{p}{,} \PY{n}{frame} \PY{o}{=} \PY{n}{vc}\PY{o}{.}\PY{n}{read}\PY{p}{(}\PY{p}{)}
            \PY{k}{else}\PY{p}{:}
                \PY{n}{rval} \PY{o}{=} \PY{k+kc}{False}
            
            \PY{n}{face\PYZus{}cascade} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{CascadeClassifier}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{detector\PYZus{}architectures/haarcascade\PYZus{}frontalface\PYZus{}default.xml}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
            \PY{c+c1}{\PYZsh{} Using averaging blur filter}
            \PY{n}{kernel} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{ones}\PY{p}{(}\PY{p}{(}\PY{l+m+mi}{80}\PY{p}{,} \PY{l+m+mi}{80}\PY{p}{)}\PY{p}{,}\PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{)} \PY{o}{/} \PY{l+m+mi}{6400}
                
            \PY{c+c1}{\PYZsh{} Keep video stream open}
            \PY{k}{while} \PY{n}{rval}\PY{p}{:}
                \PY{n}{gray} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{cvtColor}\PY{p}{(}\PY{n}{frame}\PY{p}{,} \PY{n}{cv2}\PY{o}{.}\PY{n}{COLOR\PYZus{}RGB2GRAY}\PY{p}{)}
                
                \PY{c+c1}{\PYZsh{} Detect the faces in image}
                \PY{n}{faces} \PY{o}{=} \PY{n}{face\PYZus{}cascade}\PY{o}{.}\PY{n}{detectMultiScale}\PY{p}{(}\PY{n}{gray}\PY{p}{,} \PY{l+m+mf}{1.13}\PY{p}{,} \PY{l+m+mi}{6}\PY{p}{)}
        
                \PY{c+c1}{\PYZsh{}\PYZsh{} TODO: Blur the bounding box around each detected face using an averaging filter and display the result}
                \PY{k}{for} \PY{p}{(}\PY{n}{x}\PY{p}{,}\PY{n}{y}\PY{p}{,}\PY{n}{w}\PY{p}{,}\PY{n}{h}\PY{p}{)} \PY{o+ow}{in} \PY{n}{faces}\PY{p}{:}
                    \PY{k}{if}\PY{p}{(}\PY{n}{w} \PY{o}{\PYZlt{}} \PY{l+m+mi}{100}\PY{p}{)} \PY{o}{|} \PY{p}{(}\PY{n}{h} \PY{o}{\PYZlt{}} \PY{l+m+mi}{100}\PY{p}{)}\PY{p}{:}\PY{c+c1}{\PYZsh{} Too small \PYZhy{} filtering mistakes}
                        \PY{k}{continue}  
                    \PY{c+c1}{\PYZsh{} Blur bounding box to the detections image}
                    \PY{n}{frame}\PY{p}{[}\PY{n}{y}\PY{p}{:}\PY{n}{y}\PY{o}{+}\PY{n}{h}\PY{p}{,} \PY{n}{x}\PY{p}{:}\PY{n}{x}\PY{o}{+}\PY{n}{w}\PY{p}{]} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{filter2D}\PY{p}{(}\PY{n}{frame}\PY{p}{[}\PY{n}{y}\PY{p}{:}\PY{n}{y}\PY{o}{+}\PY{n}{h}\PY{p}{,} \PY{n}{x}\PY{p}{:}\PY{n}{x}\PY{o}{+}\PY{n}{w}\PY{p}{]}\PY{p}{,} \PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{kernel}\PY{p}{)}
                    
                \PY{c+c1}{\PYZsh{} Plot image from camera with detections marked}
                \PY{n}{cv2}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{face detection activated}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{n}{frame}\PY{p}{)}
        
                \PY{c+c1}{\PYZsh{} Exit functionality \PYZhy{} press any key to exit laptop video}
                \PY{n}{key} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{waitKey}\PY{p}{(}\PY{l+m+mi}{20}\PY{p}{)}
                \PY{k}{if} \PY{n}{key} \PY{o}{\PYZgt{}} \PY{l+m+mi}{0}\PY{p}{:} \PY{c+c1}{\PYZsh{} Exit by pressing any key}
                    \PY{c+c1}{\PYZsh{} Destroy windows}
                    \PY{n}{cv2}\PY{o}{.}\PY{n}{destroyAllWindows}\PY{p}{(}\PY{p}{)}
                    
                    \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range} \PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,}\PY{l+m+mi}{5}\PY{p}{)}\PY{p}{:}
                        \PY{n}{cv2}\PY{o}{.}\PY{n}{waitKey}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{)}
                    \PY{k}{return}
                
                \PY{c+c1}{\PYZsh{} Read next frame}
                \PY{n}{time}\PY{o}{.}\PY{n}{sleep}\PY{p}{(}\PY{l+m+mf}{0.05}\PY{p}{)}             \PY{c+c1}{\PYZsh{} control framerate for computation \PYZhy{} default 20 frames per sec}
                \PY{n}{rval}\PY{p}{,} \PY{n}{frame} \PY{o}{=} \PY{n}{vc}\PY{o}{.}\PY{n}{read}\PY{p}{(}\PY{p}{)}    
                
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}6}]:} \PY{c+c1}{\PYZsh{} Run laptop identity hider}
        \PY{n}{laptop\PYZus{}camera\PYZus{}go}\PY{p}{(}\PY{p}{)}
\end{Verbatim}


    \begin{center}\rule{0.5\linewidth}{\linethickness}\end{center}

\subsection{Step 5: Create a CNN to Recognize Facial
Keypoints}\label{step-5-create-a-cnn-to-recognize-facial-keypoints}

OpenCV is often used in practice with other machine learning and deep
learning libraries to produce interesting results. In this stage of the
project you will create your own end-to-end pipeline - employing
convolutional networks in keras along with OpenCV - to apply a "selfie"
filter to streaming video and images.

You will start by creating and then training a convolutional network
that can detect facial keypoints in a small dataset of cropped images of
human faces. We then guide you towards OpenCV to expanding your
detection algorithm to more general images. What are facial keypoints?
Let's take a look at some examples.

Facial keypoints (also called facial landmarks) are the small blue-green
dots shown on each of the faces in the image above - there are 15
keypoints marked in each image.

They mark important areas of the face - the eyes, corners of the mouth,
the nose, etc.

Facial keypoints can be used in a variety of machine learning
applications from face and emotion recognition to commercial
applications like the image filters popularized by Snapchat.

Below we illustrate a filter that, using the results of this section,
automatically places sunglasses on people in images (using the facial
keypoints to place the glasses correctly on each face).

Here, the facial keypoints have been colored lime green for
visualization purposes.

    \subsubsection{Make a facial keypoint
detector}\label{make-a-facial-keypoint-detector}

But first things first: how can we make a facial keypoint detector?
Well, at a high level, notice that facial keypoint detection is a
\emph{regression problem}.

A single face corresponds to a set of 15 facial keypoints (a set of 15
corresponding \((x, y)\) coordinates, i.e., an output point).

Because our input data are images, we can employ a \emph{convolutional
neural network} to recognize patterns in our images and learn how to
identify these keypoint given sets of labeled data.

In order to train a regressor, we need a training set - a set of facial
image / facial keypoint pairs to train on. For this we will be using
\href{https://www.kaggle.com/c/facial-keypoints-detection/data}{this
dataset from Kaggle}. We've already downloaded this data and placed it
in the \texttt{data} directory.

Make sure that you have both the \emph{training} and \emph{test} data
files.

The training dataset contains several thousand \(96 \times 96\)
grayscale images of cropped human faces, along with each face's 15
corresponding facial keypoints (also called landmarks) that have been
placed by hand, and recorded in \((x, y)\) coordinates.

This wonderful resource also has a substantial testing set, which we
will use in tinkering with our convolutional network.

To load in this data, run the Python cell below - notice we will load in
both the training and testing sets.

The \texttt{load\_data} function is in the included \texttt{utils.py}
file.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}2}]:} \PY{k+kn}{from} \PY{n+nn}{utils} \PY{k}{import} \PY{o}{*}
        
        \PY{c+c1}{\PYZsh{} Load training set}
        \PY{n}{X\PYZus{}train}\PY{p}{,} \PY{n}{y\PYZus{}train} \PY{o}{=} \PY{n}{load\PYZus{}data}\PY{p}{(}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{X\PYZus{}train.shape == }\PY{l+s+si}{\PYZob{}\PYZcb{}}\PY{l+s+s2}{\PYZdq{}}\PY{o}{.}\PY{n}{format}\PY{p}{(}\PY{n}{X\PYZus{}train}\PY{o}{.}\PY{n}{shape}\PY{p}{)}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{y\PYZus{}train.shape == }\PY{l+s+si}{\PYZob{}\PYZcb{}}\PY{l+s+s2}{; y\PYZus{}train.min == }\PY{l+s+si}{\PYZob{}:.3f\PYZcb{}}\PY{l+s+s2}{; y\PYZus{}train.max == }\PY{l+s+si}{\PYZob{}:.3f\PYZcb{}}\PY{l+s+s2}{\PYZdq{}}\PY{o}{.}\PY{n}{format}\PY{p}{(}
            \PY{n}{y\PYZus{}train}\PY{o}{.}\PY{n}{shape}\PY{p}{,} \PY{n}{y\PYZus{}train}\PY{o}{.}\PY{n}{min}\PY{p}{(}\PY{p}{)}\PY{p}{,} \PY{n}{y\PYZus{}train}\PY{o}{.}\PY{n}{max}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}
        
        \PY{c+c1}{\PYZsh{} Load testing set}
        \PY{n}{X\PYZus{}test}\PY{p}{,} \PY{n}{\PYZus{}} \PY{o}{=} \PY{n}{load\PYZus{}data}\PY{p}{(}\PY{n}{test}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{X\PYZus{}test.shape == }\PY{l+s+si}{\PYZob{}\PYZcb{}}\PY{l+s+s2}{\PYZdq{}}\PY{o}{.}\PY{n}{format}\PY{p}{(}\PY{n}{X\PYZus{}test}\PY{o}{.}\PY{n}{shape}\PY{p}{)}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
Using TensorFlow backend.

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
X\_train.shape == (2140, 96, 96, 1)
y\_train.shape == (2140, 30); y\_train.min == -0.920; y\_train.max == 0.996
X\_test.shape == (1783, 96, 96, 1)

    \end{Verbatim}

    The \texttt{load\_data} function in \texttt{utils.py} originates from
this excellent
\href{http://danielnouri.org/notes/2014/12/17/using-convolutional-neural-nets-to-detect-facial-keypoints-tutorial/}{blog
post}, which you are \emph{strongly} encouraged to read. Please take the
time now to review this function.

Note how the output values - that is, the coordinates of each set of
facial landmarks - have been normalized to take on values in the range
\([-1, 1]\), while the pixel values of each input point (a facial image)
have been normalized to the range \([0,1]\).

\textbf{Note}: The original Kaggle dataset contains some images with
several missing keypoints.

For simplicity, the \texttt{load\_data} function removes those images
with missing labels from the dataset.

As an \textbf{\emph{optional}} extension, you are welcome to amend the
\texttt{load\_data} function to include the incomplete data points.

    \subsubsection{Visualize the Training
Data}\label{visualize-the-training-data}

Execute the code cell below to visualize a subset of the training data.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}3}]:} \PY{k+kn}{import} \PY{n+nn}{matplotlib}\PY{n+nn}{.}\PY{n+nn}{pyplot} \PY{k}{as} \PY{n+nn}{plt}
        \PY{o}{\PYZpc{}}\PY{k}{matplotlib} inline
        
        \PY{n}{fig} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{figsize}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{20}\PY{p}{,}\PY{l+m+mi}{20}\PY{p}{)}\PY{p}{)}
        \PY{n}{fig}\PY{o}{.}\PY{n}{subplots\PYZus{}adjust}\PY{p}{(}\PY{n}{left}\PY{o}{=}\PY{l+m+mi}{0}\PY{p}{,} \PY{n}{right}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{bottom}\PY{o}{=}\PY{l+m+mi}{0}\PY{p}{,} \PY{n}{top}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{hspace}\PY{o}{=}\PY{l+m+mf}{0.05}\PY{p}{,} \PY{n}{wspace}\PY{o}{=}\PY{l+m+mf}{0.05}\PY{p}{)}
        \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{l+m+mi}{9}\PY{p}{)}\PY{p}{:}
            \PY{n}{ax} \PY{o}{=} \PY{n}{fig}\PY{o}{.}\PY{n}{add\PYZus{}subplot}\PY{p}{(}\PY{l+m+mi}{3}\PY{p}{,} \PY{l+m+mi}{3}\PY{p}{,} \PY{n}{i} \PY{o}{+} \PY{l+m+mi}{1}\PY{p}{,} \PY{n}{xticks}\PY{o}{=}\PY{p}{[}\PY{p}{]}\PY{p}{,} \PY{n}{yticks}\PY{o}{=}\PY{p}{[}\PY{p}{]}\PY{p}{)}
            \PY{n}{plot\PYZus{}data}\PY{p}{(}\PY{n}{X\PYZus{}train}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,} \PY{n}{y\PYZus{}train}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,} \PY{n}{ax}\PY{p}{)}
\end{Verbatim}


    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_52_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    For each training image, there are two landmarks per eyebrow
(\textbf{four} total), three per eye (\textbf{six} total), \textbf{four}
for the mouth, and \textbf{one} for the tip of the nose.

Review the \texttt{plot\_data} function in \texttt{utils.py} to
understand how the 30-dimensional training labels in \texttt{y\_train}
are mapped to facial locations, as this function will prove useful for
your pipeline.

    \subsubsection{(IMPLEMENTATION) Specify the CNN
Architecture}\label{implementation-specify-the-cnn-architecture}

In this section, you will specify a neural network for predicting the
locations of facial keypoints. Use the code cell below to specify the
architecture of your neural network.

We have imported some layers that you may find useful for this task, but
if you need to use more Keras layers, feel free to import them in the
cell.

Your network should accept a \(96 \times 96\) grayscale image as input,
and it should output a vector with 30 entries, corresponding to the
predicted (horizontal and vertical) locations of 15 facial keypoints.

If you are not sure where to start, you can find some useful starting
architectures in
\href{http://danielnouri.org/notes/2014/12/17/using-convolutional-neural-nets-to-detect-facial-keypoints-tutorial/}{this
blog}, but you are not permitted to copy any of the architectures that
you find online.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}37}]:} \PY{c+c1}{\PYZsh{} Import deep learning resources from Keras}
         \PY{k+kn}{from} \PY{n+nn}{keras}\PY{n+nn}{.}\PY{n+nn}{models} \PY{k}{import} \PY{n}{Sequential}
         \PY{k+kn}{from} \PY{n+nn}{keras}\PY{n+nn}{.}\PY{n+nn}{layers} \PY{k}{import} \PY{n}{Convolution2D}\PY{p}{,} \PY{n}{MaxPooling2D}\PY{p}{,} \PY{n}{Dropout}
         \PY{k+kn}{from} \PY{n+nn}{keras}\PY{n+nn}{.}\PY{n+nn}{layers} \PY{k}{import} \PY{n}{Flatten}\PY{p}{,} \PY{n}{Dense}\PY{p}{,} \PY{n}{GlobalAveragePooling2D}
         
         
         \PY{c+c1}{\PYZsh{}\PYZsh{} TODO: Specify a CNN architecture}
         \PY{c+c1}{\PYZsh{} Your model should accept 96x96 pixel graysale images in}
         \PY{c+c1}{\PYZsh{} It should have a fully\PYZhy{}connected output layer with 30 values (2 for each facial keypoint)}
         
         
         \PY{n}{model} \PY{o}{=} \PY{n}{Sequential}\PY{p}{(}\PY{p}{)}
         
         \PY{l+s+sd}{\PYZsq{}\PYZsq{}\PYZsq{}}
         \PY{l+s+sd}{I Started with 32 filters and after it, I\PYZsq{}ll give the model more and more filters,}
         \PY{l+s+sd}{from my experience, most of the times the best way is to start with 16 filters or 32 filters.}
         \PY{l+s+sd}{I\PYZsq{}m using the most popular and recommended activation function \PYZsq{}relu\PYZsq{} and padding=\PYZsq{}same\PYZsq{} so we won\PYZsq{}t lose important data,}
         \PY{l+s+sd}{though in this case, it seems that the data on the edges is less important than the center, so it may be less important.}
         \PY{l+s+sd}{I give it kernel\PYZus{}size of 3, since from my experience its best to be set to 2 or 3,}
         \PY{l+s+sd}{so I start with 3 on the first layer and will change it to 2 on the others where I\PYZsq{}ll have smaller width and height input.}
         \PY{l+s+sd}{\PYZsq{}\PYZsq{}\PYZsq{}}
         \PY{n}{model}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{Convolution2D}\PY{p}{(}\PY{n}{filters}\PY{o}{=}\PY{l+m+mi}{32}\PY{p}{,} \PY{n}{kernel\PYZus{}size}\PY{o}{=}\PY{l+m+mi}{3}\PY{p}{,} \PY{n}{padding}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{valid}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} 
                                 \PY{n}{input\PYZus{}shape}\PY{o}{=}\PY{n}{X\PYZus{}train}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{:}\PY{p}{]}\PY{p}{)}\PY{p}{)}
         
         \PY{l+s+sd}{\PYZsq{}\PYZsq{}\PYZsq{}}
         \PY{l+s+sd}{After each convolution layer I added a pooling layer, it will progressively reduce the spatial size of the representation,}
         \PY{l+s+sd}{and reduce the number of parameters and amount of computation so it gives us the ability to increase the filters count}
         \PY{l+s+sd}{without having too many parameters, and it also helps to control overfitting.}
         \PY{l+s+sd}{I\PYZsq{}m using the MaxPooling2D with pool\PYZus{}size=2 which is most common and recommended.}
         \PY{l+s+sd}{\PYZsq{}\PYZsq{}\PYZsq{}}
         \PY{n}{model}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{MaxPooling2D}\PY{p}{(}\PY{n}{pool\PYZus{}size}\PY{o}{=}\PY{l+m+mi}{2}\PY{p}{)}\PY{p}{)}
         
         \PY{l+s+sd}{\PYZsq{}\PYZsq{}\PYZsq{}}
         \PY{l+s+sd}{After each convolution layer, I\PYZsq{}m also Using Dropout in order to reduce even more the number of parameters}
         \PY{l+s+sd}{and amount of computation and helps to control overfitting.}
         \PY{l+s+sd}{\PYZsq{}\PYZsq{}\PYZsq{}}
         \PY{n}{model}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{Dropout}\PY{p}{(}\PY{l+m+mf}{0.3}\PY{p}{)}\PY{p}{)}
         
         \PY{n}{model}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{Convolution2D}\PY{p}{(}\PY{n}{filters}\PY{o}{=}\PY{l+m+mi}{64}\PY{p}{,} \PY{n}{kernel\PYZus{}size}\PY{o}{=}\PY{l+m+mi}{2}\PY{p}{,} \PY{n}{padding}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{same}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{)}
         \PY{n}{model}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{MaxPooling2D}\PY{p}{(}\PY{n}{pool\PYZus{}size}\PY{o}{=}\PY{l+m+mi}{2}\PY{p}{)}\PY{p}{)}
         \PY{n}{model}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{Dropout}\PY{p}{(}\PY{l+m+mf}{0.3}\PY{p}{)}\PY{p}{)}
         
         \PY{n}{model}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{Convolution2D}\PY{p}{(}\PY{n}{filters}\PY{o}{=}\PY{l+m+mi}{128}\PY{p}{,} \PY{n}{kernel\PYZus{}size}\PY{o}{=}\PY{l+m+mi}{2}\PY{p}{,} \PY{n}{padding}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{same}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{)}
         \PY{n}{model}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{MaxPooling2D}\PY{p}{(}\PY{n}{pool\PYZus{}size}\PY{o}{=}\PY{l+m+mi}{2}\PY{p}{)}\PY{p}{)}
         \PY{n}{model}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{Dropout}\PY{p}{(}\PY{l+m+mf}{0.2}\PY{p}{)}\PY{p}{)}
         
         \PY{n}{model}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{Convolution2D}\PY{p}{(}\PY{n}{filters}\PY{o}{=}\PY{l+m+mi}{256}\PY{p}{,} \PY{n}{kernel\PYZus{}size}\PY{o}{=}\PY{l+m+mi}{2}\PY{p}{,} \PY{n}{padding}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{same}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{)}
         \PY{n}{model}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{MaxPooling2D}\PY{p}{(}\PY{n}{pool\PYZus{}size}\PY{o}{=}\PY{l+m+mi}{2}\PY{p}{)}\PY{p}{)}
         \PY{n}{model}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{Dropout}\PY{p}{(}\PY{l+m+mf}{0.2}\PY{p}{)}\PY{p}{)}
         
         \PY{n}{model}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{Convolution2D}\PY{p}{(}\PY{n}{filters}\PY{o}{=}\PY{l+m+mi}{512}\PY{p}{,} \PY{n}{kernel\PYZus{}size}\PY{o}{=}\PY{l+m+mi}{2}\PY{p}{,} \PY{n}{padding}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{same}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{activation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relu}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{)}
         \PY{n}{model}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{MaxPooling2D}\PY{p}{(}\PY{n}{pool\PYZus{}size}\PY{o}{=}\PY{l+m+mi}{2}\PY{p}{)}\PY{p}{)}
         \PY{n}{model}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{Dropout}\PY{p}{(}\PY{l+m+mf}{0.2}\PY{p}{)}\PY{p}{)}
         
         \PY{l+s+sd}{\PYZsq{}\PYZsq{}\PYZsq{}}
         \PY{l+s+sd}{After all those layers I Added GlobalAveragePooling2D layer, doing it like in the ResNet\PYZhy{}50 model (http://ethereon.github.io/netscope/\PYZsh{}/gist/db945b393d40bfa26006)}
         \PY{l+s+sd}{it enforces correspondence between feature maps and categories, and also global average pooling is a structural regularizer,}
         \PY{l+s+sd}{which natively prevents overfitting for the overall structure (I get my knowledge from this paper: http://arxiv.org/pdf/1312.4400.pdf).}
         \PY{l+s+sd}{\PYZsq{}\PYZsq{}\PYZsq{}}
         \PY{n}{model}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{GlobalAveragePooling2D}\PY{p}{(}\PY{p}{)}\PY{p}{)}
         
         \PY{l+s+sd}{\PYZsq{}\PYZsq{}\PYZsq{}}
         \PY{l+s+sd}{Finally I added a dense layer with output of 30 that will represent the 15 key points (15 for x + 15 for y),}
         \PY{l+s+sd}{and as activation I used the linear activation, I could use tanh activation cause it gives values between \PYZhy{}1 to 1 }
         \PY{l+s+sd}{but it may act less linear around the 0 and since we have linear problem,}
         \PY{l+s+sd}{we better to used linear activation which means adding no activation at keras.}
         \PY{l+s+sd}{\PYZsq{}\PYZsq{}\PYZsq{}}
         \PY{n}{model}\PY{o}{.}\PY{n}{add}\PY{p}{(}\PY{n}{Dense}\PY{p}{(}\PY{l+m+mi}{30}\PY{p}{)}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} Summarize the model}
         \PY{n}{model}\PY{o}{.}\PY{n}{summary}\PY{p}{(}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
Layer (type)                 Output Shape              Param \#   
=================================================================
conv2d\_63 (Conv2D)           (None, 94, 94, 32)        320       
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
max\_pooling2d\_63 (MaxPooling (None, 47, 47, 32)        0         
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dropout\_64 (Dropout)         (None, 47, 47, 32)        0         
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
conv2d\_64 (Conv2D)           (None, 47, 47, 64)        8256      
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
max\_pooling2d\_64 (MaxPooling (None, 23, 23, 64)        0         
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dropout\_65 (Dropout)         (None, 23, 23, 64)        0         
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
conv2d\_65 (Conv2D)           (None, 23, 23, 128)       32896     
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
max\_pooling2d\_65 (MaxPooling (None, 11, 11, 128)       0         
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dropout\_66 (Dropout)         (None, 11, 11, 128)       0         
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
conv2d\_66 (Conv2D)           (None, 11, 11, 256)       131328    
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
max\_pooling2d\_66 (MaxPooling (None, 5, 5, 256)         0         
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dropout\_67 (Dropout)         (None, 5, 5, 256)         0         
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
conv2d\_67 (Conv2D)           (None, 5, 5, 512)         524800    
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
max\_pooling2d\_67 (MaxPooling (None, 2, 2, 512)         0         
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dropout\_68 (Dropout)         (None, 2, 2, 512)         0         
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
global\_average\_pooling2d\_14  (None, 512)               0         
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
dense\_15 (Dense)             (None, 30)                15390     
=================================================================
Total params: 712,990
Trainable params: 712,990
Non-trainable params: 0
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_

    \end{Verbatim}

    \begin{center}\rule{0.5\linewidth}{\linethickness}\end{center}

\subsection{Step 6: Compile and Train the
Model}\label{step-6-compile-and-train-the-model}

After specifying your architecture, you'll need to compile and train the
model to detect facial keypoints'

    \subsubsection{(IMPLEMENTATION) Compile and Train the
Model}\label{implementation-compile-and-train-the-model}

Use the \texttt{compile}
\href{https://keras.io/models/sequential/\#sequential-model-methods}{method}
to configure the learning process. Experiment with your choice of
\href{https://keras.io/optimizers/}{optimizer}; you may have some ideas
about which will work best (\texttt{SGD} vs. \texttt{RMSprop}, etc), but
take the time to empirically verify your theories.

Use the \texttt{fit}
\href{https://keras.io/models/sequential/\#sequential-model-methods}{method}
to train the model. Break off a validation set by setting
\texttt{validation\_split=0.2}. Save the returned \texttt{History}
object in the \texttt{history} variable.

Your model is required to attain a validation loss (measured as mean
squared error) of at least \textbf{XYZ}. When you have finished
training,
\href{https://keras.io/getting-started/faq/\#how-can-i-save-a-keras-model}{save
your model} as an HDF5 file with file path \texttt{my\_model.h5}.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}38}]:} \PY{k+kn}{from} \PY{n+nn}{keras}\PY{n+nn}{.}\PY{n+nn}{optimizers} \PY{k}{import} \PY{n}{SGD}\PY{p}{,} \PY{n}{RMSprop}\PY{p}{,} \PY{n}{Adagrad}\PY{p}{,} \PY{n}{Adadelta}\PY{p}{,} \PY{n}{Adam}\PY{p}{,} \PY{n}{Adamax}\PY{p}{,} \PY{n}{Nadam}
         \PY{k+kn}{from} \PY{n+nn}{keras}\PY{n+nn}{.}\PY{n+nn}{callbacks} \PY{k}{import} \PY{n}{ModelCheckpoint} 
         
         \PY{c+c1}{\PYZsh{}\PYZsh{} TODO: Compile the model}
         \PY{n}{model}\PY{o}{.}\PY{n}{compile}\PY{p}{(}\PY{n}{optimizer}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Adamax}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{loss}\PY{o}{=}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{mean\PYZus{}squared\PYZus{}error}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{n}{metrics}\PY{o}{=}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{accuracy}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{}\PYZsh{} TODO: Save the model as model.h5}
         \PY{c+c1}{\PYZsh{} Saving the best model}
         \PY{n}{checkpointer} \PY{o}{=} \PY{n}{ModelCheckpoint}\PY{p}{(}\PY{n}{filepath}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{my\PYZus{}model.h5}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} 
                                        \PY{n}{verbose}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{save\PYZus{}best\PYZus{}only}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{}\PYZsh{} TODO: Train the model}
         \PY{n}{hist} \PY{o}{=} \PY{n}{model}\PY{o}{.}\PY{n}{fit}\PY{p}{(}\PY{n}{X\PYZus{}train}\PY{p}{,} \PY{n}{y\PYZus{}train}\PY{p}{,} \PY{n}{batch\PYZus{}size}\PY{o}{=}\PY{l+m+mi}{32}\PY{p}{,} \PY{n}{epochs}\PY{o}{=}\PY{l+m+mi}{250}\PY{p}{,} \PY{n}{verbose}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{,} 
                   \PY{n}{validation\PYZus{}split}\PY{o}{=}\PY{l+m+mf}{0.2}\PY{p}{,} \PY{n}{callbacks}\PY{o}{=}\PY{p}{[}\PY{n}{checkpointer}\PY{p}{]}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
Train on 1712 samples, validate on 428 samples
Epoch 1/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0157 - acc: 0.6256Epoch 00000: val\_loss improved from inf to 0.03979, saving model to my\_model.h5
1712/1712 [==============================] - 3s - loss: 0.0156 - acc: 0.6256 - val\_loss: 0.0398 - val\_acc: 0.6963
Epoch 2/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0057 - acc: 0.6692Epoch 00001: val\_loss improved from 0.03979 to 0.03489, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 0.0057 - acc: 0.6694 - val\_loss: 0.0349 - val\_acc: 0.6963
Epoch 3/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0054 - acc: 0.6869Epoch 00002: val\_loss improved from 0.03489 to 0.02944, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 0.0054 - acc: 0.6857 - val\_loss: 0.0294 - val\_acc: 0.6963
Epoch 4/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0052 - acc: 0.6834Epoch 00003: val\_loss improved from 0.02944 to 0.02760, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 0.0052 - acc: 0.6828 - val\_loss: 0.0276 - val\_acc: 0.6963
Epoch 5/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0051 - acc: 0.6875Epoch 00004: val\_loss improved from 0.02760 to 0.02187, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 0.0051 - acc: 0.6857 - val\_loss: 0.0219 - val\_acc: 0.6963
Epoch 6/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0051 - acc: 0.6940Epoch 00005: val\_loss improved from 0.02187 to 0.02090, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 0.0051 - acc: 0.6933 - val\_loss: 0.0209 - val\_acc: 0.6963
Epoch 7/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0050 - acc: 0.6922Epoch 00006: val\_loss improved from 0.02090 to 0.01796, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 0.0050 - acc: 0.6939 - val\_loss: 0.0180 - val\_acc: 0.6963
Epoch 8/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0050 - acc: 0.6958Epoch 00007: val\_loss improved from 0.01796 to 0.01757, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 0.0050 - acc: 0.6957 - val\_loss: 0.0176 - val\_acc: 0.6963
Epoch 9/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0048 - acc: 0.6975Epoch 00008: val\_loss improved from 0.01757 to 0.01625, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 0.0048 - acc: 0.6992 - val\_loss: 0.0162 - val\_acc: 0.6963
Epoch 10/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0048 - acc: 0.7022Epoch 00009: val\_loss improved from 0.01625 to 0.01406, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 0.0048 - acc: 0.7033 - val\_loss: 0.0141 - val\_acc: 0.6963
Epoch 11/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0048 - acc: 0.7005Epoch 00010: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 0.0048 - acc: 0.6998 - val\_loss: 0.0156 - val\_acc: 0.6963
Epoch 12/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0048 - acc: 0.7052Epoch 00011: val\_loss improved from 0.01406 to 0.01393, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 0.0048 - acc: 0.7039 - val\_loss: 0.0139 - val\_acc: 0.6963
Epoch 13/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0048 - acc: 0.7017Epoch 00012: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 0.0048 - acc: 0.7015 - val\_loss: 0.0156 - val\_acc: 0.6963
Epoch 14/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0048 - acc: 0.7022- ETA: 1s - loEpoch 00013: val\_loss improved from 0.01393 to 0.01332, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 0.0048 - acc: 0.7015 - val\_loss: 0.0133 - val\_acc: 0.6963
Epoch 15/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0047 - acc: 0.7022Epoch 00014: val\_loss improved from 0.01332 to 0.01103, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 0.0047 - acc: 0.7004 - val\_loss: 0.0110 - val\_acc: 0.6963
Epoch 16/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0047 - acc: 0.6969Epoch 00015: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 0.0048 - acc: 0.6974 - val\_loss: 0.0125 - val\_acc: 0.6963
Epoch 17/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0046 - acc: 0.7046Epoch 00016: val\_loss improved from 0.01103 to 0.01036, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 0.0046 - acc: 0.7050 - val\_loss: 0.0104 - val\_acc: 0.6963
Epoch 18/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0046 - acc: 0.7081Epoch 00017: val\_loss improved from 0.01036 to 0.00996, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 0.0047 - acc: 0.7068 - val\_loss: 0.0100 - val\_acc: 0.6963
Epoch 19/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0047 - acc: 0.7017Epoch 00018: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 0.0047 - acc: 0.7039 - val\_loss: 0.0103 - val\_acc: 0.6963
Epoch 20/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0046 - acc: 0.7040Epoch 00019: val\_loss improved from 0.00996 to 0.00834, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 0.0046 - acc: 0.7027 - val\_loss: 0.0083 - val\_acc: 0.6963
Epoch 21/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0046 - acc: 0.7070Epoch 00020: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 0.0046 - acc: 0.7079 - val\_loss: 0.0101 - val\_acc: 0.6963
Epoch 22/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0045 - acc: 0.7046- ETA: 1s - loEpoch 00021: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 0.0045 - acc: 0.7044 - val\_loss: 0.0097 - val\_acc: 0.6963
Epoch 23/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0045 - acc: 0.7046Epoch 00022: val\_loss improved from 0.00834 to 0.00784, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 0.0045 - acc: 0.7044 - val\_loss: 0.0078 - val\_acc: 0.6963
Epoch 24/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0045 - acc: 0.7058Epoch 00023: val\_loss improved from 0.00784 to 0.00716, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 0.0045 - acc: 0.7062 - val\_loss: 0.0072 - val\_acc: 0.6963
Epoch 25/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0044 - acc: 0.7070Epoch 00024: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 0.0044 - acc: 0.7068 - val\_loss: 0.0075 - val\_acc: 0.6963
Epoch 26/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0042 - acc: 0.7046Epoch 00025: val\_loss improved from 0.00716 to 0.00689, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 0.0042 - acc: 0.7033 - val\_loss: 0.0069 - val\_acc: 0.6986
Epoch 27/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0042 - acc: 0.7017Epoch 00026: val\_loss improved from 0.00689 to 0.00642, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 0.0042 - acc: 0.7015 - val\_loss: 0.0064 - val\_acc: 0.6986
Epoch 28/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0042 - acc: 0.7011Epoch 00027: val\_loss improved from 0.00642 to 0.00620, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 0.0042 - acc: 0.7027 - val\_loss: 0.0062 - val\_acc: 0.6986
Epoch 29/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0041 - acc: 0.7075Epoch 00028: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 0.0041 - acc: 0.7074 - val\_loss: 0.0067 - val\_acc: 0.6986
Epoch 30/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0040 - acc: 0.7070Epoch 00029: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 0.0040 - acc: 0.7085 - val\_loss: 0.0067 - val\_acc: 0.7009
Epoch 31/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0039 - acc: 0.7058Epoch 00030: val\_loss improved from 0.00620 to 0.00615, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 0.0039 - acc: 0.7056 - val\_loss: 0.0062 - val\_acc: 0.7009
Epoch 32/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0038 - acc: 0.7087Epoch 00031: val\_loss improved from 0.00615 to 0.00597, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 0.0037 - acc: 0.7091 - val\_loss: 0.0060 - val\_acc: 0.7056
Epoch 33/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0037 - acc: 0.7040Epoch 00032: val\_loss improved from 0.00597 to 0.00521, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 0.0037 - acc: 0.7044 - val\_loss: 0.0052 - val\_acc: 0.7056
Epoch 34/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0036 - acc: 0.7005Epoch 00033: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 0.0036 - acc: 0.7021 - val\_loss: 0.0053 - val\_acc: 0.7033
Epoch 35/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0035 - acc: 0.7040Epoch 00034: val\_loss improved from 0.00521 to 0.00492, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 0.0035 - acc: 0.7056 - val\_loss: 0.0049 - val\_acc: 0.7150
Epoch 36/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0034 - acc: 0.7081- ETA: 1s - loEpoch 00035: val\_loss improved from 0.00492 to 0.00480, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 0.0034 - acc: 0.7074 - val\_loss: 0.0048 - val\_acc: 0.7056
Epoch 37/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0033 - acc: 0.7093Epoch 00036: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 0.0033 - acc: 0.7085 - val\_loss: 0.0055 - val\_acc: 0.7033
Epoch 38/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0031 - acc: 0.7005Epoch 00037: val\_loss improved from 0.00480 to 0.00469, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 0.0032 - acc: 0.7004 - val\_loss: 0.0047 - val\_acc: 0.7243
Epoch 39/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0031 - acc: 0.7075Epoch 00038: val\_loss improved from 0.00469 to 0.00346, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 0.0031 - acc: 0.7085 - val\_loss: 0.0035 - val\_acc: 0.7126
Epoch 40/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0031 - acc: 0.7075Epoch 00039: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 0.0031 - acc: 0.7074 - val\_loss: 0.0057 - val\_acc: 0.7079
Epoch 41/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0030 - acc: 0.7123Epoch 00040: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 0.0030 - acc: 0.7126 - val\_loss: 0.0038 - val\_acc: 0.7079
Epoch 42/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0029 - acc: 0.7123Epoch 00041: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 0.0029 - acc: 0.7120 - val\_loss: 0.0046 - val\_acc: 0.7150
Epoch 43/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0028 - acc: 0.7188Epoch 00042: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 0.0028 - acc: 0.7185 - val\_loss: 0.0043 - val\_acc: 0.7103
Epoch 44/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0028 - acc: 0.7070Epoch 00043: val\_loss improved from 0.00346 to 0.00340, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 0.0027 - acc: 0.7056 - val\_loss: 0.0034 - val\_acc: 0.7150
Epoch 45/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0026 - acc: 0.7188Epoch 00044: val\_loss improved from 0.00340 to 0.00324, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 0.0026 - acc: 0.7190 - val\_loss: 0.0032 - val\_acc: 0.7150
Epoch 46/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0026 - acc: 0.7158Epoch 00045: val\_loss improved from 0.00324 to 0.00247, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 0.0026 - acc: 0.7161 - val\_loss: 0.0025 - val\_acc: 0.7173
Epoch 47/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0025 - acc: 0.7123Epoch 00046: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 0.0025 - acc: 0.7109 - val\_loss: 0.0027 - val\_acc: 0.7266
Epoch 48/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0025 - acc: 0.7146Epoch 00047: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 0.0025 - acc: 0.7120 - val\_loss: 0.0035 - val\_acc: 0.7196
Epoch 49/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0024 - acc: 0.7134Epoch 00048: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 0.0024 - acc: 0.7138 - val\_loss: 0.0028 - val\_acc: 0.7290
Epoch 50/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0023 - acc: 0.7193Epoch 00049: val\_loss improved from 0.00247 to 0.00243, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 0.0023 - acc: 0.7190 - val\_loss: 0.0024 - val\_acc: 0.7290
Epoch 51/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0022 - acc: 0.7270Epoch 00050: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 0.0022 - acc: 0.7266 - val\_loss: 0.0025 - val\_acc: 0.7313
Epoch 52/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0021 - acc: 0.7105Epoch 00051: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 0.0022 - acc: 0.7097 - val\_loss: 0.0026 - val\_acc: 0.7336
Epoch 53/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0021 - acc: 0.7241Epoch 00052: val\_loss improved from 0.00243 to 0.00219, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 0.0021 - acc: 0.7237 - val\_loss: 0.0022 - val\_acc: 0.7360
Epoch 54/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0020 - acc: 0.7294Epoch 00053: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 0.0020 - acc: 0.7296 - val\_loss: 0.0026 - val\_acc: 0.7266
Epoch 55/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0020 - acc: 0.7294Epoch 00054: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 0.0020 - acc: 0.7296 - val\_loss: 0.0026 - val\_acc: 0.7407
Epoch 56/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0020 - acc: 0.7453Epoch 00055: val\_loss improved from 0.00219 to 0.00202, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 0.0020 - acc: 0.7459 - val\_loss: 0.0020 - val\_acc: 0.7407
Epoch 57/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0019 - acc: 0.7471Epoch 00056: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 0.0019 - acc: 0.7482 - val\_loss: 0.0022 - val\_acc: 0.7407
Epoch 58/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0019 - acc: 0.7323Epoch 00057: val\_loss improved from 0.00202 to 0.00172, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 0.0019 - acc: 0.7336 - val\_loss: 0.0017 - val\_acc: 0.7430
Epoch 59/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0019 - acc: 0.7465Epoch 00058: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 0.0018 - acc: 0.7471 - val\_loss: 0.0020 - val\_acc: 0.7407
Epoch 60/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0018 - acc: 0.7529Epoch 00059: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 0.0018 - acc: 0.7535 - val\_loss: 0.0018 - val\_acc: 0.7430
Epoch 61/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0018 - acc: 0.7305- ETA: 1s - loEpoch 00060: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 0.0018 - acc: 0.7290 - val\_loss: 0.0017 - val\_acc: 0.7453
Epoch 62/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0017 - acc: 0.7500Epoch 00061: val\_loss improved from 0.00172 to 0.00170, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 0.0017 - acc: 0.7488 - val\_loss: 0.0017 - val\_acc: 0.7383
Epoch 63/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0016 - acc: 0.7565- ETA: 1s - loEpoch 00062: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 0.0016 - acc: 0.7576 - val\_loss: 0.0019 - val\_acc: 0.7430
Epoch 64/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0017 - acc: 0.7518Epoch 00063: val\_loss improved from 0.00170 to 0.00164, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 0.0017 - acc: 0.7518 - val\_loss: 0.0016 - val\_acc: 0.7710
Epoch 65/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0016 - acc: 0.7500Epoch 00064: val\_loss improved from 0.00164 to 0.00158, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 0.0016 - acc: 0.7512 - val\_loss: 0.0016 - val\_acc: 0.7477
Epoch 66/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0015 - acc: 0.7653Epoch 00065: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 0.0015 - acc: 0.7658 - val\_loss: 0.0017 - val\_acc: 0.7383
Epoch 67/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0015 - acc: 0.7659Epoch 00066: val\_loss improved from 0.00158 to 0.00149, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 0.0015 - acc: 0.7658 - val\_loss: 0.0015 - val\_acc: 0.7407
Epoch 68/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0015 - acc: 0.7624Epoch 00067: val\_loss improved from 0.00149 to 0.00147, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 0.0015 - acc: 0.7623 - val\_loss: 0.0015 - val\_acc: 0.7453
Epoch 69/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0015 - acc: 0.7742Epoch 00068: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 0.0015 - acc: 0.7745 - val\_loss: 0.0017 - val\_acc: 0.7757
Epoch 70/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0014 - acc: 0.7630Epoch 00069: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 0.0014 - acc: 0.7640 - val\_loss: 0.0018 - val\_acc: 0.7617
Epoch 71/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0014 - acc: 0.7594Epoch 00070: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 0.0014 - acc: 0.7582 - val\_loss: 0.0016 - val\_acc: 0.7523
Epoch 72/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0014 - acc: 0.7695Epoch 00071: val\_loss improved from 0.00147 to 0.00142, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 0.0014 - acc: 0.7704 - val\_loss: 0.0014 - val\_acc: 0.7827
Epoch 73/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0014 - acc: 0.7777Epoch 00072: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 0.0014 - acc: 0.7780 - val\_loss: 0.0016 - val\_acc: 0.7407
Epoch 74/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0013 - acc: 0.7730Epoch 00073: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 0.0013 - acc: 0.7739 - val\_loss: 0.0016 - val\_acc: 0.7780
Epoch 75/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0014 - acc: 0.7889Epoch 00074: val\_loss improved from 0.00142 to 0.00138, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 0.0013 - acc: 0.7891 - val\_loss: 0.0014 - val\_acc: 0.7804
Epoch 76/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0013 - acc: 0.7824Epoch 00075: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 0.0013 - acc: 0.7833 - val\_loss: 0.0015 - val\_acc: 0.7734
Epoch 77/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0013 - acc: 0.7871Epoch 00076: val\_loss improved from 0.00138 to 0.00135, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 0.0013 - acc: 0.7880 - val\_loss: 0.0014 - val\_acc: 0.7593
Epoch 78/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0012 - acc: 0.7883Epoch 00077: val\_loss improved from 0.00135 to 0.00135, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 0.0012 - acc: 0.7886 - val\_loss: 0.0014 - val\_acc: 0.7804
Epoch 79/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0012 - acc: 0.7954Epoch 00078: val\_loss improved from 0.00135 to 0.00127, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 0.0012 - acc: 0.7956 - val\_loss: 0.0013 - val\_acc: 0.7757
Epoch 80/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0012 - acc: 0.7895Epoch 00079: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 0.0012 - acc: 0.7897 - val\_loss: 0.0014 - val\_acc: 0.7874
Epoch 81/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0011 - acc: 0.7759Epoch 00080: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 0.0011 - acc: 0.7751 - val\_loss: 0.0014 - val\_acc: 0.7874
Epoch 82/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0012 - acc: 0.8031Epoch 00081: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 0.0012 - acc: 0.8026 - val\_loss: 0.0015 - val\_acc: 0.7640
Epoch 83/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0011 - acc: 0.7983Epoch 00082: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 0.0011 - acc: 0.7979 - val\_loss: 0.0013 - val\_acc: 0.7710
Epoch 84/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0011 - acc: 0.8013Epoch 00083: val\_loss improved from 0.00127 to 0.00120, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 0.0011 - acc: 0.8014 - val\_loss: 0.0012 - val\_acc: 0.7804
Epoch 85/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0011 - acc: 0.7978Epoch 00084: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 0.0011 - acc: 0.7956 - val\_loss: 0.0013 - val\_acc: 0.7804
Epoch 86/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0011 - acc: 0.8001Epoch 00085: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 0.0011 - acc: 0.8014 - val\_loss: 0.0013 - val\_acc: 0.7991
Epoch 87/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0010 - acc: 0.8096Epoch 00086: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 0.0010 - acc: 0.8090 - val\_loss: 0.0015 - val\_acc: 0.7640
Epoch 88/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0011 - acc: 0.7919Epoch 00087: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 0.0010 - acc: 0.7921 - val\_loss: 0.0014 - val\_acc: 0.7850
Epoch 89/250
1696/1712 [============================>.] - ETA: 0s - loss: 9.7636e-04 - acc: 0.8072Epoch 00088: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 9.7677e-04 - acc: 0.8049 - val\_loss: 0.0015 - val\_acc: 0.7921
Epoch 90/250
1696/1712 [============================>.] - ETA: 0s - loss: 0.0010 - acc: 0.8078Epoch 00089: val\_loss improved from 0.00120 to 0.00117, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 0.0010 - acc: 0.8084 - val\_loss: 0.0012 - val\_acc: 0.7804
Epoch 91/250
1696/1712 [============================>.] - ETA: 0s - loss: 9.8118e-04 - acc: 0.7995Epoch 00090: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 9.8068e-04 - acc: 0.7991 - val\_loss: 0.0013 - val\_acc: 0.7967
Epoch 92/250
1696/1712 [============================>.] - ETA: 0s - loss: 9.6269e-04 - acc: 0.8078Epoch 00091: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 9.6644e-04 - acc: 0.8067 - val\_loss: 0.0013 - val\_acc: 0.7710
Epoch 93/250
1696/1712 [============================>.] - ETA: 0s - loss: 9.6356e-04 - acc: 0.8125Epoch 00092: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 9.6291e-04 - acc: 0.8119 - val\_loss: 0.0013 - val\_acc: 0.8107
Epoch 94/250
1696/1712 [============================>.] - ETA: 0s - loss: 9.2515e-04 - acc: 0.8125Epoch 00093: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 9.2550e-04 - acc: 0.8125 - val\_loss: 0.0012 - val\_acc: 0.7967
Epoch 95/250
1696/1712 [============================>.] - ETA: 0s - loss: 9.4007e-04 - acc: 0.8060Epoch 00094: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 9.4056e-04 - acc: 0.8061 - val\_loss: 0.0012 - val\_acc: 0.7827
Epoch 96/250
1696/1712 [============================>.] - ETA: 0s - loss: 9.1136e-04 - acc: 0.8154Epoch 00095: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 9.1193e-04 - acc: 0.8166 - val\_loss: 0.0012 - val\_acc: 0.8037
Epoch 97/250
1696/1712 [============================>.] - ETA: 0s - loss: 9.0370e-04 - acc: 0.8154Epoch 00096: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 9.0698e-04 - acc: 0.8160 - val\_loss: 0.0012 - val\_acc: 0.7991
Epoch 98/250
1696/1712 [============================>.] - ETA: 0s - loss: 8.7748e-04 - acc: 0.8131Epoch 00097: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 8.8062e-04 - acc: 0.8131 - val\_loss: 0.0014 - val\_acc: 0.8037
Epoch 99/250
1696/1712 [============================>.] - ETA: 0s - loss: 8.7297e-04 - acc: 0.8267Epoch 00098: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 8.7481e-04 - acc: 0.8265 - val\_loss: 0.0012 - val\_acc: 0.7897
Epoch 100/250
1696/1712 [============================>.] - ETA: 0s - loss: 8.5665e-04 - acc: 0.8196Epoch 00099: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 8.5505e-04 - acc: 0.8183 - val\_loss: 0.0012 - val\_acc: 0.7921
Epoch 101/250
1696/1712 [============================>.] - ETA: 0s - loss: 8.4212e-04 - acc: 0.8143Epoch 00100: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 8.4365e-04 - acc: 0.8148 - val\_loss: 0.0012 - val\_acc: 0.7991
Epoch 102/250
1696/1712 [============================>.] - ETA: 0s - loss: 8.9007e-04 - acc: 0.8090Epoch 00101: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 8.8985e-04 - acc: 0.8090 - val\_loss: 0.0012 - val\_acc: 0.8037
Epoch 103/250
1696/1712 [============================>.] - ETA: 0s - loss: 8.2839e-04 - acc: 0.8202Epoch 00102: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 8.2898e-04 - acc: 0.8218 - val\_loss: 0.0012 - val\_acc: 0.8084
Epoch 104/250
1696/1712 [============================>.] - ETA: 0s - loss: 8.1150e-04 - acc: 0.8231Epoch 00103: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 8.1034e-04 - acc: 0.8230 - val\_loss: 0.0016 - val\_acc: 0.7991
Epoch 105/250
1696/1712 [============================>.] - ETA: 0s - loss: 7.9819e-04 - acc: 0.8296Epoch 00104: val\_loss improved from 0.00117 to 0.00112, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 7.9863e-04 - acc: 0.8294 - val\_loss: 0.0011 - val\_acc: 0.7991
Epoch 106/250
1696/1712 [============================>.] - ETA: 0s - loss: 7.8724e-04 - acc: 0.8290Epoch 00105: val\_loss improved from 0.00112 to 0.00109, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 7.9044e-04 - acc: 0.8294 - val\_loss: 0.0011 - val\_acc: 0.8084
Epoch 107/250
1696/1712 [============================>.] - ETA: 0s - loss: 7.8913e-04 - acc: 0.8202Epoch 00106: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 7.8787e-04 - acc: 0.8207 - val\_loss: 0.0013 - val\_acc: 0.7991
Epoch 108/250
1696/1712 [============================>.] - ETA: 0s - loss: 7.6621e-04 - acc: 0.8190Epoch 00107: val\_loss improved from 0.00109 to 0.00105, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 7.6492e-04 - acc: 0.8195 - val\_loss: 0.0011 - val\_acc: 0.8084
Epoch 109/250
1696/1712 [============================>.] - ETA: 0s - loss: 7.7169e-04 - acc: 0.8219Epoch 00108: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 7.7386e-04 - acc: 0.8224 - val\_loss: 0.0012 - val\_acc: 0.8037
Epoch 110/250
1696/1712 [============================>.] - ETA: 0s - loss: 7.4755e-04 - acc: 0.8337Epoch 00109: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 7.4568e-04 - acc: 0.8353 - val\_loss: 0.0012 - val\_acc: 0.7967
Epoch 111/250
1696/1712 [============================>.] - ETA: 0s - loss: 7.5370e-04 - acc: 0.8219Epoch 00110: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 7.5185e-04 - acc: 0.8218 - val\_loss: 0.0012 - val\_acc: 0.8084
Epoch 112/250
1696/1712 [============================>.] - ETA: 0s - loss: 7.3208e-04 - acc: 0.8367Epoch 00111: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 7.3219e-04 - acc: 0.8370 - val\_loss: 0.0011 - val\_acc: 0.8014
Epoch 113/250
1696/1712 [============================>.] - ETA: 0s - loss: 7.2422e-04 - acc: 0.8290Epoch 00112: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 7.2303e-04 - acc: 0.8289 - val\_loss: 0.0012 - val\_acc: 0.8084
Epoch 114/250
1696/1712 [============================>.] - ETA: 0s - loss: 7.3284e-04 - acc: 0.8337Epoch 00113: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 7.3196e-04 - acc: 0.8335 - val\_loss: 0.0011 - val\_acc: 0.8014
Epoch 115/250
1696/1712 [============================>.] - ETA: 0s - loss: 7.4091e-04 - acc: 0.8208Epoch 00114: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 7.4200e-04 - acc: 0.8195 - val\_loss: 0.0012 - val\_acc: 0.8341
Epoch 116/250
1696/1712 [============================>.] - ETA: 0s - loss: 7.1885e-04 - acc: 0.8261Epoch 00115: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 7.2039e-04 - acc: 0.8242 - val\_loss: 0.0014 - val\_acc: 0.7991
Epoch 117/250
1696/1712 [============================>.] - ETA: 0s - loss: 7.0644e-04 - acc: 0.8367Epoch 00116: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 7.0619e-04 - acc: 0.8376 - val\_loss: 0.0013 - val\_acc: 0.8154
Epoch 118/250
1696/1712 [============================>.] - ETA: 0s - loss: 6.9974e-04 - acc: 0.8402Epoch 00117: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 6.9905e-04 - acc: 0.8400 - val\_loss: 0.0011 - val\_acc: 0.8084
Epoch 119/250
1696/1712 [============================>.] - ETA: 0s - loss: 6.8687e-04 - acc: 0.8443Epoch 00118: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 6.8591e-04 - acc: 0.8458 - val\_loss: 0.0012 - val\_acc: 0.8178
Epoch 120/250
1696/1712 [============================>.] - ETA: 0s - loss: 6.8883e-04 - acc: 0.8438Epoch 00119: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 6.8853e-04 - acc: 0.8423 - val\_loss: 0.0011 - val\_acc: 0.8178
Epoch 121/250
1696/1712 [============================>.] - ETA: 0s - loss: 6.7621e-04 - acc: 0.8479Epoch 00120: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 6.7653e-04 - acc: 0.8470 - val\_loss: 0.0012 - val\_acc: 0.7967
Epoch 122/250
1696/1712 [============================>.] - ETA: 0s - loss: 6.8789e-04 - acc: 0.8396Epoch 00121: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 6.8805e-04 - acc: 0.8394 - val\_loss: 0.0013 - val\_acc: 0.8014
Epoch 123/250
1696/1712 [============================>.] - ETA: 0s - loss: 6.5338e-04 - acc: 0.8296Epoch 00122: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 6.5390e-04 - acc: 0.8300 - val\_loss: 0.0011 - val\_acc: 0.7991
Epoch 124/250
1696/1712 [============================>.] - ETA: 0s - loss: 6.4966e-04 - acc: 0.8426Epoch 00123: val\_loss improved from 0.00105 to 0.00105, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 6.5091e-04 - acc: 0.8423 - val\_loss: 0.0011 - val\_acc: 0.8154
Epoch 125/250
1696/1712 [============================>.] - ETA: 0s - loss: 6.4407e-04 - acc: 0.8591Epoch 00124: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 6.4233e-04 - acc: 0.8592 - val\_loss: 0.0012 - val\_acc: 0.8201
Epoch 126/250
1696/1712 [============================>.] - ETA: 0s - loss: 6.2937e-04 - acc: 0.8420Epoch 00125: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 6.3148e-04 - acc: 0.8435 - val\_loss: 0.0011 - val\_acc: 0.8201
Epoch 127/250
1696/1712 [============================>.] - ETA: 0s - loss: 6.6334e-04 - acc: 0.8414Epoch 00126: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 6.6330e-04 - acc: 0.8417 - val\_loss: 0.0012 - val\_acc: 0.8154
Epoch 128/250
1696/1712 [============================>.] - ETA: 0s - loss: 6.2335e-04 - acc: 0.8491Epoch 00127: val\_loss improved from 0.00105 to 0.00104, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 6.2336e-04 - acc: 0.8481 - val\_loss: 0.0010 - val\_acc: 0.8037
Epoch 129/250
1696/1712 [============================>.] - ETA: 0s - loss: 6.3130e-04 - acc: 0.8461Epoch 00128: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 6.3132e-04 - acc: 0.8464 - val\_loss: 0.0013 - val\_acc: 0.8248
Epoch 130/250
1696/1712 [============================>.] - ETA: 0s - loss: 6.0648e-04 - acc: 0.8402Epoch 00129: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 6.0590e-04 - acc: 0.8405 - val\_loss: 0.0011 - val\_acc: 0.8037
Epoch 131/250
1696/1712 [============================>.] - ETA: 0s - loss: 6.1192e-04 - acc: 0.8508Epoch 00130: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 6.1096e-04 - acc: 0.8516 - val\_loss: 0.0012 - val\_acc: 0.8271
Epoch 132/250
1696/1712 [============================>.] - ETA: 0s - loss: 6.1121e-04 - acc: 0.8514Epoch 00131: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 6.1168e-04 - acc: 0.8516 - val\_loss: 0.0012 - val\_acc: 0.8154
Epoch 133/250
1696/1712 [============================>.] - ETA: 0s - loss: 6.1041e-04 - acc: 0.8485Epoch 00132: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 6.1049e-04 - acc: 0.8464 - val\_loss: 0.0011 - val\_acc: 0.8178
Epoch 134/250
1696/1712 [============================>.] - ETA: 0s - loss: 5.9823e-04 - acc: 0.8331Epoch 00133: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 5.9987e-04 - acc: 0.8347 - val\_loss: 0.0012 - val\_acc: 0.8131
Epoch 135/250
1696/1712 [============================>.] - ETA: 0s - loss: 5.8305e-04 - acc: 0.8461Epoch 00134: val\_loss improved from 0.00104 to 0.00101, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 5.8349e-04 - acc: 0.8464 - val\_loss: 0.0010 - val\_acc: 0.8154
Epoch 136/250
1696/1712 [============================>.] - ETA: 0s - loss: 6.0350e-04 - acc: 0.8496Epoch 00135: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 6.0212e-04 - acc: 0.8493 - val\_loss: 0.0011 - val\_acc: 0.8107
Epoch 137/250
1696/1712 [============================>.] - ETA: 0s - loss: 5.8441e-04 - acc: 0.8367Epoch 00136: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 5.8385e-04 - acc: 0.8364 - val\_loss: 0.0012 - val\_acc: 0.8037
Epoch 138/250
1696/1712 [============================>.] - ETA: 0s - loss: 5.6725e-04 - acc: 0.8561Epoch 00137: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 5.6910e-04 - acc: 0.8557 - val\_loss: 0.0011 - val\_acc: 0.8084
Epoch 139/250
1696/1712 [============================>.] - ETA: 0s - loss: 5.5963e-04 - acc: 0.8426Epoch 00138: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 5.6017e-04 - acc: 0.8417 - val\_loss: 0.0011 - val\_acc: 0.8201
Epoch 140/250
1696/1712 [============================>.] - ETA: 0s - loss: 5.6860e-04 - acc: 0.8614Epoch 00139: val\_loss improved from 0.00101 to 0.00100, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 5.6842e-04 - acc: 0.8604 - val\_loss: 9.9596e-04 - val\_acc: 0.8084
Epoch 141/250
1696/1712 [============================>.] - ETA: 0s - loss: 5.7707e-04 - acc: 0.8461Epoch 00140: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 5.7652e-04 - acc: 0.8464 - val\_loss: 0.0011 - val\_acc: 0.8084
Epoch 142/250
1696/1712 [============================>.] - ETA: 0s - loss: 5.6506e-04 - acc: 0.8479Epoch 00141: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 5.6523e-04 - acc: 0.8475 - val\_loss: 0.0011 - val\_acc: 0.8224
Epoch 143/250
1696/1712 [============================>.] - ETA: 0s - loss: 5.5393e-04 - acc: 0.8485Epoch 00142: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 5.5529e-04 - acc: 0.8493 - val\_loss: 0.0013 - val\_acc: 0.8201
Epoch 144/250
1696/1712 [============================>.] - ETA: 0s - loss: 5.6804e-04 - acc: 0.8550Epoch 00143: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 5.6791e-04 - acc: 0.8557 - val\_loss: 0.0012 - val\_acc: 0.8248
Epoch 145/250
1696/1712 [============================>.] - ETA: 0s - loss: 5.4601e-04 - acc: 0.8496Epoch 00144: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 5.4490e-04 - acc: 0.8511 - val\_loss: 0.0011 - val\_acc: 0.8224
Epoch 146/250
1696/1712 [============================>.] - ETA: 0s - loss: 5.4020e-04 - acc: 0.8514Epoch 00145: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 5.4003e-04 - acc: 0.8516 - val\_loss: 0.0012 - val\_acc: 0.8271
Epoch 147/250
1696/1712 [============================>.] - ETA: 0s - loss: 5.3797e-04 - acc: 0.8479Epoch 00146: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 5.3797e-04 - acc: 0.8470 - val\_loss: 0.0011 - val\_acc: 0.8107
Epoch 148/250
1696/1712 [============================>.] - ETA: 0s - loss: 5.3872e-04 - acc: 0.8561Epoch 00147: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 5.3760e-04 - acc: 0.8569 - val\_loss: 0.0010 - val\_acc: 0.8061
Epoch 149/250
1696/1712 [============================>.] - ETA: 0s - loss: 5.5181e-04 - acc: 0.8650Epoch 00148: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 5.5098e-04 - acc: 0.8662 - val\_loss: 0.0010 - val\_acc: 0.8224
Epoch 150/250
1696/1712 [============================>.] - ETA: 0s - loss: 5.4196e-04 - acc: 0.8620Epoch 00149: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 5.4174e-04 - acc: 0.8633 - val\_loss: 0.0011 - val\_acc: 0.8131
Epoch 151/250
1696/1712 [============================>.] - ETA: 0s - loss: 5.3019e-04 - acc: 0.8396Epoch 00150: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 5.3064e-04 - acc: 0.8411 - val\_loss: 0.0013 - val\_acc: 0.8318
Epoch 152/250
1696/1712 [============================>.] - ETA: 0s - loss: 5.3489e-04 - acc: 0.8626Epoch 00151: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 5.3499e-04 - acc: 0.8627 - val\_loss: 0.0011 - val\_acc: 0.8178
Epoch 153/250
1696/1712 [============================>.] - ETA: 0s - loss: 5.3890e-04 - acc: 0.8597Epoch 00152: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 5.3784e-04 - acc: 0.8598 - val\_loss: 0.0011 - val\_acc: 0.8107
Epoch 154/250
1696/1712 [============================>.] - ETA: 0s - loss: 5.1566e-04 - acc: 0.8526Epoch 00153: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 5.1664e-04 - acc: 0.8528 - val\_loss: 0.0011 - val\_acc: 0.8061
Epoch 155/250
1696/1712 [============================>.] - ETA: 0s - loss: 5.1104e-04 - acc: 0.8644Epoch 00154: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 5.1076e-04 - acc: 0.8639 - val\_loss: 0.0011 - val\_acc: 0.8084
Epoch 156/250
1696/1712 [============================>.] - ETA: 0s - loss: 5.0305e-04 - acc: 0.8620Epoch 00155: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 5.0359e-04 - acc: 0.8604 - val\_loss: 0.0011 - val\_acc: 0.8131
Epoch 157/250
1696/1712 [============================>.] - ETA: 0s - loss: 5.0012e-04 - acc: 0.8644Epoch 00156: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 4.9999e-04 - acc: 0.8639 - val\_loss: 0.0011 - val\_acc: 0.8318
Epoch 158/250
1696/1712 [============================>.] - ETA: 0s - loss: 4.9200e-04 - acc: 0.8526Epoch 00157: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 4.9225e-04 - acc: 0.8522 - val\_loss: 0.0011 - val\_acc: 0.8201
Epoch 159/250
1696/1712 [============================>.] - ETA: 0s - loss: 5.0561e-04 - acc: 0.8597Epoch 00158: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 5.0629e-04 - acc: 0.8581 - val\_loss: 0.0011 - val\_acc: 0.8271
Epoch 160/250
1696/1712 [============================>.] - ETA: 0s - loss: 4.9514e-04 - acc: 0.8603Epoch 00159: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 4.9615e-04 - acc: 0.8610 - val\_loss: 0.0011 - val\_acc: 0.8037
Epoch 161/250
1696/1712 [============================>.] - ETA: 0s - loss: 4.9047e-04 - acc: 0.8561Epoch 00160: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 4.9062e-04 - acc: 0.8569 - val\_loss: 0.0012 - val\_acc: 0.7921
Epoch 162/250
1696/1712 [============================>.] - ETA: 0s - loss: 4.8630e-04 - acc: 0.8555Epoch 00161: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 4.8497e-04 - acc: 0.8563 - val\_loss: 0.0011 - val\_acc: 0.8131
Epoch 163/250
1696/1712 [============================>.] - ETA: 0s - loss: 4.8479e-04 - acc: 0.8520- ETA: 1s - loss: Epoch 00162: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 4.8386e-04 - acc: 0.8511 - val\_loss: 0.0011 - val\_acc: 0.8154
Epoch 164/250
1696/1712 [============================>.] - ETA: 0s - loss: 4.9327e-04 - acc: 0.8597Epoch 00163: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 4.9228e-04 - acc: 0.8592 - val\_loss: 0.0011 - val\_acc: 0.8224
Epoch 165/250
1696/1712 [============================>.] - ETA: 0s - loss: 4.7668e-04 - acc: 0.8779Epoch 00164: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 4.7576e-04 - acc: 0.8785 - val\_loss: 0.0012 - val\_acc: 0.8178
Epoch 166/250
1696/1712 [============================>.] - ETA: 0s - loss: 4.7451e-04 - acc: 0.8650Epoch 00165: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 4.7486e-04 - acc: 0.8645 - val\_loss: 0.0010 - val\_acc: 0.8201
Epoch 167/250
1696/1712 [============================>.] - ETA: 0s - loss: 4.9378e-04 - acc: 0.8656- ETA: 1s - loss: Epoch 00166: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 4.9443e-04 - acc: 0.8662 - val\_loss: 0.0011 - val\_acc: 0.8061
Epoch 168/250
1696/1712 [============================>.] - ETA: 0s - loss: 4.9534e-04 - acc: 0.8667- ETA: 1s - loss: Epoch 00167: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 4.9654e-04 - acc: 0.8645 - val\_loss: 0.0010 - val\_acc: 0.8248
Epoch 169/250
1696/1712 [============================>.] - ETA: 0s - loss: 4.6790e-04 - acc: 0.8667Epoch 00168: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 4.6906e-04 - acc: 0.8680 - val\_loss: 0.0011 - val\_acc: 0.8154
Epoch 170/250
1696/1712 [============================>.] - ETA: 0s - loss: 4.6703e-04 - acc: 0.8614Epoch 00169: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 4.6723e-04 - acc: 0.8616 - val\_loss: 0.0013 - val\_acc: 0.8318
Epoch 171/250
1696/1712 [============================>.] - ETA: 0s - loss: 4.6634e-04 - acc: 0.8608Epoch 00170: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 4.6632e-04 - acc: 0.8598 - val\_loss: 0.0011 - val\_acc: 0.8107
Epoch 172/250
1696/1712 [============================>.] - ETA: 0s - loss: 4.6368e-04 - acc: 0.8567Epoch 00171: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 4.6419e-04 - acc: 0.8569 - val\_loss: 0.0011 - val\_acc: 0.8271
Epoch 173/250
1696/1712 [============================>.] - ETA: 0s - loss: 4.5236e-04 - acc: 0.8715Epoch 00172: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 4.5260e-04 - acc: 0.8709 - val\_loss: 0.0011 - val\_acc: 0.8154
Epoch 174/250
1696/1712 [============================>.] - ETA: 0s - loss: 4.3699e-04 - acc: 0.8768- ETA: 1s - loss: Epoch 00173: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 4.3729e-04 - acc: 0.8762 - val\_loss: 0.0010 - val\_acc: 0.8131
Epoch 175/250
1696/1712 [============================>.] - ETA: 0s - loss: 4.6360e-04 - acc: 0.8608Epoch 00174: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 4.6398e-04 - acc: 0.8616 - val\_loss: 0.0010 - val\_acc: 0.8341
Epoch 176/250
1696/1712 [============================>.] - ETA: 0s - loss: 4.4670e-04 - acc: 0.8626- ETA: 1s - loss: Epoch 00175: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 4.4676e-04 - acc: 0.8639 - val\_loss: 0.0011 - val\_acc: 0.8318
Epoch 177/250
1696/1712 [============================>.] - ETA: 0s - loss: 4.4963e-04 - acc: 0.8656Epoch 00176: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 4.4862e-04 - acc: 0.8645 - val\_loss: 0.0010 - val\_acc: 0.8271
Epoch 178/250
1696/1712 [============================>.] - ETA: 0s - loss: 4.4375e-04 - acc: 0.8608Epoch 00177: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 4.4422e-04 - acc: 0.8616 - val\_loss: 0.0010 - val\_acc: 0.8131
Epoch 179/250
1696/1712 [============================>.] - ETA: 0s - loss: 4.6594e-04 - acc: 0.8691Epoch 00178: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 4.6575e-04 - acc: 0.8703 - val\_loss: 0.0012 - val\_acc: 0.8131
Epoch 180/250
1696/1712 [============================>.] - ETA: 0s - loss: 4.5423e-04 - acc: 0.8561Epoch 00179: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 4.5532e-04 - acc: 0.8563 - val\_loss: 0.0010 - val\_acc: 0.8248
Epoch 181/250
1696/1712 [============================>.] - ETA: 0s - loss: 4.5370e-04 - acc: 0.8756Epoch 00180: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 4.5432e-04 - acc: 0.8762 - val\_loss: 0.0011 - val\_acc: 0.8458
Epoch 182/250
1696/1712 [============================>.] - ETA: 0s - loss: 4.3490e-04 - acc: 0.8650Epoch 00181: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 4.3459e-04 - acc: 0.8662 - val\_loss: 0.0011 - val\_acc: 0.8388
Epoch 183/250
1696/1712 [============================>.] - ETA: 0s - loss: 4.3170e-04 - acc: 0.8768Epoch 00182: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 4.3215e-04 - acc: 0.8768 - val\_loss: 0.0011 - val\_acc: 0.8364
Epoch 184/250
1696/1712 [============================>.] - ETA: 0s - loss: 4.3165e-04 - acc: 0.8709Epoch 00183: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 4.3197e-04 - acc: 0.8721 - val\_loss: 0.0010 - val\_acc: 0.8364
Epoch 185/250
1696/1712 [============================>.] - ETA: 0s - loss: 4.4969e-04 - acc: 0.8691Epoch 00184: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 4.4892e-04 - acc: 0.8703 - val\_loss: 9.9813e-04 - val\_acc: 0.8318
Epoch 186/250
1696/1712 [============================>.] - ETA: 0s - loss: 4.3572e-04 - acc: 0.8762Epoch 00185: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 4.3574e-04 - acc: 0.8768 - val\_loss: 0.0010 - val\_acc: 0.8341
Epoch 187/250
1696/1712 [============================>.] - ETA: 0s - loss: 4.2297e-04 - acc: 0.8644Epoch 00186: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 4.2296e-04 - acc: 0.8645 - val\_loss: 0.0011 - val\_acc: 0.8271
Epoch 188/250
1696/1712 [============================>.] - ETA: 0s - loss: 4.2580e-04 - acc: 0.8815- ETA: 1s - loss: Epoch 00187: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 4.2652e-04 - acc: 0.8826 - val\_loss: 0.0012 - val\_acc: 0.8201
Epoch 189/250
1696/1712 [============================>.] - ETA: 0s - loss: 4.2569e-04 - acc: 0.8455Epoch 00188: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 4.2554e-04 - acc: 0.8464 - val\_loss: 0.0011 - val\_acc: 0.8271
Epoch 190/250
1696/1712 [============================>.] - ETA: 0s - loss: 4.1294e-04 - acc: 0.8650Epoch 00189: val\_loss improved from 0.00100 to 0.00097, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 4.1367e-04 - acc: 0.8657 - val\_loss: 9.6943e-04 - val\_acc: 0.8318
Epoch 191/250
1696/1712 [============================>.] - ETA: 0s - loss: 4.1860e-04 - acc: 0.8644Epoch 00190: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 4.1844e-04 - acc: 0.8651 - val\_loss: 0.0010 - val\_acc: 0.8294
Epoch 192/250
1696/1712 [============================>.] - ETA: 0s - loss: 4.2424e-04 - acc: 0.8785Epoch 00191: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 4.2426e-04 - acc: 0.8785 - val\_loss: 0.0010 - val\_acc: 0.8201
Epoch 193/250
1696/1712 [============================>.] - ETA: 0s - loss: 4.1843e-04 - acc: 0.8691- ETA: 1s - loss: Epoch 00192: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 4.1985e-04 - acc: 0.8692 - val\_loss: 0.0011 - val\_acc: 0.8388
Epoch 194/250
1696/1712 [============================>.] - ETA: 0s - loss: 4.1069e-04 - acc: 0.8721Epoch 00193: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 4.1152e-04 - acc: 0.8721 - val\_loss: 0.0011 - val\_acc: 0.8341
Epoch 195/250
1696/1712 [============================>.] - ETA: 0s - loss: 4.2251e-04 - acc: 0.8703Epoch 00194: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 4.2206e-04 - acc: 0.8697 - val\_loss: 0.0011 - val\_acc: 0.8248
Epoch 196/250
1696/1712 [============================>.] - ETA: 0s - loss: 4.0747e-04 - acc: 0.8673Epoch 00195: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 4.0677e-04 - acc: 0.8686 - val\_loss: 0.0011 - val\_acc: 0.8107
Epoch 197/250
1696/1712 [============================>.] - ETA: 0s - loss: 4.0445e-04 - acc: 0.8768Epoch 00196: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 4.0426e-04 - acc: 0.8762 - val\_loss: 9.8824e-04 - val\_acc: 0.8201
Epoch 198/250
1696/1712 [============================>.] - ETA: 0s - loss: 4.0928e-04 - acc: 0.8673Epoch 00197: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 4.0925e-04 - acc: 0.8674 - val\_loss: 9.9951e-04 - val\_acc: 0.8248
Epoch 199/250
1696/1712 [============================>.] - ETA: 0s - loss: 4.1762e-04 - acc: 0.8844Epoch 00198: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 4.1833e-04 - acc: 0.8838 - val\_loss: 0.0011 - val\_acc: 0.8084
Epoch 200/250
1696/1712 [============================>.] - ETA: 0s - loss: 4.0942e-04 - acc: 0.8656Epoch 00199: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 4.0912e-04 - acc: 0.8662 - val\_loss: 0.0010 - val\_acc: 0.8224
Epoch 201/250
1696/1712 [============================>.] - ETA: 0s - loss: 4.0260e-04 - acc: 0.8667Epoch 00200: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 4.0245e-04 - acc: 0.8668 - val\_loss: 0.0011 - val\_acc: 0.7991
Epoch 202/250
1696/1712 [============================>.] - ETA: 0s - loss: 4.0481e-04 - acc: 0.8667Epoch 00201: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 4.0410e-04 - acc: 0.8662 - val\_loss: 0.0011 - val\_acc: 0.8131
Epoch 203/250
1696/1712 [============================>.] - ETA: 0s - loss: 3.8688e-04 - acc: 0.8721Epoch 00202: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 3.8785e-04 - acc: 0.8727 - val\_loss: 9.9782e-04 - val\_acc: 0.8271
Epoch 204/250
1696/1712 [============================>.] - ETA: 0s - loss: 3.9896e-04 - acc: 0.8809Epoch 00203: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 3.9781e-04 - acc: 0.8814 - val\_loss: 0.0011 - val\_acc: 0.8201
Epoch 205/250
1696/1712 [============================>.] - ETA: 0s - loss: 4.1279e-04 - acc: 0.8679Epoch 00204: val\_loss improved from 0.00097 to 0.00096, saving model to my\_model.h5
1712/1712 [==============================] - 2s - loss: 4.1279e-04 - acc: 0.8686 - val\_loss: 9.5625e-04 - val\_acc: 0.8107
Epoch 206/250
1696/1712 [============================>.] - ETA: 0s - loss: 3.9202e-04 - acc: 0.8691Epoch 00205: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 3.9155e-04 - acc: 0.8692 - val\_loss: 0.0011 - val\_acc: 0.8271
Epoch 207/250
1696/1712 [============================>.] - ETA: 0s - loss: 4.0341e-04 - acc: 0.8768Epoch 00206: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 4.0320e-04 - acc: 0.8756 - val\_loss: 0.0010 - val\_acc: 0.8131
Epoch 208/250
1696/1712 [============================>.] - ETA: 0s - loss: 3.9998e-04 - acc: 0.8821Epoch 00207: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 4.0097e-04 - acc: 0.8832 - val\_loss: 0.0010 - val\_acc: 0.8224
Epoch 209/250
1696/1712 [============================>.] - ETA: 0s - loss: 3.9468e-04 - acc: 0.8874Epoch 00208: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 3.9455e-04 - acc: 0.8861 - val\_loss: 0.0010 - val\_acc: 0.8294
Epoch 210/250
1696/1712 [============================>.] - ETA: 0s - loss: 3.9384e-04 - acc: 0.8744Epoch 00209: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 3.9397e-04 - acc: 0.8738 - val\_loss: 0.0011 - val\_acc: 0.8201
Epoch 211/250
1696/1712 [============================>.] - ETA: 0s - loss: 4.0641e-04 - acc: 0.8850Epoch 00210: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 4.0653e-04 - acc: 0.8849 - val\_loss: 0.0012 - val\_acc: 0.8201
Epoch 212/250
1696/1712 [============================>.] - ETA: 0s - loss: 3.9320e-04 - acc: 0.8585Epoch 00211: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 3.9295e-04 - acc: 0.8586 - val\_loss: 9.9774e-04 - val\_acc: 0.8364
Epoch 213/250
1696/1712 [============================>.] - ETA: 0s - loss: 3.8949e-04 - acc: 0.8709Epoch 00212: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 3.8891e-04 - acc: 0.8703 - val\_loss: 0.0010 - val\_acc: 0.8364
Epoch 214/250
1696/1712 [============================>.] - ETA: 0s - loss: 3.7759e-04 - acc: 0.8827Epoch 00213: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 3.7766e-04 - acc: 0.8814 - val\_loss: 0.0010 - val\_acc: 0.8364
Epoch 215/250
1696/1712 [============================>.] - ETA: 0s - loss: 3.8407e-04 - acc: 0.8744Epoch 00214: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 3.8448e-04 - acc: 0.8727 - val\_loss: 0.0010 - val\_acc: 0.8341
Epoch 216/250
1696/1712 [============================>.] - ETA: 0s - loss: 3.8756e-04 - acc: 0.8632Epoch 00215: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 3.8771e-04 - acc: 0.8633 - val\_loss: 0.0011 - val\_acc: 0.8388
Epoch 217/250
1696/1712 [============================>.] - ETA: 0s - loss: 3.7146e-04 - acc: 0.8821Epoch 00216: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 3.7168e-04 - acc: 0.8814 - val\_loss: 0.0011 - val\_acc: 0.8224
Epoch 218/250
1696/1712 [============================>.] - ETA: 0s - loss: 3.8511e-04 - acc: 0.8732- ETA: 1s - loss: Epoch 00217: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 3.8453e-04 - acc: 0.8732 - val\_loss: 0.0010 - val\_acc: 0.8154
Epoch 219/250
1696/1712 [============================>.] - ETA: 0s - loss: 3.8124e-04 - acc: 0.8774Epoch 00218: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 3.8073e-04 - acc: 0.8773 - val\_loss: 9.9407e-04 - val\_acc: 0.8154
Epoch 220/250
1696/1712 [============================>.] - ETA: 0s - loss: 3.6818e-04 - acc: 0.8833Epoch 00219: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 3.6822e-04 - acc: 0.8826 - val\_loss: 0.0010 - val\_acc: 0.8201
Epoch 221/250
1696/1712 [============================>.] - ETA: 0s - loss: 3.7465e-04 - acc: 0.8721Epoch 00220: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 3.7496e-04 - acc: 0.8715 - val\_loss: 0.0011 - val\_acc: 0.8248
Epoch 222/250
1696/1712 [============================>.] - ETA: 0s - loss: 3.7384e-04 - acc: 0.8809Epoch 00221: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 3.7470e-04 - acc: 0.8808 - val\_loss: 0.0010 - val\_acc: 0.8248
Epoch 223/250
1696/1712 [============================>.] - ETA: 0s - loss: 3.8209e-04 - acc: 0.8779Epoch 00222: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 3.8230e-04 - acc: 0.8779 - val\_loss: 9.7601e-04 - val\_acc: 0.8294
Epoch 224/250
1696/1712 [============================>.] - ETA: 0s - loss: 3.7221e-04 - acc: 0.8821Epoch 00223: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 3.7201e-04 - acc: 0.8826 - val\_loss: 9.7508e-04 - val\_acc: 0.8271
Epoch 225/250
1696/1712 [============================>.] - ETA: 0s - loss: 3.6136e-04 - acc: 0.8803Epoch 00224: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 3.6168e-04 - acc: 0.8797 - val\_loss: 0.0010 - val\_acc: 0.8248
Epoch 226/250
1696/1712 [============================>.] - ETA: 0s - loss: 3.7071e-04 - acc: 0.8679Epoch 00225: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 3.7074e-04 - acc: 0.8680 - val\_loss: 0.0010 - val\_acc: 0.8061
Epoch 227/250
1696/1712 [============================>.] - ETA: 0s - loss: 3.6423e-04 - acc: 0.8738Epoch 00226: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 3.6359e-04 - acc: 0.8750 - val\_loss: 0.0010 - val\_acc: 0.8318
Epoch 228/250
1696/1712 [============================>.] - ETA: 0s - loss: 3.6999e-04 - acc: 0.8791Epoch 00227: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 3.6990e-04 - acc: 0.8797 - val\_loss: 0.0010 - val\_acc: 0.8201
Epoch 229/250
1696/1712 [============================>.] - ETA: 0s - loss: 3.6387e-04 - acc: 0.8809Epoch 00228: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 3.6500e-04 - acc: 0.8803 - val\_loss: 0.0011 - val\_acc: 0.8248
Epoch 230/250
1696/1712 [============================>.] - ETA: 0s - loss: 3.6134e-04 - acc: 0.8662- ETA: 1s - loss: Epoch 00229: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 3.6165e-04 - acc: 0.8662 - val\_loss: 9.8022e-04 - val\_acc: 0.8318
Epoch 231/250
1696/1712 [============================>.] - ETA: 0s - loss: 3.6556e-04 - acc: 0.8868Epoch 00230: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 3.6566e-04 - acc: 0.8867 - val\_loss: 0.0012 - val\_acc: 0.8318
Epoch 232/250
1696/1712 [============================>.] - ETA: 0s - loss: 3.5937e-04 - acc: 0.8785Epoch 00231: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 3.5915e-04 - acc: 0.8779 - val\_loss: 0.0011 - val\_acc: 0.8411
Epoch 233/250
1696/1712 [============================>.] - ETA: 0s - loss: 3.5347e-04 - acc: 0.8797Epoch 00232: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 3.5395e-04 - acc: 0.8791 - val\_loss: 0.0011 - val\_acc: 0.8364
Epoch 234/250
1696/1712 [============================>.] - ETA: 0s - loss: 3.6852e-04 - acc: 0.8785Epoch 00233: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 3.6903e-04 - acc: 0.8779 - val\_loss: 0.0010 - val\_acc: 0.8201
Epoch 235/250
1696/1712 [============================>.] - ETA: 0s - loss: 3.5390e-04 - acc: 0.8809Epoch 00234: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 3.5428e-04 - acc: 0.8803 - val\_loss: 0.0010 - val\_acc: 0.8248
Epoch 236/250
1696/1712 [============================>.] - ETA: 0s - loss: 3.5509e-04 - acc: 0.8880Epoch 00235: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 3.5613e-04 - acc: 0.8879 - val\_loss: 9.8635e-04 - val\_acc: 0.8318
Epoch 237/250
1696/1712 [============================>.] - ETA: 0s - loss: 3.5220e-04 - acc: 0.8856Epoch 00236: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 3.5223e-04 - acc: 0.8861 - val\_loss: 0.0010 - val\_acc: 0.8341
Epoch 238/250
1696/1712 [============================>.] - ETA: 0s - loss: 3.4804e-04 - acc: 0.8833Epoch 00237: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 3.4743e-04 - acc: 0.8832 - val\_loss: 0.0011 - val\_acc: 0.8178
Epoch 239/250
1696/1712 [============================>.] - ETA: 0s - loss: 3.5358e-04 - acc: 0.8903Epoch 00238: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 3.5313e-04 - acc: 0.8896 - val\_loss: 0.0010 - val\_acc: 0.8318
Epoch 240/250
1696/1712 [============================>.] - ETA: 0s - loss: 3.4816e-04 - acc: 0.8744Epoch 00239: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 3.4846e-04 - acc: 0.8756 - val\_loss: 0.0010 - val\_acc: 0.8411
Epoch 241/250
1696/1712 [============================>.] - ETA: 0s - loss: 3.4178e-04 - acc: 0.8785Epoch 00240: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 3.4173e-04 - acc: 0.8785 - val\_loss: 0.0010 - val\_acc: 0.8201
Epoch 242/250
1696/1712 [============================>.] - ETA: 0s - loss: 3.5412e-04 - acc: 0.8886Epoch 00241: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 3.5445e-04 - acc: 0.8884 - val\_loss: 0.0011 - val\_acc: 0.8294
Epoch 243/250
1696/1712 [============================>.] - ETA: 0s - loss: 3.3926e-04 - acc: 0.8868Epoch 00242: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 3.3931e-04 - acc: 0.8861 - val\_loss: 0.0010 - val\_acc: 0.8341
Epoch 244/250
1696/1712 [============================>.] - ETA: 0s - loss: 3.4858e-04 - acc: 0.8833Epoch 00243: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 3.4910e-04 - acc: 0.8838 - val\_loss: 0.0010 - val\_acc: 0.8271
Epoch 245/250
1696/1712 [============================>.] - ETA: 0s - loss: 3.5367e-04 - acc: 0.8821- ETA: 1s - loss: Epoch 00244: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 3.5363e-04 - acc: 0.8826 - val\_loss: 0.0011 - val\_acc: 0.8154
Epoch 246/250
1696/1712 [============================>.] - ETA: 0s - loss: 3.4464e-04 - acc: 0.8715Epoch 00245: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 3.4454e-04 - acc: 0.8715 - val\_loss: 0.0010 - val\_acc: 0.8248
Epoch 247/250
1696/1712 [============================>.] - ETA: 0s - loss: 3.4259e-04 - acc: 0.8750Epoch 00246: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 3.4315e-04 - acc: 0.8756 - val\_loss: 0.0011 - val\_acc: 0.7991
Epoch 248/250
1696/1712 [============================>.] - ETA: 0s - loss: 3.4953e-04 - acc: 0.8721Epoch 00247: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 3.4889e-04 - acc: 0.8721 - val\_loss: 0.0010 - val\_acc: 0.8435
Epoch 249/250
1696/1712 [============================>.] - ETA: 0s - loss: 3.3559e-04 - acc: 0.8886Epoch 00248: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 3.3565e-04 - acc: 0.8890 - val\_loss: 0.0010 - val\_acc: 0.8131
Epoch 250/250
1696/1712 [============================>.] - ETA: 0s - loss: 3.4690e-04 - acc: 0.8738Epoch 00249: val\_loss did not improve
1712/1712 [==============================] - 2s - loss: 3.4628e-04 - acc: 0.8744 - val\_loss: 0.0010 - val\_acc: 0.8341

    \end{Verbatim}

    \begin{center}\rule{0.5\linewidth}{\linethickness}\end{center}

\subsection{Step 7: Visualize the Loss and Test
Predictions}\label{step-7-visualize-the-loss-and-test-predictions}

    \subsubsection{(IMPLEMENTATION) Answer a few questions and visualize the
loss}\label{implementation-answer-a-few-questions-and-visualize-the-loss}

\textbf{Question 1:} Outline the steps you took to get to your final
neural network architecture and your reasoning at each step.

\textbf{Answer:} I Started with 32 filters and after it, I'll give the
model more and more filters, from my experience, most of the times the
best way is to start with 16 filters or 32 filters.

I'm using the most popular and recommended activation function 'relu'
and padding='same' so we won't lose important data, though in this case,
it seems that the data on the edges is less important than the center,
so it may be less important.

I give it kernel\_size of 3, since from my experience its best to be set
to 2 or 3, so I start with 3 on the first layer and will change it to 2
on the others where I'll have smaller width and height input.

After each convolution layer I added a pooling layer, it will
progressively reduce the spatial size of the representation, and reduce
the number of parameters and amount of computation so it gives us the
ability to increase the filters count without having too many
parameters, and it also helps to control overfitting. I'm using the
MaxPooling2D with pool\_size=2 which is most common and recommended.

After each convolution layer, I'm also Using Dropout in order to reduce
even more the number of parameters and amount of computation and helps
to control overfitting.

After all those layers I Added GlobalAveragePooling2D layer, doing it
like in the ResNet-50 model
(http://ethereon.github.io/netscope/\#/gist/db945b393d40bfa26006) it
enforces correspondence between feature maps and categories, and also
global average pooling is a structural regularizer, which natively
prevents overfitting for the overall structure (I get my knowledge from
this paper: http://arxiv.org/pdf/1312.4400.pdf).

Finally I added a dense layer with output of 30 that will represent the
15 key points (15 for x + 15 for y), and as activation I used the linear
activation, I could use tanh activation cause it gives values between -1
to 1 but it may act less linear around the 0 and since we have linear
problem, we better to used linear activation which means adding no
activation at keras.

\textbf{Question 2:} Defend your choice of optimizer. Which optimizers
did you test, and how did you determine which worked best?

\textbf{Answer:} Since I know SGD most of the times is trained slower
than others optimizer, so I didn't try it.

I did try all the other known optimizers(RMSprop, Adagrad, Adadelta,
Adam, Adamax, Nadam), and I find that Adamax worked the best, it got
val\_loss of 0.00096 while all the others didn't get less than 0.0011.
(on 250 epochs)

Use the code cell below to plot the training and validation loss of your
neural network. You may find
\href{http://machinelearningmastery.com/display-deep-learning-model-training-history-in-keras/}{this
resource} useful.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}39}]:} \PY{c+c1}{\PYZsh{}\PYZsh{} TODO: Visualize the training and validation loss of your neural network}
         
         \PY{c+c1}{\PYZsh{} list all data in history}
         \PY{n+nb}{print}\PY{p}{(}\PY{n}{hist}\PY{o}{.}\PY{n}{history}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}
         \PY{c+c1}{\PYZsh{} summarize history for accuracy}
         \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{hist}\PY{o}{.}\PY{n}{history}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{acc}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{hist}\PY{o}{.}\PY{n}{history}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{val\PYZus{}acc}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Model Accuracy}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{accuracy}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{xlabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{epoch}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{legend}\PY{p}{(}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{train}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{test}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{loc}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{upper left}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}
         \PY{c+c1}{\PYZsh{} summarize history for loss}
         \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{hist}\PY{o}{.}\PY{n}{history}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{loss}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{hist}\PY{o}{.}\PY{n}{history}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{val\PYZus{}loss}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Model Loss}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{loss}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{xlabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{epoch}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{legend}\PY{p}{(}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{train}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{test}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{loc}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{upper left}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
dict\_keys(['val\_loss', 'val\_acc', 'loss', 'acc'])

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_61_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_61_2.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \textbf{Question 3:} Do you notice any evidence of overfitting or
underfitting in the above plot? If so, what steps have you taken to
improve your model? Note that slight overfitting or underfitting will
not hurt your chances of a successful submission, as long as you have
attempted some solutions towards improving your model (such as
\emph{regularization, dropout, increased/decreased number of layers,
etc}).

\textbf{Answer:} On my first architecture I had only 4 convolution
layers and dropout of only 0.1 on each layer, It got me pretty good
results of val\_loss = 0.0015, but I did find evidence of overfitting
when the train loss was getting lower but the test lost was't changing,
So I increased the dropout to be 0.3 and 0.2, and in order not to lose
accuracy I also added one more convolution layer with output of 512.
Those changes were really helpful, now I have less overfitting and it
starts later, and my best val\_loss improved to just 0.00096.

    \subsubsection{Visualize a Subset of the Test
Predictions}\label{visualize-a-subset-of-the-test-predictions}

Execute the code cell below to visualize your model's predicted
keypoints on a subset of the testing images.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}40}]:} \PY{n}{y\PYZus{}test} \PY{o}{=} \PY{n}{model}\PY{o}{.}\PY{n}{predict}\PY{p}{(}\PY{n}{X\PYZus{}test}\PY{p}{)}
         \PY{n}{fig} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{figsize}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{20}\PY{p}{,}\PY{l+m+mi}{20}\PY{p}{)}\PY{p}{)}
         \PY{n}{fig}\PY{o}{.}\PY{n}{subplots\PYZus{}adjust}\PY{p}{(}\PY{n}{left}\PY{o}{=}\PY{l+m+mi}{0}\PY{p}{,} \PY{n}{right}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{bottom}\PY{o}{=}\PY{l+m+mi}{0}\PY{p}{,} \PY{n}{top}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{hspace}\PY{o}{=}\PY{l+m+mf}{0.05}\PY{p}{,} \PY{n}{wspace}\PY{o}{=}\PY{l+m+mf}{0.05}\PY{p}{)}
         \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{l+m+mi}{9}\PY{p}{)}\PY{p}{:}
             \PY{n}{ax} \PY{o}{=} \PY{n}{fig}\PY{o}{.}\PY{n}{add\PYZus{}subplot}\PY{p}{(}\PY{l+m+mi}{3}\PY{p}{,} \PY{l+m+mi}{3}\PY{p}{,} \PY{n}{i} \PY{o}{+} \PY{l+m+mi}{1}\PY{p}{,} \PY{n}{xticks}\PY{o}{=}\PY{p}{[}\PY{p}{]}\PY{p}{,} \PY{n}{yticks}\PY{o}{=}\PY{p}{[}\PY{p}{]}\PY{p}{)}
             \PY{n}{plot\PYZus{}data}\PY{p}{(}\PY{n}{X\PYZus{}test}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,} \PY{n}{y\PYZus{}test}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,} \PY{n}{ax}\PY{p}{)}
\end{Verbatim}


    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_64_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{center}\rule{0.5\linewidth}{\linethickness}\end{center}

\subsection{Step 8: Complete the
pipeline}\label{step-8-complete-the-pipeline}

With the work you did in Sections 1 and 2 of this notebook, along with
your freshly trained facial keypoint detector, you can now complete the
full pipeline. That is given a color image containing a person or
persons you can now

\begin{itemize}
\tightlist
\item
  Detect the faces in this image automatically using OpenCV
\item
  Predict the facial keypoints in each face detected in the image
\item
  Paint predicted keypoints on each face detected
\end{itemize}

In this Subsection you will do just this!

    \subsubsection{(IMPLEMENTATION) Facial Keypoints
Detector}\label{implementation-facial-keypoints-detector}

Use the OpenCV face detection functionality you built in previous
Sections to expand the functionality of your keypoints detector to color
images with arbitrary size. Your function should perform the following
steps

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Accept a color image.
\item
  Convert the image to grayscale.
\item
  Detect and crop the face contained in the image.
\item
  Locate the facial keypoints in the cropped image.
\item
  Overlay the facial keypoints in the original (color, uncropped) image.
\end{enumerate}

\textbf{Note}: Step 4 can be the trickiest because remember your
convolutional network is only trained to detect facial keypoints in
\(96 \times 96\) grayscale images where each pixel was normalized to lie
in the interval \([0,1]\), and remember that each facial keypoint was
normalized during training to the interval \([-1,1]\).

This means - practically speaking - to paint detected keypoints onto a
test face you need to perform this same pre-processing to your candidate
face - that is after detecting it you should resize it to
\(96 \times 96\) and normalize its values before feeding it into your
facial keypoint detector.

To be shown correctly on the original image the output keypoints from
your detector then need to be shifted and re-normalized from the
interval \([-1,1]\) to the width and height of your detected face.

When complete you should be able to produce example images like the one
below

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}11}]:} \PY{c+c1}{\PYZsh{} Load in color image for face detection}
         \PY{n}{image} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{imread}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{images/obamas4.jpg}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         
         
         \PY{c+c1}{\PYZsh{} Convert the image to RGB colorspace}
         \PY{n}{image} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{cvtColor}\PY{p}{(}\PY{n}{image}\PY{p}{,} \PY{n}{cv2}\PY{o}{.}\PY{n}{COLOR\PYZus{}BGR2RGB}\PY{p}{)}
         \PY{n}{image\PYZus{}copy} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{copy}\PY{p}{(}\PY{n}{image}\PY{p}{)}
         
         
         \PY{c+c1}{\PYZsh{} plot our image}
         \PY{n}{fig} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{figsize} \PY{o}{=} \PY{p}{(}\PY{l+m+mi}{9}\PY{p}{,}\PY{l+m+mi}{9}\PY{p}{)}\PY{p}{)}
         \PY{n}{ax1} \PY{o}{=} \PY{n}{fig}\PY{o}{.}\PY{n}{add\PYZus{}subplot}\PY{p}{(}\PY{l+m+mi}{111}\PY{p}{)}
         \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}xticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{)}
         \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}yticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{)}
         \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{image copy}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{ax1}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{image\PYZus{}copy}\PY{p}{)}
\end{Verbatim}


\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}11}]:} <matplotlib.image.AxesImage at 0x1ef83b6ae10>
\end{Verbatim}
            
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_67_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}3}]:} \PY{c+c1}{\PYZsh{}\PYZsh{}\PYZsh{} TODO: Use the face detection code we saw in Section 1 with your trained conv\PYZhy{}net }
        \PY{c+c1}{\PYZsh{}\PYZsh{} TODO : Paint the predicted keypoints on the test image}
        \PY{k}{def} \PY{n+nf}{find\PYZus{}keypoints}\PY{p}{(}\PY{n}{image}\PY{p}{)}\PY{p}{:}
            \PY{c+c1}{\PYZsh{} Convert the RGB  image to grayscale}
            \PY{n}{gray} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{cvtColor}\PY{p}{(}\PY{n}{image}\PY{p}{,} \PY{n}{cv2}\PY{o}{.}\PY{n}{COLOR\PYZus{}RGB2GRAY}\PY{p}{)}
        
            \PY{c+c1}{\PYZsh{} Extract the pre\PYZhy{}trained face detector from an xml file}
            \PY{n}{face\PYZus{}cascade} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{CascadeClassifier}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{detector\PYZus{}architectures/haarcascade\PYZus{}frontalface\PYZus{}default.xml}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        
            \PY{c+c1}{\PYZsh{} Detect the faces in image}
            \PY{n}{faces} \PY{o}{=} \PY{n}{face\PYZus{}cascade}\PY{o}{.}\PY{n}{detectMultiScale}\PY{p}{(}\PY{n}{gray}\PY{p}{,} \PY{l+m+mf}{1.25}\PY{p}{,} \PY{l+m+mi}{6}\PY{p}{)}
        
            \PY{c+c1}{\PYZsh{} Print the number of faces detected in the image}
            \PY{c+c1}{\PYZsh{}print(\PYZsq{}Number of faces detected:\PYZsq{}, len(faces))}
        
            \PY{c+c1}{\PYZsh{} Make a copy of the orginal image to draw face detections on}
            \PY{n}{image\PYZus{}with\PYZus{}predicted\PYZus{}keypoints} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{copy}\PY{p}{(}\PY{n}{image}\PY{p}{)}
            
            \PY{n}{faces\PYZus{}keypoints} \PY{o}{=} \PY{p}{[}\PY{p}{]}
            
            \PY{k}{for} \PY{p}{(}\PY{n}{x}\PY{p}{,}\PY{n}{y}\PY{p}{,}\PY{n}{w}\PY{p}{,}\PY{n}{h}\PY{p}{)} \PY{o+ow}{in} \PY{n}{faces}\PY{p}{:}
                \PY{c+c1}{\PYZsh{} Crop and resize the face}
                \PY{n}{face\PYZus{}image} \PY{o}{=} \PY{n}{gray}\PY{p}{[}\PY{n}{y}\PY{p}{:}\PY{n}{y}\PY{o}{+}\PY{n}{h} \PY{p}{,} \PY{n}{x}\PY{p}{:}\PY{n}{x}\PY{o}{+}\PY{n}{w}\PY{p}{]}
                \PY{n}{resize\PYZus{}face} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{resize}\PY{p}{(}\PY{n}{face\PYZus{}image}\PY{p}{,} \PY{p}{(}\PY{l+m+mi}{96}\PY{p}{,} \PY{l+m+mi}{96}\PY{p}{)}\PY{p}{)}
        
                \PY{c+c1}{\PYZsh{} Normalized and convert to the input format}
                \PY{n}{normalized\PYZus{}face} \PY{o}{=} \PY{n}{resize\PYZus{}face} \PY{o}{/} \PY{l+m+mi}{255}
                \PY{n}{normalized\PYZus{}face} \PY{o}{=} \PY{n}{normalized\PYZus{}face}\PY{p}{[}\PY{n}{np}\PY{o}{.}\PY{n}{newaxis}\PY{p}{,} \PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{p}{,} \PY{n}{np}\PY{o}{.}\PY{n}{newaxis}\PY{p}{]}
        
                \PY{c+c1}{\PYZsh{} Predict the face keypoints and un\PYZhy{}normalized the coordinates}
                \PY{n}{keypoints} \PY{o}{=} \PY{n}{model}\PY{o}{.}\PY{n}{predict}\PY{p}{(}\PY{n}{normalized\PYZus{}face}\PY{p}{)}
                \PY{n}{keypoints} \PY{o}{=} \PY{n}{keypoints} \PY{o}{*} \PY{l+m+mi}{48} \PY{o}{+} \PY{l+m+mi}{48}
        
                \PY{c+c1}{\PYZsh{} Rescale to the orifinal image scale and draw the keypoints}
                \PY{n}{coordinats\PYZus{}x} \PY{o}{=} \PY{n}{keypoints}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{:}\PY{p}{:}\PY{l+m+mi}{2}\PY{p}{]} \PY{c+c1}{\PYZsh{} [startAt:endBefore:skip]}
                \PY{n}{coordinats\PYZus{}y} \PY{o}{=} \PY{n}{keypoints}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{:}\PY{p}{:}\PY{l+m+mi}{2}\PY{p}{]}
                
                \PY{n}{coordinats\PYZus{}x} \PY{o}{=} \PY{n}{x} \PY{o}{+} \PY{n}{coordinats\PYZus{}x} \PY{o}{*} \PY{n}{w} \PY{o}{/} \PY{l+m+mi}{96}
                \PY{n}{coordinats\PYZus{}y} \PY{o}{=} \PY{n}{y} \PY{o}{+} \PY{n}{coordinats\PYZus{}y} \PY{o}{*} \PY{n}{h} \PY{o}{/} \PY{l+m+mi}{96}
                \PY{n}{cv2}\PY{o}{.}\PY{n}{rectangle}\PY{p}{(}\PY{n}{image\PYZus{}with\PYZus{}predicted\PYZus{}keypoints}\PY{p}{,} \PY{p}{(}\PY{n}{x}\PY{p}{,}\PY{n}{y}\PY{p}{)}\PY{p}{,} \PY{p}{(}\PY{n}{x}\PY{o}{+}\PY{n}{w}\PY{p}{,}\PY{n}{y}\PY{o}{+}\PY{n}{h}\PY{p}{)}\PY{p}{,} \PY{p}{(}\PY{l+m+mi}{255}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{)}\PY{p}{,} \PY{l+m+mi}{3}\PY{p}{)}
        
                \PY{n}{faces\PYZus{}keypoints}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{p}{(}\PY{n}{coordinats\PYZus{}x}\PY{p}{,} \PY{n}{coordinats\PYZus{}y}\PY{p}{)}\PY{p}{)}
            
                \PY{k}{for} \PY{n}{xc}\PY{p}{,} \PY{n}{yc} \PY{o+ow}{in} \PY{n+nb}{zip}\PY{p}{(}\PY{n}{coordinats\PYZus{}x}\PY{p}{,} \PY{n}{coordinats\PYZus{}y}\PY{p}{)}\PY{p}{:}
                    \PY{n}{cv2}\PY{o}{.}\PY{n}{circle}\PY{p}{(}\PY{n}{image\PYZus{}with\PYZus{}predicted\PYZus{}keypoints}\PY{p}{,} \PY{p}{(}\PY{n}{xc}\PY{p}{,} \PY{n}{yc}\PY{p}{)}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{,} \PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,} \PY{l+m+mi}{255}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{)}\PY{p}{,} \PY{l+m+mi}{3}\PY{p}{)}
                     
            \PY{k}{return} \PY{n}{image\PYZus{}with\PYZus{}predicted\PYZus{}keypoints}\PY{p}{,} \PY{n}{faces\PYZus{}keypoints}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}55}]:} \PY{k+kn}{from} \PY{n+nn}{keras}\PY{n+nn}{.}\PY{n+nn}{models} \PY{k}{import} \PY{n}{load\PYZus{}model}
         \PY{n}{model} \PY{o}{=} \PY{n}{load\PYZus{}model}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{my\PYZus{}model.h5}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         
         \PY{n}{image\PYZus{}with\PYZus{}predicted\PYZus{}keypoints}\PY{p}{,} \PY{n}{faces\PYZus{}keypoints} \PY{o}{=} \PY{n}{find\PYZus{}keypoints}\PY{p}{(}\PY{n}{image}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} Display the image with the keypoints}
         \PY{n}{fig} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{figsize} \PY{o}{=} \PY{p}{(}\PY{l+m+mi}{9}\PY{p}{,}\PY{l+m+mi}{9}\PY{p}{)}\PY{p}{)}
         \PY{n}{ax1} \PY{o}{=} \PY{n}{fig}\PY{o}{.}\PY{n}{add\PYZus{}subplot}\PY{p}{(}\PY{l+m+mi}{111}\PY{p}{)}
         \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}xticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{)}
         \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}yticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{)}
         
         \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Image with predicted keypoints}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{ax1}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{image\PYZus{}with\PYZus{}predicted\PYZus{}keypoints}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
Number of faces detected: 2

    \end{Verbatim}

\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}55}]:} <matplotlib.image.AxesImage at 0x1efd59cfdd8>
\end{Verbatim}
            
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_69_2.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \subsubsection{(Optional) Further Directions - add a filter using facial
keypoints to your laptop
camera}\label{optional-further-directions---add-a-filter-using-facial-keypoints-to-your-laptop-camera}

Now you can add facial keypoint detection to your laptop camera - as
illustrated in the gif below.

The next Python cell contains the basic laptop video camera function
used in the previous optional video exercises. Combine it with the
functionality you developed for keypoint detection and marking in the
previous exercise and you should be good to go!

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}56}]:} \PY{k+kn}{import} \PY{n+nn}{cv2}
         \PY{k+kn}{import} \PY{n+nn}{time} 
         \PY{k+kn}{from} \PY{n+nn}{keras}\PY{n+nn}{.}\PY{n+nn}{models} \PY{k}{import} \PY{n}{load\PYZus{}model}
         
         \PY{k}{def} \PY{n+nf}{laptop\PYZus{}camera\PYZus{}go}\PY{p}{(}\PY{p}{)}\PY{p}{:}
             \PY{c+c1}{\PYZsh{} Create instance of video capturer}
             \PY{n}{cv2}\PY{o}{.}\PY{n}{namedWindow}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{face detection activated}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
             \PY{n}{vc} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{VideoCapture}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{)}  \PY{c+c1}{\PYZsh{}I have 2 cameras}
         
             \PY{c+c1}{\PYZsh{} Try to get the first frame}
             \PY{k}{if} \PY{n}{vc}\PY{o}{.}\PY{n}{isOpened}\PY{p}{(}\PY{p}{)}\PY{p}{:} 
                 \PY{n}{rval}\PY{p}{,} \PY{n}{frame} \PY{o}{=} \PY{n}{vc}\PY{o}{.}\PY{n}{read}\PY{p}{(}\PY{p}{)}
             \PY{k}{else}\PY{p}{:}
                 \PY{n}{rval} \PY{o}{=} \PY{k+kc}{False}
                 
             \PY{c+c1}{\PYZsh{} Extract the pre\PYZhy{}trained face detector from an xml file}
             \PY{n}{face\PYZus{}cascade} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{CascadeClassifier}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{detector\PYZus{}architectures/haarcascade\PYZus{}frontalface\PYZus{}default.xml}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         
             \PY{c+c1}{\PYZsh{} keep video stream open}
             \PY{k}{while} \PY{n}{rval}\PY{p}{:}
                 \PY{c+c1}{\PYZsh{} Convert the RGB  image to grayscale}
                 \PY{n}{gray} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{cvtColor}\PY{p}{(}\PY{n}{frame}\PY{p}{,} \PY{n}{cv2}\PY{o}{.}\PY{n}{COLOR\PYZus{}RGB2GRAY}\PY{p}{)}
                 
                 \PY{c+c1}{\PYZsh{} Detect the faces in image}
                 \PY{n}{faces} \PY{o}{=} \PY{n}{face\PYZus{}cascade}\PY{o}{.}\PY{n}{detectMultiScale}\PY{p}{(}\PY{n}{gray}\PY{p}{,} \PY{l+m+mf}{1.25}\PY{p}{,} \PY{l+m+mi}{6}\PY{p}{)}
         
                 \PY{c+c1}{\PYZsh{} Make a copy of the orginal image to draw face detections on}
                 \PY{n}{image\PYZus{}with\PYZus{}predicted\PYZus{}keypoints} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{copy}\PY{p}{(}\PY{n}{image}\PY{p}{)}
         
                 \PY{k}{for} \PY{p}{(}\PY{n}{x}\PY{p}{,}\PY{n}{y}\PY{p}{,}\PY{n}{w}\PY{p}{,}\PY{n}{h}\PY{p}{)} \PY{o+ow}{in} \PY{n}{faces}\PY{p}{:}
                     \PY{c+c1}{\PYZsh{} Crop and resize the face}
                     \PY{n}{face\PYZus{}image} \PY{o}{=} \PY{n}{gray}\PY{p}{[}\PY{n}{y}\PY{p}{:}\PY{n}{y}\PY{o}{+}\PY{n}{h} \PY{p}{,} \PY{n}{x}\PY{p}{:}\PY{n}{x}\PY{o}{+}\PY{n}{w}\PY{p}{]}
                     \PY{n}{resize\PYZus{}face} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{resize}\PY{p}{(}\PY{n}{face\PYZus{}image}\PY{p}{,} \PY{p}{(}\PY{l+m+mi}{96}\PY{p}{,} \PY{l+m+mi}{96}\PY{p}{)}\PY{p}{)}
         
                     \PY{c+c1}{\PYZsh{} Normalized and convert to the input format}
                     \PY{n}{normalized\PYZus{}face} \PY{o}{=} \PY{n}{resize\PYZus{}face} \PY{o}{/} \PY{l+m+mi}{255}
                     \PY{n}{normalized\PYZus{}face} \PY{o}{=} \PY{n}{normalized\PYZus{}face}\PY{p}{[}\PY{n}{np}\PY{o}{.}\PY{n}{newaxis}\PY{p}{,} \PY{p}{:}\PY{p}{,} \PY{p}{:}\PY{p}{,} \PY{n}{np}\PY{o}{.}\PY{n}{newaxis}\PY{p}{]}
         
                     \PY{c+c1}{\PYZsh{} Predict the face keypoints and un\PYZhy{}normalized the coordinates}
                     \PY{n}{keypoints} \PY{o}{=} \PY{n}{model}\PY{o}{.}\PY{n}{predict}\PY{p}{(}\PY{n}{normalized\PYZus{}face}\PY{p}{)}
                     \PY{n}{keypoints} \PY{o}{=} \PY{n}{keypoints} \PY{o}{*} \PY{l+m+mi}{48} \PY{o}{+} \PY{l+m+mi}{48}
         
                     \PY{c+c1}{\PYZsh{} Rescale to the orifinal image scale and draw the keypoints}
                     \PY{n}{coordinats\PYZus{}x} \PY{o}{=} \PY{n}{keypoints}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{:}\PY{p}{:}\PY{l+m+mi}{2}\PY{p}{]} \PY{c+c1}{\PYZsh{} [startAt:endBefore:skip]}
                     \PY{n}{coordinats\PYZus{}y} \PY{o}{=} \PY{n}{keypoints}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{:}\PY{p}{:}\PY{l+m+mi}{2}\PY{p}{]}
         
                     \PY{n}{coordinats\PYZus{}x} \PY{o}{=} \PY{n}{x} \PY{o}{+} \PY{n}{coordinats\PYZus{}x} \PY{o}{*} \PY{n}{w} \PY{o}{/} \PY{l+m+mi}{96}
                     \PY{n}{coordinats\PYZus{}y} \PY{o}{=} \PY{n}{y} \PY{o}{+} \PY{n}{coordinats\PYZus{}y} \PY{o}{*} \PY{n}{h} \PY{o}{/} \PY{l+m+mi}{96}
                     \PY{n}{cv2}\PY{o}{.}\PY{n}{rectangle}\PY{p}{(}\PY{n}{frame}\PY{p}{,} \PY{p}{(}\PY{n}{x}\PY{p}{,}\PY{n}{y}\PY{p}{)}\PY{p}{,} \PY{p}{(}\PY{n}{x}\PY{o}{+}\PY{n}{w}\PY{p}{,}\PY{n}{y}\PY{o}{+}\PY{n}{h}\PY{p}{)}\PY{p}{,} \PY{p}{(}\PY{l+m+mi}{255}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{)}\PY{p}{,} \PY{l+m+mi}{3}\PY{p}{)}
         
                     \PY{k}{for} \PY{n}{xc}\PY{p}{,} \PY{n}{yc} \PY{o+ow}{in} \PY{n+nb}{zip}\PY{p}{(}\PY{n}{coordinats\PYZus{}x}\PY{p}{,} \PY{n}{coordinats\PYZus{}y}\PY{p}{)}\PY{p}{:}
                         \PY{n}{cv2}\PY{o}{.}\PY{n}{circle}\PY{p}{(}\PY{n}{frame}\PY{p}{,} \PY{p}{(}\PY{n}{xc}\PY{p}{,} \PY{n}{yc}\PY{p}{)}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{,} \PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,} \PY{l+m+mi}{255}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{)}\PY{p}{,} \PY{l+m+mi}{3}\PY{p}{)}
         
                 \PY{c+c1}{\PYZsh{} plot image from camera with detections marked}
                 \PY{n}{cv2}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{face detection activated}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{n}{frame}\PY{p}{)}
                 
                 \PY{c+c1}{\PYZsh{} exit functionality \PYZhy{} press any key to exit laptop video}
                 \PY{n}{key} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{waitKey}\PY{p}{(}\PY{l+m+mi}{20}\PY{p}{)}
                 \PY{k}{if} \PY{n}{key} \PY{o}{\PYZgt{}} \PY{l+m+mi}{0}\PY{p}{:} \PY{c+c1}{\PYZsh{} exit by pressing any key}
                     \PY{c+c1}{\PYZsh{} destroy windows}
                     \PY{n}{cv2}\PY{o}{.}\PY{n}{destroyAllWindows}\PY{p}{(}\PY{p}{)}
                     
                     \PY{c+c1}{\PYZsh{} hack from stack overflow for making sure window closes on osx \PYZhy{}\PYZhy{}\PYZgt{} https://stackoverflow.com/questions/6116564/destroywindow\PYZhy{}does\PYZhy{}not\PYZhy{}close\PYZhy{}window\PYZhy{}on\PYZhy{}mac\PYZhy{}using\PYZhy{}python\PYZhy{}and\PYZhy{}opencv}
                     \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range} \PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,}\PY{l+m+mi}{5}\PY{p}{)}\PY{p}{:}
                         \PY{n}{cv2}\PY{o}{.}\PY{n}{waitKey}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{)}
                     \PY{k}{return}
                 
                 \PY{c+c1}{\PYZsh{} read next frame}
                 \PY{n}{time}\PY{o}{.}\PY{n}{sleep}\PY{p}{(}\PY{l+m+mf}{0.05}\PY{p}{)}             \PY{c+c1}{\PYZsh{} control framerate for computation \PYZhy{} default 20 frames per sec}
                 \PY{n}{rval}\PY{p}{,} \PY{n}{frame} \PY{o}{=} \PY{n}{vc}\PY{o}{.}\PY{n}{read}\PY{p}{(}\PY{p}{)}  
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}57}]:} \PY{k+kn}{from} \PY{n+nn}{keras}\PY{n+nn}{.}\PY{n+nn}{models} \PY{k}{import} \PY{n}{load\PYZus{}model}
         \PY{n}{model} \PY{o}{=} \PY{n}{load\PYZus{}model}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{my\PYZus{}model.h5}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} Run your keypoint face painter}
         \PY{n}{laptop\PYZus{}camera\PYZus{}go}\PY{p}{(}\PY{p}{)}
\end{Verbatim}


    \subsubsection{(Optional) Further Directions - add a filter using facial
keypoints}\label{optional-further-directions---add-a-filter-using-facial-keypoints}

Using your freshly minted facial keypoint detector pipeline you can now
do things like add fun filters to a person's face automatically. In this
optional exercise you can play around with adding sunglasses
automatically to each individual's face in an image as shown in a
demonstration image below.

To produce this effect an image of a pair of sunglasses shown in the
Python cell below.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}10}]:} \PY{c+c1}{\PYZsh{} Load in sunglasses image \PYZhy{} note the usage of the special option}
         \PY{c+c1}{\PYZsh{} cv2.IMREAD\PYZus{}UNCHANGED, this option is used because the sunglasses }
         \PY{c+c1}{\PYZsh{} image has a 4th channel that allows us to control how transparent each pixel in the image is}
         \PY{n}{sunglasses} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{imread}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{images/sunglasses\PYZus{}4.png}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{n}{cv2}\PY{o}{.}\PY{n}{IMREAD\PYZus{}UNCHANGED}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} Plot the image}
         \PY{n}{fig} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{figsize} \PY{o}{=} \PY{p}{(}\PY{l+m+mi}{6}\PY{p}{,}\PY{l+m+mi}{6}\PY{p}{)}\PY{p}{)}
         \PY{n}{ax1} \PY{o}{=} \PY{n}{fig}\PY{o}{.}\PY{n}{add\PYZus{}subplot}\PY{p}{(}\PY{l+m+mi}{111}\PY{p}{)}
         \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}xticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{)}
         \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}yticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{)}
         \PY{n}{ax1}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{sunglasses}\PY{p}{)}
         \PY{n}{ax1}\PY{o}{.}\PY{n}{axis}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{off}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{;}
\end{Verbatim}


    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_74_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    This image is placed over each individual's face using the detected eye
points to determine the location of the sunglasses, and eyebrow points
to determine the size that the sunglasses should be for each person (one
could also use the nose point to determine this).

Notice that this image actually has \emph{4 channels}, not just 3.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}26}]:} \PY{c+c1}{\PYZsh{} Print out the shape of the sunglasses image}
         \PY{n+nb}{print} \PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{The sunglasses image has shape: }\PY{l+s+s1}{\PYZsq{}} \PY{o}{+} \PY{n+nb}{str}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{shape}\PY{p}{(}\PY{n}{sunglasses}\PY{p}{)}\PY{p}{)}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
The sunglasses image has shape: (1123, 3064, 4)

    \end{Verbatim}

    It has the usual red, blue, and green channels any color image has, with
the 4th channel representing the transparency level of each pixel in the
image. Here's how the transparency channel works: the lower the value,
the more transparent the pixel will become. The lower bound (completely
transparent) is zero here, so any pixels set to 0 will not be seen.

This is how we can place this image of sunglasses on someone's face and
still see the area around of their face where the sunglasses lie -
because these pixels in the sunglasses image have been made completely
transparent.

Lets check out the alpha channel of our sunglasses image in the next
Python cell. Note because many of the pixels near the boundary are
transparent we'll need to explicitly print out non-zero values if we
want to see them.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}27}]:} \PY{c+c1}{\PYZsh{} Print out the sunglasses transparency (alpha) channel}
         \PY{n}{alpha\PYZus{}channel} \PY{o}{=} \PY{n}{sunglasses}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{3}\PY{p}{]}
         \PY{n+nb}{print} \PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{the alpha channel here looks like}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n+nb}{print} \PY{p}{(}\PY{n}{alpha\PYZus{}channel}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} Just to double check that there are indeed non\PYZhy{}zero values}
         \PY{c+c1}{\PYZsh{} Let\PYZsq{}s find and print out every value greater than zero}
         \PY{n}{values} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{where}\PY{p}{(}\PY{n}{alpha\PYZus{}channel} \PY{o}{!=} \PY{l+m+mi}{0}\PY{p}{)}
         \PY{n+nb}{print} \PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+se}{\PYZbs{}n}\PY{l+s+s1}{ the non\PYZhy{}zero values of the alpha channel look like}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n+nb}{print} \PY{p}{(}\PY{n}{values}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
the alpha channel here looks like
[[0 0 0 {\ldots}, 0 0 0]
 [0 0 0 {\ldots}, 0 0 0]
 [0 0 0 {\ldots}, 0 0 0]
 {\ldots}, 
 [0 0 0 {\ldots}, 0 0 0]
 [0 0 0 {\ldots}, 0 0 0]
 [0 0 0 {\ldots}, 0 0 0]]

 the non-zero values of the alpha channel look like
(array([  17,   17,   17, {\ldots}, 1109, 1109, 1109], dtype=int64), array([ 687,  688,  689, {\ldots}, 2376, 2377, 2378], dtype=int64))

    \end{Verbatim}

    This means that when we place this sunglasses image on top of another
image, we can use the transparency channel as a filter to tell us which
pixels to overlay on a new image (only the non-transparent ones with
values greater than zero).

One last thing: it's helpful to understand which keypoint belongs to the
eyes, mouth, etc. So, in the image below, we also display the index of
each facial keypoint directly on the image so that you can tell which
keypoints are for the eyes, eyebrows, etc.

With this information, you're well on your way to completing this
filtering task! See if you can place the sunglasses automatically on the
individuals in the image loaded in / shown in the next Python cell.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}5}]:} \PY{c+c1}{\PYZsh{} Load in color image for face detection}
        \PY{n}{image} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{imread}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{images/obamas4.jpg}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        
        \PY{c+c1}{\PYZsh{} Convert the image to RGB colorspace}
        \PY{n}{image} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{cvtColor}\PY{p}{(}\PY{n}{image}\PY{p}{,} \PY{n}{cv2}\PY{o}{.}\PY{n}{COLOR\PYZus{}BGR2RGB}\PY{p}{)}
                
        \PY{c+c1}{\PYZsh{} Plot the image}
        \PY{n}{fig} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{figsize} \PY{o}{=} \PY{p}{(}\PY{l+m+mi}{8}\PY{p}{,}\PY{l+m+mi}{8}\PY{p}{)}\PY{p}{)}
        \PY{n}{ax1} \PY{o}{=} \PY{n}{fig}\PY{o}{.}\PY{n}{add\PYZus{}subplot}\PY{p}{(}\PY{l+m+mi}{111}\PY{p}{)}
        \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}xticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{)}
        \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}yticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{)}
        \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Original Image}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        \PY{n}{ax1}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{image}\PY{p}{)}
\end{Verbatim}


\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}5}]:} <matplotlib.image.AxesImage at 0x1fef4cd2828>
\end{Verbatim}
            
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_80_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}17}]:} \PY{c+c1}{\PYZsh{}\PYZsh{} (Optional) TODO: Use the face detection code we saw in Section 1 with your trained conv\PYZhy{}net to put}
         \PY{c+c1}{\PYZsh{}\PYZsh{} sunglasses on the individuals in our test image}
         
         \PY{k+kn}{from} \PY{n+nn}{keras}\PY{n+nn}{.}\PY{n+nn}{models} \PY{k}{import} \PY{n}{load\PYZus{}model}
         \PY{n}{model} \PY{o}{=} \PY{n}{load\PYZus{}model}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{my\PYZus{}model.h5}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
             
         \PY{n}{image\PYZus{}with\PYZus{}predicted\PYZus{}keypoints}\PY{p}{,} \PY{n}{faces\PYZus{}keypoints} \PY{o}{=} \PY{n}{find\PYZus{}keypoints}\PY{p}{(}\PY{n}{image}\PY{p}{)}
         
         \PY{n}{image\PYZus{}with\PYZus{}glasses} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{copy}\PY{p}{(}\PY{n}{image}\PY{p}{)}
         
         \PY{k}{for} \PY{n}{face\PYZus{}keypoint} \PY{o+ow}{in} \PY{n}{faces\PYZus{}keypoints}\PY{p}{:}
             \PY{n}{coordinats\PYZus{}x}\PY{p}{,} \PY{n}{coordinats\PYZus{}y} \PY{o}{=} \PY{n}{face\PYZus{}keypoint}
             \PY{n}{height} \PY{o}{=} \PY{p}{(}\PY{p}{(}\PY{n}{coordinats\PYZus{}x}\PY{p}{[}\PY{l+m+mi}{10}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{coordinats\PYZus{}x}\PY{p}{[}\PY{l+m+mi}{9}\PY{p}{]}\PY{p}{)}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2} \PY{o}{+} \PY{p}{(}\PY{n}{coordinats\PYZus{}y}\PY{p}{[}\PY{l+m+mi}{10}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{coordinats\PYZus{}y}\PY{p}{[}\PY{l+m+mi}{9}\PY{p}{]}\PY{p}{)}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5} \PY{o}{*}\PY{l+m+mf}{0.6} \PY{c+c1}{\PYZsh{} Distance bettwen 10 and 9}
             \PY{n}{add\PYZus{}to\PYZus{}side} \PY{o}{=} \PY{n}{height} \PY{o}{/} \PY{l+m+mi}{3}
             \PY{n}{add\PYZus{}to\PYZus{}top} \PY{o}{=} \PY{n}{height} \PY{o}{/} \PY{l+m+mi}{6}
             
             \PY{l+s+sd}{\PYZsq{}\PYZsq{}\PYZsq{} We want the sunglasses to be on the rigth angle,}
         \PY{l+s+sd}{            P1=(x1,y1)}
         \PY{l+s+sd}{                  |\PYZbs{}}
         \PY{l+s+sd}{                A | \PYZbs{} }
         \PY{l+s+sd}{                  |  \PYZbs{}}
         \PY{l+s+sd}{                  |\PYZus{}B\PYZus{}\PYZbs{}}
         \PY{l+s+sd}{            P2(x2,y3)  P3=(?,?)}
         \PY{l+s+sd}{            }
         \PY{l+s+sd}{    The math explained here: }
         \PY{l+s+sd}{    https://math.stackexchange.com/questions/64823/how\PYZhy{}to\PYZhy{}find\PYZhy{}the\PYZhy{}third\PYZhy{}coordinate\PYZhy{}of\PYZhy{}a\PYZhy{}right\PYZhy{}triangle\PYZhy{}given\PYZhy{}2\PYZhy{}coordinates\PYZhy{}and\PYZhy{}len\PYZsq{}\PYZsq{}\PYZsq{}}
             
             \PY{n}{p1} \PY{o}{=} \PY{p}{[}\PY{n}{coordinats\PYZus{}x}\PY{p}{[}\PY{l+m+mi}{7}\PY{p}{]} \PY{o}{+} \PY{n}{add\PYZus{}to\PYZus{}side}\PY{p}{,} \PY{n}{coordinats\PYZus{}y}\PY{p}{[}\PY{l+m+mi}{7}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{add\PYZus{}to\PYZus{}top}\PY{p}{]}
             \PY{n}{p2} \PY{o}{=} \PY{p}{[}\PY{n}{coordinats\PYZus{}x}\PY{p}{[}\PY{l+m+mi}{9}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{add\PYZus{}to\PYZus{}side}\PY{p}{,} \PY{n}{coordinats\PYZus{}y}\PY{p}{[}\PY{l+m+mi}{9}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{add\PYZus{}to\PYZus{}top}\PY{p}{]}
             
             \PY{n}{Ma} \PY{o}{=} \PY{p}{(}\PY{n}{p2}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{p1}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)} \PY{o}{/} \PY{p}{(}\PY{n}{p2}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{p1}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)} \PY{c+c1}{\PYZsh{} slop of A}
             \PY{n}{Mb} \PY{o}{=} \PY{o}{\PYZhy{}}\PY{l+m+mi}{1} \PY{o}{/} \PY{n}{Ma} \PY{c+c1}{\PYZsh{} slop of B}
             \PY{n}{B} \PY{o}{=} \PY{n}{height}
             
             \PY{k}{if} \PY{n}{Ma} \PY{o}{\PYZgt{}} \PY{l+m+mi}{0}\PY{p}{:}
                 \PY{n}{p3} \PY{o}{=} \PY{p}{[}\PY{n}{p1}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{B}\PY{o}{*}\PY{p}{(}\PY{l+m+mi}{1} \PY{o}{/} \PY{p}{(}\PY{p}{(}\PY{l+m+mi}{1} \PY{o}{+} \PY{n}{Mb}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}\PY{p}{)}\PY{p}{)}\PY{p}{,} \PY{n}{p1}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{B}\PY{o}{*}\PY{p}{(}\PY{n}{Mb} \PY{o}{/} \PY{p}{(}\PY{p}{(}\PY{l+m+mi}{1} \PY{o}{+} \PY{n}{Mb}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}\PY{p}{)}\PY{p}{)}\PY{p}{]} \PY{c+c1}{\PYZsh{} **0.5 = sqrt}
             \PY{k}{else}\PY{p}{:}
                 \PY{n}{p3} \PY{o}{=} \PY{p}{[}\PY{n}{p1}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{+} \PY{n}{B}\PY{o}{*}\PY{p}{(}\PY{l+m+mi}{1} \PY{o}{/} \PY{p}{(}\PY{p}{(}\PY{l+m+mi}{1} \PY{o}{+} \PY{n}{Mb}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}\PY{p}{)}\PY{p}{)}\PY{p}{,} \PY{n}{p1}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{+} \PY{n}{B}\PY{o}{*}\PY{p}{(}\PY{n}{Mb} \PY{o}{/} \PY{p}{(}\PY{p}{(}\PY{l+m+mi}{1} \PY{o}{+} \PY{n}{Mb}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}\PY{p}{)}\PY{p}{)}\PY{p}{]} \PY{c+c1}{\PYZsh{} **0.5 = sqrt}
             
             \PY{c+c1}{\PYZsh{} Find the new Ma and Mb in order to find P4}
             \PY{n}{Ma} \PY{o}{=} \PY{p}{(}\PY{n}{p1}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{p2}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)} \PY{o}{/} \PY{p}{(}\PY{n}{p1}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{p2}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)} \PY{c+c1}{\PYZsh{} slop of A}
             \PY{n}{Mb} \PY{o}{=} \PY{o}{\PYZhy{}}\PY{l+m+mi}{1} \PY{o}{/} \PY{n}{Ma} \PY{c+c1}{\PYZsh{} slop of B}
             \PY{k}{if} \PY{n}{Ma} \PY{o}{\PYZgt{}} \PY{l+m+mi}{0}\PY{p}{:}
                 \PY{n}{p4} \PY{o}{=} \PY{p}{[}\PY{n}{p2}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{B}\PY{o}{*}\PY{p}{(}\PY{l+m+mi}{1} \PY{o}{/} \PY{p}{(}\PY{p}{(}\PY{l+m+mi}{1} \PY{o}{+} \PY{n}{Mb}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}\PY{p}{)}\PY{p}{)}\PY{p}{,} \PY{n}{p2}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{B}\PY{o}{*}\PY{p}{(}\PY{n}{Mb} \PY{o}{/} \PY{p}{(}\PY{p}{(}\PY{l+m+mi}{1} \PY{o}{+} \PY{n}{Mb}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}\PY{p}{)}\PY{p}{)}\PY{p}{]} 
             \PY{k}{else}\PY{p}{:}
                 \PY{n}{p4} \PY{o}{=} \PY{p}{[}\PY{n}{p2}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{+} \PY{n}{B}\PY{o}{*}\PY{p}{(}\PY{l+m+mi}{1} \PY{o}{/} \PY{p}{(}\PY{p}{(}\PY{l+m+mi}{1} \PY{o}{+} \PY{n}{Mb}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}\PY{p}{)}\PY{p}{)}\PY{p}{,} \PY{n}{p2}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{+} \PY{n}{B}\PY{o}{*}\PY{p}{(}\PY{n}{Mb} \PY{o}{/} \PY{p}{(}\PY{p}{(}\PY{l+m+mi}{1} \PY{o}{+} \PY{n}{Mb}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}\PY{p}{)}\PY{p}{)}\PY{p}{]} 
                 
             \PY{n}{destination\PYZus{}points} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{p}{[}\PY{n}{p2}\PY{p}{,} \PY{n}{p4}\PY{p}{,} \PY{n}{p3}\PY{p}{,}  \PY{n}{p1}\PY{p}{]}\PY{p}{)}
             
             \PY{n}{source\PYZus{}points} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{p}{[}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,}
                                              \PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,} \PY{n}{sunglasses}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{]}\PY{p}{,}
                                              \PY{p}{[}\PY{n}{sunglasses}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{n}{sunglasses}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{]}\PY{p}{,}
                                              \PY{p}{[}\PY{n}{sunglasses}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{]}\PY{p}{]}\PY{p}{)}
         
             \PY{n}{p\PYZus{}transform} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{getPerspectiveTransform}\PY{p}{(}\PY{n}{source\PYZus{}points}\PY{p}{,} \PY{n}{destination\PYZus{}points}\PY{p}{)}
             \PY{n}{size} \PY{o}{=} \PY{p}{(}\PY{n}{image}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{n}{image}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}
             \PY{n}{warped\PYZus{}glasses\PYZus{}image} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{warpPerspective}\PY{p}{(}\PY{n}{sunglasses}\PY{p}{,} \PY{n}{p\PYZus{}transform}\PY{p}{,} \PY{n}{size}\PY{p}{,} \PY{n}{flags}\PY{o}{=}\PY{n}{cv2}\PY{o}{.}\PY{n}{INTER\PYZus{}LINEAR}\PY{p}{)}
         
             \PY{n}{alpha\PYZus{}channel} \PY{o}{=} \PY{n}{warped\PYZus{}glasses\PYZus{}image}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{l+m+mi}{3}\PY{p}{]}
             \PY{n}{image\PYZus{}with\PYZus{}glasses}\PY{p}{[}\PY{n}{alpha\PYZus{}channel} \PY{o}{!=} \PY{l+m+mi}{0}\PY{p}{]} \PY{o}{=} \PY{n}{alpha\PYZus{}channel}\PY{p}{[}\PY{n}{alpha\PYZus{}channel} \PY{o}{!=} \PY{l+m+mi}{0}\PY{p}{]}
         
         \PY{c+c1}{\PYZsh{} Plot the image}
         \PY{n}{fig} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{figsize} \PY{o}{=} \PY{p}{(}\PY{l+m+mi}{8}\PY{p}{,}\PY{l+m+mi}{8}\PY{p}{)}\PY{p}{)}
         \PY{n}{ax1} \PY{o}{=} \PY{n}{fig}\PY{o}{.}\PY{n}{add\PYZus{}subplot}\PY{p}{(}\PY{l+m+mi}{111}\PY{p}{)}
         \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}xticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{)}
         \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}yticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{)}
         \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Image with glasses}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{ax1}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{image\PYZus{}with\PYZus{}glasses}\PY{p}{)}
\end{Verbatim}


\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}17}]:} <matplotlib.image.AxesImage at 0x1fe80a8bdd8>
\end{Verbatim}
            
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_81_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \subsubsection{(Optional) Further Directions - add a filter using facial
keypoints to your laptop
camera}\label{optional-further-directions---add-a-filter-using-facial-keypoints-to-your-laptop-camera}

Now you can add the sunglasses filter to your laptop camera - as
illustrated in the gif below.

The next Python cell contains the basic laptop video camera function
used in the previous optional video exercises. Combine it with the
functionality you developed for adding sunglasses to someone's face in
the previous optional exercise and you should be good to go!

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}14}]:} \PY{k+kn}{import} \PY{n+nn}{cv2}
         \PY{k+kn}{import} \PY{n+nn}{time} 
         \PY{k+kn}{from} \PY{n+nn}{keras}\PY{n+nn}{.}\PY{n+nn}{models} \PY{k}{import} \PY{n}{load\PYZus{}model}
         \PY{k+kn}{import} \PY{n+nn}{numpy} \PY{k}{as} \PY{n+nn}{np}
         
         \PY{k}{def} \PY{n+nf}{laptop\PYZus{}camera\PYZus{}go}\PY{p}{(}\PY{p}{)}\PY{p}{:}
             \PY{c+c1}{\PYZsh{} Create instance of video capturer}
             \PY{n}{cv2}\PY{o}{.}\PY{n}{namedWindow}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{face detection activated}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
             \PY{n}{vc} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{VideoCapture}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{)}  \PY{c+c1}{\PYZsh{}I have 2 cameras}
         
             \PY{c+c1}{\PYZsh{} try to get the first frame}
             \PY{k}{if} \PY{n}{vc}\PY{o}{.}\PY{n}{isOpened}\PY{p}{(}\PY{p}{)}\PY{p}{:} 
                 \PY{n}{rval}\PY{p}{,} \PY{n}{frame} \PY{o}{=} \PY{n}{vc}\PY{o}{.}\PY{n}{read}\PY{p}{(}\PY{p}{)}
             \PY{k}{else}\PY{p}{:}
                 \PY{n}{rval} \PY{o}{=} \PY{k+kc}{False}
             
             \PY{c+c1}{\PYZsh{} Keep video stream open}
             \PY{k}{while} \PY{n}{rval}\PY{p}{:}
                 
                 \PY{n}{image\PYZus{}with\PYZus{}predicted\PYZus{}keypoints}\PY{p}{,} \PY{n}{faces\PYZus{}keypoints} \PY{o}{=} \PY{n}{find\PYZus{}keypoints}\PY{p}{(}\PY{n}{frame}\PY{p}{)}
         
                 \PY{k}{for} \PY{n}{face\PYZus{}keypoint} \PY{o+ow}{in} \PY{n}{faces\PYZus{}keypoints}\PY{p}{:}
                     \PY{n}{coordinats\PYZus{}x}\PY{p}{,} \PY{n}{coordinats\PYZus{}y} \PY{o}{=} \PY{n}{face\PYZus{}keypoint}
                     
                     \PY{n}{height} \PY{o}{=} \PY{p}{(}\PY{p}{(}\PY{n}{coordinats\PYZus{}x}\PY{p}{[}\PY{l+m+mi}{10}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{coordinats\PYZus{}x}\PY{p}{[}\PY{l+m+mi}{9}\PY{p}{]}\PY{p}{)}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2} \PY{o}{+} \PY{p}{(}\PY{n}{coordinats\PYZus{}y}\PY{p}{[}\PY{l+m+mi}{10}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{coordinats\PYZus{}y}\PY{p}{[}\PY{l+m+mi}{9}\PY{p}{]}\PY{p}{)}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5} \PY{o}{*}\PY{l+m+mf}{0.6} \PY{c+c1}{\PYZsh{} Distance bettwen 10 and 9}
                     \PY{n}{add\PYZus{}to\PYZus{}side} \PY{o}{=} \PY{n}{height} \PY{o}{/} \PY{l+m+mi}{3}
                     \PY{n}{add\PYZus{}to\PYZus{}top} \PY{o}{=} \PY{n}{height} \PY{o}{/} \PY{l+m+mi}{6}
                     \PY{l+s+sd}{\PYZsq{}\PYZsq{}\PYZsq{} We want the sunglasses to be on the rigth angle,}
         \PY{l+s+sd}{                        P1=(x1,y1)}
         \PY{l+s+sd}{                              |\PYZbs{}}
         \PY{l+s+sd}{                            A | \PYZbs{} }
         \PY{l+s+sd}{                              |  \PYZbs{}}
         \PY{l+s+sd}{                              |\PYZus{}B\PYZus{}\PYZbs{}}
         \PY{l+s+sd}{                        P2(x2,y3)  P3=(?,?)}
         
         \PY{l+s+sd}{                The math explained here: }
         \PY{l+s+sd}{                https://math.stackexchange.com/questions/64823/how\PYZhy{}to\PYZhy{}find\PYZhy{}the\PYZhy{}third\PYZhy{}coordinate\PYZhy{}of\PYZhy{}a\PYZhy{}right\PYZhy{}triangle\PYZhy{}given\PYZhy{}2\PYZhy{}coordinates\PYZhy{}and\PYZhy{}len\PYZsq{}\PYZsq{}\PYZsq{}}
           
                     \PY{n}{p1} \PY{o}{=} \PY{p}{[}\PY{n}{coordinats\PYZus{}x}\PY{p}{[}\PY{l+m+mi}{7}\PY{p}{]} \PY{o}{+} \PY{n}{add\PYZus{}to\PYZus{}side}\PY{p}{,} \PY{n}{coordinats\PYZus{}y}\PY{p}{[}\PY{l+m+mi}{7}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{add\PYZus{}to\PYZus{}top}\PY{p}{]}
                     \PY{n}{p2} \PY{o}{=} \PY{p}{[}\PY{n}{coordinats\PYZus{}x}\PY{p}{[}\PY{l+m+mi}{9}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{add\PYZus{}to\PYZus{}side}\PY{p}{,} \PY{n}{coordinats\PYZus{}y}\PY{p}{[}\PY{l+m+mi}{9}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{add\PYZus{}to\PYZus{}top}\PY{p}{]}
         
                     \PY{n}{Ma} \PY{o}{=} \PY{p}{(}\PY{n}{p2}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{p1}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)} \PY{o}{/} \PY{p}{(}\PY{n}{p2}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{p1}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)} \PY{c+c1}{\PYZsh{} slop of A}
                     \PY{n}{Mb} \PY{o}{=} \PY{o}{\PYZhy{}}\PY{l+m+mi}{1} \PY{o}{/} \PY{n}{Ma} \PY{c+c1}{\PYZsh{} slop of B}
                     \PY{n}{B} \PY{o}{=} \PY{n}{height}
         
                     \PY{k}{if} \PY{n}{Ma} \PY{o}{\PYZgt{}} \PY{l+m+mi}{0}\PY{p}{:}
                         \PY{n}{p3} \PY{o}{=} \PY{p}{[}\PY{n}{p1}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{B}\PY{o}{*}\PY{p}{(}\PY{l+m+mi}{1} \PY{o}{/} \PY{p}{(}\PY{p}{(}\PY{l+m+mi}{1} \PY{o}{+} \PY{n}{Mb}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}\PY{p}{)}\PY{p}{)}\PY{p}{,} \PY{n}{p1}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{B}\PY{o}{*}\PY{p}{(}\PY{n}{Mb} \PY{o}{/} \PY{p}{(}\PY{p}{(}\PY{l+m+mi}{1} \PY{o}{+} \PY{n}{Mb}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}\PY{p}{)}\PY{p}{)}\PY{p}{]} \PY{c+c1}{\PYZsh{} **0.5 = sqrt}
                     \PY{k}{else}\PY{p}{:}
                         \PY{n}{p3} \PY{o}{=} \PY{p}{[}\PY{n}{p1}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{+} \PY{n}{B}\PY{o}{*}\PY{p}{(}\PY{l+m+mi}{1} \PY{o}{/} \PY{p}{(}\PY{p}{(}\PY{l+m+mi}{1} \PY{o}{+} \PY{n}{Mb}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}\PY{p}{)}\PY{p}{)}\PY{p}{,} \PY{n}{p1}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{+} \PY{n}{B}\PY{o}{*}\PY{p}{(}\PY{n}{Mb} \PY{o}{/} \PY{p}{(}\PY{p}{(}\PY{l+m+mi}{1} \PY{o}{+} \PY{n}{Mb}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}\PY{p}{)}\PY{p}{)}\PY{p}{]} \PY{c+c1}{\PYZsh{} **0.5 = sqrt}
         
                     \PY{c+c1}{\PYZsh{} Find the new Ma and Mb in order to find P4}
                     \PY{n}{Ma} \PY{o}{=} \PY{p}{(}\PY{n}{p1}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{p2}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)} \PY{o}{/} \PY{p}{(}\PY{n}{p1}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{p2}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)} \PY{c+c1}{\PYZsh{} slop of A}
                     \PY{n}{Mb} \PY{o}{=} \PY{o}{\PYZhy{}}\PY{l+m+mi}{1} \PY{o}{/} \PY{n}{Ma} \PY{c+c1}{\PYZsh{} slop of B}
                     \PY{k}{if} \PY{n}{Ma} \PY{o}{\PYZgt{}} \PY{l+m+mi}{0}\PY{p}{:}
                         \PY{n}{p4} \PY{o}{=} \PY{p}{[}\PY{n}{p2}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{B}\PY{o}{*}\PY{p}{(}\PY{l+m+mi}{1} \PY{o}{/} \PY{p}{(}\PY{p}{(}\PY{l+m+mi}{1} \PY{o}{+} \PY{n}{Mb}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}\PY{p}{)}\PY{p}{)}\PY{p}{,} \PY{n}{p2}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{B}\PY{o}{*}\PY{p}{(}\PY{n}{Mb} \PY{o}{/} \PY{p}{(}\PY{p}{(}\PY{l+m+mi}{1} \PY{o}{+} \PY{n}{Mb}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}\PY{p}{)}\PY{p}{)}\PY{p}{]} 
                     \PY{k}{else}\PY{p}{:}
                         \PY{n}{p4} \PY{o}{=} \PY{p}{[}\PY{n}{p2}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{+} \PY{n}{B}\PY{o}{*}\PY{p}{(}\PY{l+m+mi}{1} \PY{o}{/} \PY{p}{(}\PY{p}{(}\PY{l+m+mi}{1} \PY{o}{+} \PY{n}{Mb}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}\PY{p}{)}\PY{p}{)}\PY{p}{,} \PY{n}{p2}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{+} \PY{n}{B}\PY{o}{*}\PY{p}{(}\PY{n}{Mb} \PY{o}{/} \PY{p}{(}\PY{p}{(}\PY{l+m+mi}{1} \PY{o}{+} \PY{n}{Mb}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}\PY{p}{)}\PY{p}{)}\PY{p}{]} 
         
                     \PY{n}{destination\PYZus{}points} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{p}{[}\PY{n}{p2}\PY{p}{,} \PY{n}{p4}\PY{p}{,} \PY{n}{p3}\PY{p}{,}  \PY{n}{p1}\PY{p}{]}\PY{p}{)}
                     
                     \PY{n}{source\PYZus{}points} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{p}{[}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,}
                                              \PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,} \PY{n}{sunglasses}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{]}\PY{p}{,}
                                              \PY{p}{[}\PY{n}{sunglasses}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{n}{sunglasses}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{]}\PY{p}{,}
                                              \PY{p}{[}\PY{n}{sunglasses}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{]}\PY{p}{]}\PY{p}{)}
         
                     \PY{n}{p\PYZus{}transform} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{getPerspectiveTransform}\PY{p}{(}\PY{n}{source\PYZus{}points}\PY{p}{,} \PY{n}{destination\PYZus{}points}\PY{p}{)}
                     \PY{n}{size} \PY{o}{=} \PY{p}{(}\PY{n}{frame}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{n}{frame}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}
                     \PY{n}{warped\PYZus{}glasses\PYZus{}image} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{warpPerspective}\PY{p}{(}\PY{n}{sunglasses}\PY{p}{,} \PY{n}{p\PYZus{}transform}\PY{p}{,} \PY{n}{size}\PY{p}{,} \PY{n}{flags}\PY{o}{=}\PY{n}{cv2}\PY{o}{.}\PY{n}{INTER\PYZus{}LINEAR}\PY{p}{)}
         
                     \PY{n}{alpha\PYZus{}channel} \PY{o}{=} \PY{n}{warped\PYZus{}glasses\PYZus{}image}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{l+m+mi}{3}\PY{p}{]}
                     \PY{n}{frame}\PY{p}{[}\PY{n}{alpha\PYZus{}channel} \PY{o}{!=} \PY{l+m+mi}{0}\PY{p}{]} \PY{o}{=} \PY{n}{alpha\PYZus{}channel}\PY{p}{[}\PY{n}{alpha\PYZus{}channel} \PY{o}{!=} \PY{l+m+mi}{0}\PY{p}{]}
                     
                     \PY{l+s+sd}{\PYZsq{}\PYZsq{}\PYZsq{} \PYZsh{}for testing}
         \PY{l+s+sd}{            cv2.circle(frame, (int(p1[0]), int(p1[1])), 1, (0, 255, 255), 3)}
         \PY{l+s+sd}{            cv2.circle(frame, (int(p2[0]), int(p2[1])), 1, (0, 0, 255), 3)}
         \PY{l+s+sd}{            cv2.circle(frame, (int(p3[0]), int(p3[1])), 1, (0, 255, 0), 3)}
         \PY{l+s+sd}{            cv2.circle(frame, (int(p4[0]), int(p4[1])), 1, (255, 0, 0), 3)\PYZsq{}\PYZsq{}\PYZsq{}}
             
                 \PY{c+c1}{\PYZsh{} Plot image from camera with detections marked}
                 \PY{n}{cv2}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{face detection activated}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{n}{frame}\PY{p}{)}
                 
                 \PY{c+c1}{\PYZsh{} Exit functionality \PYZhy{} press any key to exit laptop video}
                 \PY{n}{key} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{waitKey}\PY{p}{(}\PY{l+m+mi}{20}\PY{p}{)}
                 \PY{k}{if} \PY{n}{key} \PY{o}{\PYZgt{}} \PY{l+m+mi}{0}\PY{p}{:} \PY{c+c1}{\PYZsh{} exit by pressing any key}
                     \PY{c+c1}{\PYZsh{} Destroy windows }
                     \PY{n}{cv2}\PY{o}{.}\PY{n}{destroyAllWindows}\PY{p}{(}\PY{p}{)}
                     
                     \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range} \PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,}\PY{l+m+mi}{5}\PY{p}{)}\PY{p}{:}
                         \PY{n}{cv2}\PY{o}{.}\PY{n}{waitKey}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{)}
                     \PY{k}{return}
                 
                 \PY{c+c1}{\PYZsh{} Read next frame}
                 \PY{n}{time}\PY{o}{.}\PY{n}{sleep}\PY{p}{(}\PY{l+m+mf}{0.05}\PY{p}{)}             \PY{c+c1}{\PYZsh{} control framerate for computation \PYZhy{} default 20 frames per sec}
                 \PY{n}{rval}\PY{p}{,} \PY{n}{frame} \PY{o}{=} \PY{n}{vc}\PY{o}{.}\PY{n}{read}\PY{p}{(}\PY{p}{)}    
                 
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}15}]:} \PY{c+c1}{\PYZsh{} Load facial landmark detector model}
         \PY{n}{model} \PY{o}{=} \PY{n}{load\PYZus{}model}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{my\PYZus{}model.h5}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} Run sunglasses painter}
         \PY{n}{laptop\PYZus{}camera\PYZus{}go}\PY{p}{(}\PY{p}{)}
\end{Verbatim}



    % Add a bibliography block to the postdoc
    
    
    
    \end{document}
